<!DOCTYPE html>
<html lang="th" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Samut Prakan Wellness Route: The Serenity Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600&family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        bali: {
                            base: '#F9F7F2',      // Cream white
                            green: '#2C5F2D',     // Deep forest green
                            lightGreen: '#97BC62',// Soft bamboo green
                            gold: '#D4AF37',      // Luxury gold
                            wood: '#8B5A2B',      // Teak wood
                            text: '#1F2937'
                        }
                    },
                    fontFamily: {
                        sans: ['Sarabun', 'sans-serif'],
                        serif: ['Playfair Display', 'serif'],
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #F9F7F2; color: #1F2937; }
        .hero-section {
            background: linear-gradient(to bottom, rgba(44, 95, 45, 0.4), rgba(44, 95, 45, 0.2)), 
                        url('https://images.unsplash.com/photo-1540555700478-4be289fbecef?q=80&w=2000&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 2rem;
        }
        .section-title::after {
            content: '';
            display: block;
            width: 60px;
            height: 3px;
            background-color: #D4AF37;
            margin: 10px auto 0;
            border-radius: 2px;
        }
        .card-bali {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
            transition: all 0.3s ease;
        }
        .card-bali:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border-color: #97BC62;
        }
        .btn-bali {
            background-color: #2C5F2D;
            color: white;
            transition: all 0.3s;
        }
        .btn-bali:hover {
            background-color: #1a3c1b;
            transform: scale(1.05);
        }
        .map-container {
            height: 100%; min-height: 500px; border-radius: 1rem; overflow: hidden;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #97BC62; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #2C5F2D; }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            z-index: 10;
        }
    </style>
</head>
<body class="antialiased">

    <!-- Navigation -->
    <nav class="bg-white/90 backdrop-blur-md shadow-sm sticky top-0 z-50 border-b border-bali-lightGreen/30">
        <div class="container mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-3 cursor-pointer group" onclick="window.scrollTo(0,0)">
                <i class="fas fa-leaf text-bali-green text-2xl group-hover:rotate-12 transition"></i>
                <div>
                    <span class="text-xl font-serif font-bold text-bali-green block leading-none">SPK Wellness</span>
                    <span class="text-xs text-bali-gold uppercase tracking-widest">Sanctuary Route</span>
                </div>
            </div>
            <div class="hidden md:flex space-x-8 text-sm font-medium text-gray-600">
                <a href="#signature" class="hover:text-bali-green transition">เส้นทางแนะนำ</a>
                <a href="#ranking" class="hover:text-bali-green transition">จัดอันดับคุณภาพ</a>
                <a href="#planner" class="hover:text-bali-green transition">วางแผนเดินทาง</a>
                <a href="#database" class="hover:text-bali-green transition">ฐานข้อมูลร้าน</a>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <header class="hero-section h-[650px] flex items-center justify-center text-center px-4 relative">
        <div class="max-w-4xl relative z-10 p-8 rounded-2xl bg-black/20 backdrop-blur-sm border border-white/10">
            <span class="inline-block py-1 px-4 rounded-full bg-bali-gold/90 text-white text-xs font-bold mb-6 uppercase tracking-widest shadow-lg">The Unseen Samut Prakan</span>
            <h1 class="text-5xl md:text-7xl font-serif font-bold mb-6 text-white drop-shadow-xl leading-tight">
                From Sky to <span class="text-bali-lightGreen">Green Lung</span>
            </h1>
            <p class="text-lg md:text-xl mb-10 text-gray-100 font-light max-w-2xl mx-auto">
                สัมผัสสุนทรียภาพแห่งการพักผ่อน พลิกฟื้นกายใจด้วยธรรมชาติบำบัด<br>
                จากสนามบินสุวรรณภูมิ สู่โอโซนบริสุทธิ์แห่งคุ้งบางกระเจ้า
            </p>
            <div class="flex flex-col sm:flex-row justify-center gap-4">
                <a href="#signature" class="bg-bali-green hover:bg-bali-green/90 text-white px-8 py-3 rounded-full font-medium transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-route"></i> ดูเส้นทางแนะนำ
                </a>
                <a href="#planner" class="bg-white/90 hover:bg-white text-bali-green px-8 py-3 rounded-full font-medium transition shadow-lg flex items-center justify-center gap-2">
                    <i class="fas fa-pen-fancy"></i> ออกแบบทริปเอง
                </a>
            </div>
        </div>
    </header>

    <!-- 1. Signature Route (The Highlight) -->
    <section id="signature" class="py-20 bg-white relative overflow-hidden">
        <div class="absolute top-0 right-0 opacity-5 pointer-events-none">
            <i class="fas fa-leaf text-9xl text-bali-green transform rotate-45 translate-x-10 -translate-y-10"></i>
        </div>
        <div class="container mx-auto px-4">
            <div class="text-center">
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-bali-green section-title">The Ultimate Wellness Journey</h2>
                <p class="text-gray-500 max-w-2xl mx-auto mb-16">เส้นทางซิกเนเจอร์ที่คัดสรรมาเพื่อที่สุดแห่งการผ่อนคลาย เชื่อมโยงความหรูหราของสปาระดับโลกเข้ากับวิถีธรรมชาติ</p>
            </div>

            <div class="relative max-w-6xl mx-auto">
                <!-- Timeline Line -->
                <div class="hidden lg:block absolute top-1/2 left-0 w-full h-1 bg-bali-green/20 -translate-y-1/2 z-0 rounded-full"></div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 relative z-10">
                    <!-- Step 1 -->
                    <div class="group cursor-pointer" onclick="triggerMapUpdate('pran_spa', 'Pran Spa (Divalux Resort)', 'Divalux Resort and Spa Suvarnabhumi')">
                        <div class="relative bg-white p-2 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:-translate-y-2 border border-gray-100">
                            <div class="h-56 rounded-xl overflow-hidden relative">
                                <img src="https://images.unsplash.com/photo-1600334089648-b0d9d3028eb2?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                                <div class="absolute top-3 left-3 bg-bali-gold text-white text-xs font-bold px-3 py-1 rounded-full shadow">START</div>
                            </div>
                            <div class="p-6 text-center">
                                <div class="w-12 h-12 bg-bali-green text-white rounded-full flex items-center justify-center text-xl mx-auto -mt-12 mb-4 border-4 border-white shadow-lg relative z-20">1</div>
                                <h3 class="text-xl font-serif font-bold text-bali-green">Pran Spa</h3>
                                <p class="text-sm text-gray-400 mb-2 uppercase tracking-wide">Suvarnabhumi Airport</p>
                                <p class="text-gray-600 text-sm line-clamp-2">ฟื้นฟูร่างกายทันทีที่ลงเครื่อง ด้วยสปาหรูระดับพรีเมียม</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2 -->
                    <div class="group cursor-pointer" onclick="triggerMapUpdate('ohkajhu', 'Organic Dining', 'Ohkajhu Dadfa Lasalle')">
                        <div class="relative bg-white p-2 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:-translate-y-2 border border-gray-100">
                            <div class="h-56 rounded-xl overflow-hidden relative">
                                <img src="https://images.unsplash.com/photo-1490645935967-10de6ba17061?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                            </div>
                            <div class="p-6 text-center">
                                <div class="w-12 h-12 bg-white text-bali-green border-2 border-bali-green rounded-full flex items-center justify-center text-xl mx-auto -mt-12 mb-4 shadow-lg relative z-20">2</div>
                                <h3 class="text-xl font-serif font-bold text-bali-green">Organic Dining</h3>
                                <p class="text-sm text-gray-400 mb-2 uppercase tracking-wide">Wellness Food</p>
                                <p class="text-gray-600 text-sm line-clamp-2">ทานอาหารเพื่อสุขภาพ ผักสดออร์แกนิก ปรุงรสด้วยใจ</p>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3 -->
                    <div class="group cursor-pointer" onclick="triggerMapUpdate('tree_house', 'Bangkok Tree House', 'Bangkok Tree House')">
                        <div class="relative bg-white p-2 rounded-2xl shadow-xl hover:shadow-2xl transition transform hover:-translate-y-2 border border-gray-100">
                            <div class="h-56 rounded-xl overflow-hidden relative">
                                <img src="https://images.unsplash.com/photo-1502672260266-1c1ef2d93688?q=80&w=1000&auto=format&fit=crop" class="w-full h-full object-cover group-hover:scale-110 transition duration-700">
                                <div class="absolute top-3 right-3 bg-bali-green text-white text-xs font-bold px-3 py-1 rounded-full shadow">DESTINATION</div>
                            </div>
                            <div class="p-6 text-center">
                                <div class="w-12 h-12 bg-bali-green text-white rounded-full flex items-center justify-center text-xl mx-auto -mt-12 mb-4 border-4 border-white shadow-lg relative z-20">3</div>
                                <h3 class="text-xl font-serif font-bold text-bali-green">Bang Krachao</h3>
                                <p class="text-sm text-gray-400 mb-2 uppercase tracking-wide">The Green Lung</p>
                                <p class="text-gray-600 text-sm line-clamp-2">สูดโอโซนบริสุทธิ์กลางป่าชายเลน และที่พัก Eco-Luxury</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 2. Ranking & Scoring System -->
    <section id="ranking" class="py-20 bg-bali-base border-t border-b border-gray-200">
        <div class="container mx-auto px-4">
            <div class="text-center mb-16">
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-bali-green section-title">Quality & Standard Ranking</h2>
                <p class="text-gray-500 max-w-2xl mx-auto">การจัดอันดับและประเมินคุณภาพตามมาตรฐานกระทรวงสาธารณสุข เพื่อความมั่นใจในทุกการใช้บริการ</p>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                <!-- Left: Top 5 Ranking List -->
                <div class="lg:col-span-7 space-y-6">
                    <h3 class="text-xl font-bold text-gray-700 mb-6 flex items-center">
                        <i class="fas fa-trophy text-bali-gold mr-3 text-2xl"></i> 5 อันดับสถานประกอบการยอดเยี่ยม
                    </h3>
                    
                    <!-- Rank Items -->
                    <div id="top5List">
                        <!-- JS Will Populate This -->
                    </div>
                </div>

                <!-- Right: Detailed Scoring & Analysis -->
                <div class="lg:col-span-5">
                    <div class="bg-white p-8 rounded-2xl shadow-xl sticky top-24 border border-gray-100">
                        <h3 class="text-lg font-bold text-bali-green mb-6 border-b pb-2">
                            <i class="fas fa-chart-pie mr-2"></i> วิเคราะห์คะแนนรายแห่ง
                        </h3>
                        
                        <!-- Dropdown for Selection -->
                        <div class="mb-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">เลือกสถานประกอบการเพื่อดูคะแนน</label>
                            <select id="scoreSelect" onchange="updateScoreChart()" class="block w-full pl-4 pr-10 py-3 text-base border-gray-300 focus:outline-none focus:ring-bali-green focus:border-bali-green sm:text-sm rounded-lg bg-gray-50">
                                <!-- Options populated by JS -->
                            </select>
                        </div>

                        <!-- Score Display Area -->
                        <div id="scoreDisplay" class="space-y-6">
                            <div class="text-center">
                                <div class="inline-block p-4 rounded-full border-4 border-bali-gold mb-2">
                                    <span id="totalScore" class="text-4xl font-bold text-bali-green">--</span>
                                    <span class="text-sm text-gray-400">/100</span>
                                </div>
                                <h4 id="selectedName" class="text-xl font-serif font-bold text-gray-800">กรุณาเลือกสถานที่</h4>
                                <p id="selectedType" class="text-sm text-gray-500">-</p>
                            </div>

                            <!-- Chart Canvas -->
                            <div class="h-64">
                                <canvas id="scoreChart"></canvas>
                            </div>

                            <!-- Criteria Legend -->
                            <div class="grid grid-cols-2 gap-4 text-xs text-gray-500">
                                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-green-500 mr-2"></span>ความปลอดภัย (30%)</div>
                                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-blue-500 mr-2"></span>ความสะอาด (30%)</div>
                                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-yellow-500 mr-2"></span>การบริการ (20%)</div>
                                <div class="flex items-center"><span class="w-3 h-3 rounded-full bg-purple-500 mr-2"></span>สถานที่ (20%)</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 3. Trip Planner (Action) - Updated with Custom Trip -->
    <section id="planner" class="py-20 bg-white">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-bali-green section-title">Design Your Journey</h2>
                <p class="text-gray-500">เลือกรูปแบบการเดินทางที่คุณต้องการ หรือออกแบบทริปของคุณเอง</p>
            </div>

            <!-- Controls -->
            <div class="flex justify-center flex-wrap gap-4 mb-10">
                <button onclick="selectTripType('oneday')" id="btn-oneday" class="btn-bali px-8 py-3 rounded-full shadow-md font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">
                    <i class="fas fa-sun mr-2"></i> One Day Trip
                </button>
                <button onclick="selectTripType('twoday')" id="btn-twoday" class="btn-bali px-8 py-3 rounded-full shadow-md font-medium bg-gray-100 text-gray-600 hover:bg-gray-200">
                    <i class="fas fa-moon mr-2"></i> Two Day Trip
                </button>
                <button onclick="selectTripType('custom')" id="btn-custom" class="btn-bali px-8 py-3 rounded-full shadow-md font-medium bg-gray-100 text-gray-600 hover:bg-gray-200 border border-bali-gold/50">
                    <i class="fas fa-pen-fancy mr-2"></i> Custom Trip
                </button>
            </div>

            <!-- Planner Content -->
            <div id="contentArea" class="grid grid-cols-1 lg:grid-cols-12 gap-8">
                <!-- Left: Itinerary -->
                <div class="lg:col-span-7 bg-bali-base rounded-2xl p-6 shadow-inner min-h-[400px]">
                    <div id="welcomeMsg" class="h-full flex flex-col items-center justify-center text-gray-400 py-10">
                        <i class="fas fa-map-signs text-6xl mb-4 text-bali-lightGreen opacity-50"></i>
                        <p class="text-lg">เลือกประเภททริปเพื่อเริ่มวางแผน</p>
                    </div>
                    
                    <div id="onedayContent" class="hidden space-y-6">
                        <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
                            <div class="bg-bali-green text-white w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-lg"><i class="fas fa-sun"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">One Day Trip</h3>
                                <p class="text-sm text-gray-500">Rejuvenate & Refresh (09:00 - 18:00)</p>
                            </div>
                        </div>
                        <!-- Timeline Items (Injected by JS) -->
                        <div id="onedayList" class="space-y-4 relative border-l-2 border-bali-lightGreen ml-4 pl-8"></div>
                    </div>

                    <div id="twodayContent" class="hidden space-y-6">
                        <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
                            <div class="bg-bali-gold text-white w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-lg"><i class="fas fa-moon"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Two Day Trip</h3>
                                <p class="text-sm text-gray-500">Deep Relaxation & Eco-Life</p>
                            </div>
                        </div>
                        <!-- Timeline Items (Injected by JS) -->
                        <div id="twodayList" class="space-y-4"></div>
                    </div>

                    <!-- NEW: Custom Trip Builder -->
                    <div id="customContent" class="hidden space-y-6">
                        <div class="flex items-center gap-4 mb-6 pb-4 border-b border-gray-200">
                            <div class="bg-blue-500 text-white w-12 h-12 rounded-full flex items-center justify-center text-xl shadow-lg"><i class="fas fa-edit"></i></div>
                            <div>
                                <h3 class="text-xl font-bold text-gray-800">Custom Trip</h3>
                                <p class="text-sm text-gray-500">เลือกสถานที่อย่างน้อย 3 แห่งตามใจคุณ</p>
                            </div>
                        </div>
                        
                        <div id="customSlots" class="space-y-4">
                            <!-- Slots will be injected here -->
                        </div>
                        
                        <div class="flex justify-between mt-6 pt-4 border-t border-gray-200">
                            <button onclick="addCustomSlot()" class="text-bali-green hover:text-bali-green/80 font-medium text-sm flex items-center"><i class="fas fa-plus-circle mr-1"></i> เพิ่มสถานที่</button>
                            <button onclick="saveCustomTrip()" class="bg-bali-green text-white px-6 py-2 rounded-full hover:bg-bali-green/90 transition text-sm font-bold shadow-md"><i class="fas fa-save mr-1"></i> บันทึกลงแผน</button>
                        </div>
                    </div>
                </div>

                <!-- Right: Map -->
                <div class="lg:col-span-5">
                    <div class="sticky top-24">
                        <div class="map-container bg-gray-200 relative border-4 border-white shadow-2xl">
                            <iframe id="googleMap" width="100%" height="100%" style="border:0;" allowfullscreen="" loading="lazy" src="https://maps.google.com/maps?q=13.607616,100.6020447&z=11&ie=UTF8&iwloc=&output=embed"></iframe>
                        </div>
                        <button onclick="openRouteMap()" class="w-full mt-4 bg-white border border-bali-green text-bali-green py-3 rounded-xl font-bold hover:bg-bali-green hover:text-white transition shadow-md">
                            <i class="fas fa-map-marked-alt mr-2"></i> เปิดแผนที่นำทาง (Google Maps)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- 4. Database & Verification (UPDATED with full data) -->
    <section id="database" class="py-20 bg-bali-base">
        <div class="container mx-auto px-4">
            <div class="text-center mb-12">
                <h2 class="text-3xl md:text-4xl font-serif font-bold text-bali-green section-title">Certified Wellness Database</h2>
                <p class="text-gray-500">ค้นหาและตรวจสอบข้อมูลสถานประกอบการที่ได้รับอนุญาต</p>
            </div>

            <!-- Search & Filter -->
            <div class="max-w-4xl mx-auto bg-white p-6 rounded-2xl shadow-lg mb-10 flex flex-col md:flex-row gap-4 items-center">
                <div class="flex-1 w-full relative">
                    <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <input type="text" id="searchInput" onkeyup="renderListings()" placeholder="ค้นหาชื่อร้าน หรือ เลขที่ใบอนุญาต..." class="w-full pl-12 pr-4 py-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-bali-green">
                </div>
                <div class="w-full md:w-1/3 relative">
                    <i class="fas fa-map-marker-alt absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    <select id="districtFilter" onchange="renderListings()" class="w-full pl-10 pr-8 py-3 bg-gray-50 border-none rounded-xl focus:ring-2 focus:ring-bali-green appearance-none cursor-pointer">
                        <option value="all">ทุกอำเภอ</option>
                        <option value="บางเสาธง">บางเสาธง</option>
                        <option value="บางพลี">บางพลี</option>
                        <option value="เมือง">เมือง</option>
                        <option value="พระประแดง">พระประแดง</option>
                        <option value="พระสมุทรเจดีย์">พระสมุทรเจดีย์</option>
                        <option value="บางบ่อ">บางบ่อ</option>
                    </select>
                    <i class="fas fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-gray-400 pointer-events-none"></i>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white rounded-2xl shadow-xl overflow-hidden">
                <div class="overflow-x-auto table-container">
                    <table class="w-full text-left">
                        <thead class="bg-bali-green text-white">
                            <tr>
                                <th class="p-4 font-serif font-semibold">ชื่อสถานประกอบการ</th>
                                <th class="p-4 font-serif font-semibold">ประเภท</th>
                                <th class="p-4 font-serif font-semibold">อำเภอ</th>
                                <th class="p-4 font-serif font-semibold">ใบอนุญาต</th>
                                <th class="p-4 text-center font-serif font-semibold">ตรวจสอบ</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody" class="divide-y divide-gray-100">
                            <!-- JS Populated -->
                        </tbody>
                    </table>
                </div>
                <div id="noResults" class="hidden p-10 text-center text-gray-400">
                    <i class="far fa-folder-open text-4xl mb-3"></i>
                    <p>ไม่พบข้อมูลที่ค้นหา</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Floating Planner Bar -->
    <div id="plannerBar" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-5px_30px_rgba(0,0,0,0.1)] transform translate-y-full transition-transform duration-300 z-50 rounded-t-2xl border-t border-bali-gold/30">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center mb-4">
                <div class="flex items-center gap-3">
                    <div class="bg-bali-green text-white w-10 h-10 rounded-full flex items-center justify-center shadow-md"><i class="fas fa-suitcase"></i></div>
                    <div>
                        <h4 class="font-bold text-gray-800">My Wellness Trip</h4>
                        <p class="text-xs text-gray-500" id="itemCount">0 สถานที่</p>
                    </div>
                </div>
                <button onclick="togglePlanner()" class="text-gray-400 hover:text-bali-green transition"><i class="fas fa-chevron-down"></i></button>
            </div>
            <div id="selectedList" class="flex overflow-x-auto gap-4 pb-4 scrollbar-hide">
                <p class="text-sm text-gray-400 italic w-full text-center py-2" id="emptyPlaceholder">เลือกสถานที่จากรายการเพื่อเริ่มวางแผน</p>
            </div>
            <div class="flex justify-end gap-3 pt-3 border-t border-gray-100">
                <button onclick="clearPlan()" class="text-red-500 text-sm hover:underline px-4">ล้างรายการ</button>
                <button onclick="confirmPlan()" class="bg-bali-green text-white px-6 py-2 rounded-full font-bold hover:bg-green-800 transition shadow-lg">ยืนยันเส้นทาง</button>
            </div>
        </div>
    </div>

    <!-- Toggle Button -->
    <button id="plannerToggleBtn" onclick="togglePlanner()" class="fixed bottom-8 right-8 bg-bali-gold text-white p-4 rounded-full shadow-2xl hover:bg-yellow-600 transition z-40 hidden hover:scale-110 transform duration-200 border-4 border-white">
        <i class="fas fa-suitcase text-xl"></i>
        <span class="absolute -top-1 -right-1 bg-red-500 text-white text-xs w-6 h-6 rounded-full flex items-center justify-center border-2 border-white font-bold" id="badgeCount">0</span>
    </button>

    <!-- Itinerary Modal -->
    <div id="itineraryModal" class="fixed inset-0 bg-black/60 z-[60] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="bg-bali-green p-6 rounded-t-2xl flex justify-between items-center text-white">
                <h3 class="text-2xl font-serif font-bold">Your Wellness Journey</h3>
                <button onclick="closeModal()" class="hover:text-bali-gold transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            <div id="captureArea" class="p-8 bg-bali-base">
                <div class="relative pl-8 border-l-2 border-dashed border-gray-300 space-y-6" id="modalList"></div>
            </div>
            <div class="p-6 bg-white border-t border-gray-100 flex justify-end gap-4">
                <button onclick="saveItineraryImage()" class="bg-bali-green text-white px-6 py-3 rounded-xl font-bold shadow hover:bg-green-800 transition"><i class="fas fa-download mr-2"></i> บันทึกรูปภาพ</button>
            </div>
        </div>
    </div>

    <!-- Detail Modal -->
    <div id="detailsModal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-lg overflow-hidden shadow-2xl transform transition-all scale-100">
            <div class="h-48 bg-gray-200 relative">
                <iframe id="modalMapFrame" class="w-full h-full object-cover pointer-events-none" src=""></iframe>
                <button onclick="closeDetailsModal()" class="absolute top-4 right-4 bg-white text-gray-800 w-8 h-8 rounded-full flex items-center justify-center shadow hover:bg-gray-100"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-6">
                <span class="bg-bali-lightGreen/20 text-bali-green text-xs font-bold px-2 py-1 rounded mb-2 inline-block" id="modalType">TYPE</span>
                <h2 class="text-2xl font-serif font-bold text-gray-800 mb-4" id="modalName">Shop Name</h2>
                <div class="space-y-3 text-sm text-gray-600">
                    <p><i class="fas fa-certificate w-6 text-bali-gold"></i> <span id="modalLicense">-</span></p>
                    <p><i class="fas fa-map-marker-alt w-6 text-bali-gold"></i> <span id="modalAddress">-</span></p>
                    <p><i class="far fa-calendar-alt w-6 text-bali-gold"></i> หมดอายุ: <span id="modalExpire" class="font-bold text-gray-800">-</span></p>
                </div>
                <div class="mt-6 pt-4 border-t border-gray-100 flex justify-end">
                    <a id="modalMapLink" href="#" target="_blank" class="text-bali-green font-bold hover:underline">ดูใน Google Maps <i class="fas fa-external-link-alt ml-1"></i></a>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- DATA & STATE ---
        // Complete data from user's CSV files
        const allLocations = [
            // --- บางเสาธง (Bang Sao Thong) ---
            { name: "Pran Spa (ปราณณ์สปา)", type: "Spa", district: "บางเสาธง", license: "สส110100001-61", mapQuery: "Divalux Resort and Spa Suvarnabhumi", address: "54 หมู่ 3 ต.ศีรษะจรเข้น้อย", expire: "2567-04-25" },
            { name: "Hatthai Massage (หัตถ์ทัย)", type: "Massage", district: "บางเสาธง", license: "สส110200002-61", mapQuery: "Hatthai Massage Bang Sao Thong", address: "48/1 นัมเบอร์วัน", expire: "-" },
            { name: "Ban Suk Ying (บ้านสุขยิ่ง)", type: "Massage", district: "บางเสาธง", license: "สส110200007-61", mapQuery: "Ban Suk Ying Massage", address: "200/59 โครงการนครบางพลี", expire: "2567-09-16" },
            { name: "Ban Mum Sabai (บ้านมุมสบาย)", type: "Massage", district: "บางเสาธง", license: "สส110200001-62", mapQuery: "City Park Bang Phli", address: "417 ซิตี้พาร์คบางพลี", expire: "2567-01-15" },
            { name: "Luna Salon (ลูน่า ซาลอน)", type: "Massage", district: "บางเสาธง", license: "สส110200010-62", mapQuery: "Bang Sao Thong", address: "87/41 บางเสาธง", expire: "2567-07-06" },
            { name: "Duang Dee (ดวงดี)", type: "Massage", district: "บางเสาธง", license: "สส110200027-62", mapQuery: "ABAC Bangna", address: "95/3 ม.เอแบค", expire: "2567-09-05" },
            { name: "Irin (ไอรินทร์)", type: "Massage", district: "บางเสาธง", license: "สส110200002-63", mapQuery: "Wat Si Wari Noi", address: "46/7 วัดศรีวารีน้อย", expire: "2568-01-16" },
            { name: "Kantheera 2 (กานต์ธีรา 2)", type: "Massage", district: "บางเสาธง", license: "สส110200007-63", mapQuery: "Kantheera Massage", address: "188 ศีรษะจรเข้น้อย", expire: "2568-02-24" },
            { name: "Lee-On (ลี-ออน)", type: "Massage", district: "บางเสาธง", license: "สส110200019-63", mapQuery: "Business Town 4 Bang Sao Thong", address: "382/24 บิชชิเนสทาวน์4", expire: "2568-06-03" },
            { name: "Chom Thara (ชมธารา)", type: "Massage", district: "บางเสาธง", license: "สส110200056-63", mapQuery: "Bangna Garden", address: "79/3 บางนาการ์เด้น", expire: "2568-10-18" },
            { name: "Chuda Duang (ชุดา ดวง)", type: "Massage", district: "บางเสาธง", license: "สส110200060-63", mapQuery: "Wat Hua Khu", address: "13/38 วัดหัวคู่", expire: "2568-11-09" },
            { name: "Sabai Kai (สบายกาย)", type: "Massage", district: "บางเสาธง", license: "สส110200008-65", mapQuery: "Lat Krabang 54", address: "55/5 ลาดกระบัง 54", expire: "2570-02-08" },
            { name: "Dragon (ดราก้อน)", type: "Massage", district: "บางเสาธง", license: "สส110200004-65", mapQuery: "Sisa Chorakhe Yai", address: "98/1 ศีรษะจระเข้ใหญ่", expire: "2570-01-13" },
            { name: "Suthasinee (สุธาสินี)", type: "Massage", district: "บางเสาธง", license: "สส110200023-65", mapQuery: "Bang Sao Thong", address: "201/160 บางเสาธง", expire: "2565-06-14" },
            { name: "Kanokporn (กนกพร)", type: "Massage", district: "บางเสาธง", license: "สส11020045-67", mapQuery: "Bang Sao Thong", address: "98/1 บางเสาธง", expire: "2572-10-23" },

            // --- บางพลี (Bang Phli) ---
            { name: "Explore Spa (เอ็กซ์โพลร์สปา)", type: "Spa", district: "บางพลี", license: "สส110100003-61", mapQuery: "Summit Windmill Golf Club", address: "789 หมู่ 14 บางนา-ตราด", expire: "2566-07-19" },
            { name: "Kingkaew Massage (กิ่งแก้ว)", type: "Massage", district: "บางพลี", license: "สส110200003-61", mapQuery: "King Kaew Road", address: "88/1-2 กิ่งแก้ว", expire: "-" },
            { name: "Ruean Rak (เรือนรักษ์)", type: "Massage", district: "บางพลี", license: "สส110200004-61", mapQuery: "Suvarnabhumi Airport", address: "999 ชั้น B1 ท่าอากาศยานสุวรรณภูมิ", expire: "-" },
            { name: "Suvarnabhumi Spa (สุวรรณภูมิสปา)", type: "Spa", district: "บางพลี", license: "สส110100002-61", mapQuery: "Suvarnabhumi Airport", address: "999 ท่าอากาศยานสุวรรณภูมิ", expire: "-" },
            { name: "Sirin (ศิริญ)", type: "Massage", district: "บางพลี", license: "สส110200006-61", mapQuery: "Wat Luang Pho To", address: "10/10 วัดหลวงพ่อโต", expire: "2567-06-27" },
            { name: "Healthcare Bangna", type: "Spa", district: "บางพลี", license: "สส110100004-61", mapQuery: "Healthcare Bangna", address: "97,98/9 บางนา-ตราด", expire: "2572-08-06" },
            { name: "Leona (เลอน่า)", type: "Massage", district: "บางพลี", license: "สส110200012-61", mapQuery: "Thepharak Road", address: "45/10 เทพารักษ์", expire: "2571-11-08" },
            { name: "Chan Massage (จันทร์มาสสาจ)", type: "Massage", district: "บางพลี", license: "สส110200014-61", mapQuery: "Wat Si Wari Noi", address: "85/68 วัดศรีวารีน้อย", expire: "2571-12-14" },
            { name: "Vanesia (วานีเซีย)", type: "Massage", district: "บางพลี", license: "สส110200008-62", mapQuery: "Bang Kaeo", address: "89/84 บางแก้ว", expire: "2567-02-13" },
            { name: "Ma Spa (มา สปา)", type: "Spa", district: "บางพลี", license: "สส110100002-62", mapQuery: "King Kaew Road", address: "68 กิ่งแก้ว", expire: "2572-01-17" },
            { name: "Homes Massage (โฮมส์)", type: "Massage", district: "บางพลี", license: "สส110200013-62", mapQuery: "Mangkorn-Khandi", address: "46/15 มังกร-ขันดี", expire: "2567-04-22" },
            { name: "Mue Dee Dee (มือดี ดี)", type: "Massage", district: "บางพลี", license: "สส110200015-62", mapQuery: "Bangna-Trad KM.8", address: "39 บางนา-ตราด กม.8", expire: "2567-05-28" },
            { name: "Feel Good (ฟีลกู๊ด)", type: "Massage", district: "บางพลี", license: "สส110200017-62", mapQuery: "Bangna-Trad", address: "42/21-22 บางนา-ตราด", expire: "2572-05-11" },
            { name: "Skin Care 99", type: "Massage", district: "บางพลี", license: "สส110200001-62", mapQuery: "Racha Thewa", address: "999/30 ราชาเทวะ", expire: "2567-07-10" },
            { name: "Dollar Massage (ดอลล่าร์)", type: "Massage", district: "บางพลี", license: "สส110200024-62", mapQuery: "King Kaew Road", address: "999/9 กิ่งแก้ว", expire: "2572-08-04" },
            { name: "Bai Bua (ใบบัว)", type: "Massage", district: "บางพลี", license: "สส110200025-62", mapQuery: "Srinakarin Road", address: "44/3 ศรีนครินทร์", expire: "2567-08-18" },
            { name: "Ruean Thong (เรือนทอง)", type: "Massage", district: "บางพลี", license: "สส110200037-62", mapQuery: "Bang Phli Yai", address: "99/10 รัตนพิศาล", expire: "2567-12-01" },
            { name: "Kangwan Healthy Spa", type: "Spa", district: "บางพลี", license: "สส110100001-63", mapQuery: "Racha Thewa", address: "88/11 ราชาเทวะ", expire: "2568-02-02" },
            { name: "Ban Ruay Suk (บ้านรวยสุข)", type: "Massage", district: "บางพลี", license: "สส110200008-63", mapQuery: "Racha Thewa", address: "59/3 ราชาเทวะ", expire: "2568-02-24" },
            { name: "Yanisa (ญาณิศา)", type: "Massage", district: "บางพลี", license: "สส110200014-63", mapQuery: "Bang Pla", address: "73/2 บางปลา", expire: "2573-05-21" },
            { name: "Tub Tub (ตุ๊บตั๊บ)", type: "Massage", district: "บางพลี", license: "สส110200015-63", mapQuery: "King Kaew Road", address: "999/46 กิ่งแก้ว", expire: "2573-06-01" },
            { name: "Nathaporn (ณฐพร)", type: "Massage", district: "บางพลี", license: "สส110200018-63", mapQuery: "King Kaew Road", address: "140/4 กิ่งแก้ว", expire: "2568-06-03" },
            { name: "Sabai By Sa (สบาย บายสา)", type: "Massage", district: "บางพลี", license: "สส110200022-63", mapQuery: "Bang Kaeo", address: "8/6 บางแก้ว", expire: "2568-06-04" },
            { name: "Ban Thai (บ้านไทย)", type: "Massage", district: "บางพลี", license: "สส110200025-63", mapQuery: "King Kaew Road", address: "333/79-80 กิ่งแก้ว", expire: "2568-06-09" },
            { name: "Ruean Thip (เรือนทิพย์)", type: "Massage", district: "บางพลี", license: "สส110200027-63", mapQuery: "Nam Daeng-Bang Phli", address: "89/5 หนามแดง-บางพลี", expire: "2568-06-14" },
            { name: "Saraswadi (สรัสวดี)", type: "Massage", district: "บางพลี", license: "สส110200053-63", mapQuery: "Bang Phli Yai", address: "4-5 สุขาภิบาล", expire: "2568-10-06" },
            { name: "Veora Spa (วีโอร่า สปา)", type: "Spa", district: "บางพลี", license: "สส110100003-63", mapQuery: "Bangna-Trad", address: "14 บางนา-ตราด", expire: "2563-10-15" },
            { name: "Warali Spa (วราลี สปา)", type: "Spa", district: "บางพลี", license: "สส110100002-63", mapQuery: "Bang Phli-Nam Daeng", address: "111/14,15 บางพลี-หนามแดง", expire: "2573-08-13" },
            { name: "The Green 2 (เดอะกรีน 2)", type: "Massage", district: "บางพลี", license: "สส110200028-64", mapQuery: "Bang Chalong", address: "12/3 บางโฉลง", expire: "2569-08-07" },
            { name: "Good Day Massage", type: "Massage", district: "บางพลี", license: "สส110200029-68", mapQuery: "Bang Phli Yai", address: "115/5 บางพลีใหญ่", expire: "2573-05-19" },
            { name: "Techinee (เตชินี)", type: "Massage", district: "บางพลี", license: "สส110200031-68", mapQuery: "Bang Chalong", address: "55/13 มัณฑนา", expire: "2573-05-19" },
            { name: "Apiwan (อภิวันท์)", type: "Massage", district: "บางพลี", license: "สส110200035-68", mapQuery: "Bang Chalong", address: "55/14 มัณฑนา", expire: "2573-06-05" },
            { name: "Heki (เฮกิ)", type: "Massage", district: "บางพลี", license: "สส110200043-68", mapQuery: "Bang Kaeo", address: "246 บางแก้ว", expire: "2573-06-26" },
            { name: "Theerakan (ธีรกานต์)", type: "Massage", district: "บางพลี", license: "สส110200044-68", mapQuery: "Bang Chalong", address: "103/44 บางโฉลง", expire: "2573-07-20" },

            // --- เมือง (Mueang) ---
            { name: "Sasa Onsen and Spa", type: "Onsen", district: "เมือง", license: "สส110100002-66", mapQuery: "Sasa Onsen and Spa", address: "595 ซอยแบริ่ง 10 สุขุมวิท 107", expire: "2571-09-13" },
            { name: "Elite Wellness and Spa", type: "Wellness", district: "เมือง", license: "สส110100001-65", mapQuery: "Elite Wellness and Spa Samut Prakan", address: "102/6 สุขุมวิท สำโรงเหนือ", expire: "2570-02-21" },
            { name: "Di Anchan (ดิ อัญชัญ)", type: "Massage", district: "เมือง", license: "สส110200005-61", mapQuery: "Phraeksa", address: "998/205-207 แพรกษา", expire: "-" },
            { name: "Khlai Sabai (คลาย - สบาย)", type: "Massage", district: "เมือง", license: "สส110200008-61", mapQuery: "Srinakarin Road", address: "618 ศรีนครินทร์", expire: "2567-09-16" },
            { name: "Leelawadee (ลีลาวดี)", type: "Massage", district: "เมือง", license: "สส110200009-61", mapQuery: "Sukhumvit Road Bang Pu", address: "2502 สุขุมวิท", expire: "-" },
            { name: "Spa Kan (สปาการ)", type: "Massage", district: "เมือง", license: "สส110200010-61", mapQuery: "Srinakarin Road", address: "2/33 ศรีนครินทร์", expire: "2567-09-16" },
            { name: "Treat Massage (ทรีท มาสสาจ)", type: "Massage", district: "เมือง", license: "สส110200013-61", mapQuery: "Bearing Sukhumvit 107", address: "3213/3 สุขุมวิท 107", expire: "2567-09-17" },
            { name: "Mum Sabai (มุมสบาย)", type: "Massage", district: "เมือง", license: "สส110200002-62", mapQuery: "Thepharak", address: "162 เทพารักษ์", expire: "2567-01-15" },
            { name: "Smile (สมายด์)", type: "Massage", district: "เมือง", license: "สส110200005-62", mapQuery: "Bearing 60", address: "1/4 แบริ่ง 60", expire: "2567-01-15" },
            { name: "Chaba (ชบา)", type: "Massage", district: "เมือง", license: "สส110200006-62", mapQuery: "Samrong Nuea", address: "902 สำโรงเหนือ", expire: "2567-01-15" },
            { name: "U Massage (อุ๊)", type: "Massage", district: "เมือง", license: "สส110200007-62", mapQuery: "Thepharak", address: "80/694 เทพารักษ์", expire: "2567-01-15" },
            { name: "Relax at Jas", type: "Massage", district: "เมือง", license: "สส110200012-62", mapQuery: "Jas Urban Srinakarin", address: "788 ชั้น 2 ศรีนครินทร์", expire: "2567-04-01" },
            { name: "Ruean Mai Hom", type: "Massage", district: "เมือง", license: "สส110200022-62", mapQuery: "Bang Pu Mai", address: "858/11 บางปูใหม่", expire: "2567-07-10" },
            { name: "Sank Thong", type: "Massage", district: "เมือง", license: "สส110200031-62", mapQuery: "Thepharak", address: "161/229 เทพารักษ์", expire: "2567-10-21" },
            { name: "Mali Khao", type: "Massage", district: "เมือง", license: "สส110200032-62", mapQuery: "Samrong Nuea", address: "418/5 สำโรงเหนือ", expire: "2567-11-04" },
            { name: "Paew Waew", type: "Massage", district: "เมือง", license: "สส110200038-62", mapQuery: "Phraeksa", address: "1234/1 แพรกษา", expire: "2567-12-01" },
            { name: "Suphawadee", type: "Massage", district: "เมือง", license: "สส110200003-63", mapQuery: "Thepharak", address: "2104/34-35 เทพารักษ์", expire: "2568-01-23" },
            { name: "Saneh Thai", type: "Massage", district: "เมือง", license: "สส110200005-63", mapQuery: "Bearing", address: "86/7 แบริ่ง", expire: "2568-02-16" },
            { name: "Suang Wa", type: "Massage", district: "เมือง", license: "สส110200010-63", mapQuery: "Phraeksa", address: "98 เทพารักษ์", expire: "2568-03-10" },
            { name: "Noi Massage", type: "Massage", district: "เมือง", license: "สส110200013-63", mapQuery: "Thipphawan", address: "73/18 ทิพวัล", expire: "2568-04-15" },
            { name: "Isakorn", type: "Massage", district: "เมือง", license: "สส110200021-63", mapQuery: "Phraeksa Mai", address: "94 แพรกษาใหม่", expire: "2568-06-04" },
            { name: "Phut Khajee", type: "Massage", district: "เมือง", license: "สส110200023-63", mapQuery: "Pak Nam", address: "49 ปากน้ำ", expire: "2568-06-08" },
            { name: "Ing Anan", type: "Massage", district: "เมือง", license: "สส110200024-63", mapQuery: "Sukhumvit", address: "63/747 สุขุมวิท", expire: "2568-06-09" },
            { name: "Phuean Khun", type: "Massage", district: "เมือง", license: "สส110200026-63", mapQuery: "Pak Nam", address: "500/1 สุขุมวิท", expire: "2568-06-10" },
            { name: "Poy Sian", type: "Massage", district: "เมือง", license: "สส110200028-63", mapQuery: "Pak Nam", address: "18 ปราการ", expire: "2568-06-17" },
            { name: "Marisa", type: "Massage", district: "เมือง", license: "สส110200031-63", mapQuery: "Srinakarin", address: "403 ศรีนครินทร์", expire: "2568-06-29" },
            { name: "Ma Ruay", type: "Massage", district: "เมือง", license: "สส110200033-63", mapQuery: "Samrong Nuea", address: "525/501 สำโรงเหนือ", expire: "2568-07-01" },
            { name: "Sabai Dee", type: "Massage", district: "เมือง", license: "สส110200034-63", mapQuery: "Thai Ban Mai", address: "1886 ท้ายบ้านใหม่", expire: "2568-07-07" },
            { name: "Tang Jai", type: "Massage", district: "เมือง", license: "สส110200038-63", mapQuery: "Samrong Nuea", address: "2900/31 ด่านสำโรง", expire: "2568-07-21" },
            { name: "Bun Phala", type: "Massage", district: "เมือง", license: "สส110200030-68", mapQuery: "Bearing", address: "130/4 แบริ่ง 12", expire: "2573-05-19" },
            { name: "Maggy", type: "Massage", district: "เมือง", license: "สส110300032-68", mapQuery: "Bang Mueang", address: "25/7 บางเมือง", expire: "2573-05-19" },
            { name: "The Green", type: "Massage", district: "เมือง", license: "สส110200034-68", mapQuery: "Phraeksa", address: "998/116 แพรกษา", expire: "2573-05-25" },
            { name: "Noppakao 2", type: "Massage", district: "เมือง", license: "สส110200036-68", mapQuery: "Bang Pu Mai", address: "954/10 บางปูใหม่", expire: "2573-06-05" },
            { name: "So Yoon", type: "Massage", district: "เมือง", license: "สส110200042-68", mapQuery: "Phraeksa", address: "359/29 แพรกษา", expire: "2573-06-26" },
            { name: "Pornkanok", type: "Massage", district: "เมือง", license: "สส110200047-68", mapQuery: "Imperial World Samrong", address: "999 สำโรงเหนือ", expire: "2573-07-28" },
            { name: "Oab Oon", type: "Massage", district: "เมือง", license: "สส110200048-68", mapQuery: "Srinakarin", address: "968/3 สำโรงเหนือ", expire: "2573-08-03" },
            { name: "Ancient City (เมืองโบราณ)", type: "Attraction", district: "เมือง", license: "-", mapQuery: "The Ancient City", address: "สุขุมวิท บางปูใหม่", expire: "-" },
            { name: "Sailom Bang Pu (สายลม บางปู)", type: "Food", district: "เมือง", license: "-", mapQuery: "Sailom Bang Pu", address: "ซอยบางปู 72", expire: "-" },

            // --- พระประแดง (Phra Pradaeng) ---
            { name: "Khun Ya (คุณย่า)", type: "Massage", district: "พระประแดง", license: "สส110200029-62", mapQuery: "Pu Chao Saming Phrai", address: "89/7 ปู่เจ้าสมิงพราย", expire: "2567-09-26" },
            { name: "Kanyanant (กัญญนันทน์)", type: "Massage", district: "พระประแดง", license: "สส110200030-62", mapQuery: "Pu Chao Saming Phrai", address: "88/8 ปู่เจ้าสมิงพราย", expire: "2567-10-21" },
            { name: "Pattha (ปัทถา)", type: "Massage", district: "พระประแดง", license: "สส110200001-62", mapQuery: "Bang Phueng", address: "240/11 บางพึ่ง", expire: "2567-10-24" },
            { name: "Fortune (ฟอร์จูน)", type: "Massage", district: "พระประแดง", license: "สส110200042-63", mapQuery: "Pu Chao Saming Phrai", address: "19/6 บางหญ้าแพรก", expire: "2568-08-02" },
            { name: "Brong Marche (บรองด์มาเช่)", type: "Massage", district: "พระประแดง", license: "สส110200002-64", mapQuery: "Suksawat", address: "94 สุขสวัสดิ์", expire: "2569-02-01" },
            { name: "Oh Massage (โอ๋)", type: "Massage", district: "พระประแดง", license: "สส110200013-64", mapQuery: "Phethueng", address: "52/8 เพชรหึงษ์", expire: "2569-03-24" },
            { name: "Gayana Spa (กายาน่า)", type: "Spa", district: "พระประแดง", license: "สส110100002-64", mapQuery: "Suksawat", address: "226 สุขสวัสดิ์", expire: "2569-12-21" },
            { name: "Dee Jung (ดีจัง)", type: "Massage", district: "พระประแดง", license: "สส110200022-65", mapQuery: "Pu Chao Saming Phrai", address: "89/6 ปู่เจ้าสมิงพราย", expire: "2570-06-12" },
            { name: "Rung Rueang (รุ่งเรือง)", type: "Massage", district: "พระประแดง", license: "สส110200015-66", mapQuery: "Bang Nam Phueng Floating Market", address: "1046 นครเขื่อนขันธ์", expire: "2571-03-26" },
            { name: "Aemook (เอ๋มุก)", type: "Massage", district: "พระประแดง", license: "สส110200050-67", mapQuery: "Samrong Tai", address: "1/21 สำโรงใต้", expire: "2572-11-12" },
            { name: "Bangkok Tree House", type: "Food/Hotel", district: "พระประแดง", license: "-", mapQuery: "Bangkok Tree House", address: "60 ม.1 บางน้ำผึ้ง", expire: "-" },
            { name: "Baan Thoop Hom (บ้านธูปหอม)", type: "Activity", district: "พระประแดง", license: "-", mapQuery: "Baan Thoop Hom Samunphrai", address: "บางน้ำผึ้ง", expire: "-" },

            // --- พระสมุทรเจดีย์ (Phra Samut Chedi) ---
            { name: "Ban Rim Nam (บ้านริมน้ำ)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200034-66", mapQuery: "Wat Laem Fa Pha", address: "99/1 แหลมฟ้าผ่า", expire: "2571-08-10" },
            { name: "Duang Duean 2 (ดวงเดือน 2)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200020-62", mapQuery: "Nai Khlong Bang Pla Kot", address: "899/3 ในคลองบางปลากด", expire: "2567-07-09" },
            { name: "Duang Duean 1 (ดวงเดือน 1)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200021-62", mapQuery: "Pak Khlong Bang Pla Kot", address: "18 ปากคลองบางปลากด", expire: "2567-07-09" },
            { name: "Dao (ดาว)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200023-62", mapQuery: "Nai Khlong Bang Pla Kot", address: "899/22 ในคลองบางปลากด", expire: "2567-07-23" },
            { name: "Phet Nam Nueng (เพชรน้ำหนึ่ง)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200011-63", mapQuery: "Ban Khlong Suan", address: "790/11 บ้านคลองสวน", expire: "2568-02-17" },
            { name: "Anantaya (อนันตญา)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200015-64", mapQuery: "Pracha Uthit 90", address: "370/4 ประชาอุทิศ 90", expire: "2569-04-04" },
            { name: "Thiptara (ทิพย์ธารา)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200016-64", mapQuery: "Pracha Uthit 90", address: "370/2 ประชาอุทิศ 90", expire: "2569-04-04" },
            { name: "Sida (สีดา)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200042-65", mapQuery: "Suksawat", address: "79/4 สุขสวัสดิ์", expire: "2570-11-03" },
            { name: "Khwan Ruean (ขวัญเรือน)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200014-66", mapQuery: "Pak Khlong Bang Pla Kot", address: "134/15 ปากคลองบางปลากด", expire: "2571-03-22" },
            { name: "You and Me 888", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200032-66", mapQuery: "Pracha Uthit 90", address: "699/67 ประชาอุทิศ 90", expire: "2571-08-03" },
            { name: "Mimi (มีมี่)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200029-67", mapQuery: "Phra Samut Chedi", address: "699/14 ในคลองบางปลากด", expire: "2572-07-09" },
            { name: "Mayu 2 (มายู 2)", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส11020030-67", mapQuery: "Nai Khlong Bang Pla Kot", address: "883/9 ในคลองบางปลากด", expire: "2572-07-09" },
            { name: "CC Relax", type: "Massage", district: "พระสมุทรเจดีย์", license: "สส110200035-67", mapQuery: "Nai Khlong Bang Pla Kot", address: "711/9 ในคลองบางปลากด", expire: "2572-09-03" },

            // --- บางบ่อ (Bang Bo) ---
            { name: "Apirom (อภิรมย์)", type: "Massage", district: "บางบ่อ", license: "สส110200036-62", mapQuery: "Bangna-Trad", address: "237 บางนา-ตราด", expire: "2567-11-27" },
            { name: "Apirom 2 (อภิรมย์ 2)", type: "Massage", district: "บางบ่อ", license: "สส110200037-63", mapQuery: "Wat Bang Bo", address: "555/93 บางบ่อ", expire: "2568-07-14" },
            { name: "Panita (ภณิตา)", type: "Massage", district: "บางบ่อ", license: "สส110200020-63", mapQuery: "Bang Bo Bypass", address: "297/10 บายพาส", expire: "2568-06-03" },
            { name: "Ban Rak (บ้านรัก)", type: "Massage", district: "บางบ่อ", license: "สส110200047-63", mapQuery: "Bang Bo", address: "320/9 บางบ่อ", expire: "2568-08-31" },
            { name: "Ruean Thai Buntham", type: "Massage", district: "บางบ่อ", license: "สส110200051-63", mapQuery: "Bang Bo", address: "569/28 บางบ่อ", expire: "2568-09-10" },
            { name: "Aleena (อลีณา)", type: "Massage", district: "บางบ่อ", license: "สส110200003-64", mapQuery: "Bang Phriang", address: "264/1 บางเพรียง", expire: "2569-02-02" },
            { name: "Lucky Relax", type: "Massage", district: "บางบ่อ", license: "สส110200005-64", mapQuery: "Bang Bo", address: "595/5 บางบ่อ", expire: "2569-02-10" },
            { name: "Cathy (คาเธ่ย์)", type: "Massage", district: "บางบ่อ", license: "สส110200026-64", mapQuery: "Bang Bo", address: "124/11-12 บางบ่อ", expire: "2569-06-16" },
            { name: "Praew (แพรว)", type: "Massage", district: "บางบ่อ", license: "สส110200011-65", mapQuery: "Bang Bo", address: "555/17 บางบ่อ", expire: "2570-02-21" },
            { name: "CK Relax", type: "Massage", district: "บางบ่อ", license: "สส110200013-66", mapQuery: "Pan Withi", address: "381/6 ปานวิถี", expire: "2571-03-19" },
            { name: "Nicha (ณิชา)", type: "Massage", district: "บางบ่อ", license: "สส110200031-66", mapQuery: "Bang Bo", address: "362/1 บางบ่อ", expire: "2571-07-26" },
            { name: "Ban Khlong Dan", type: "Massage", district: "บางบ่อ", license: "สส110200001-67", mapQuery: "Khlong Dan", address: "627 สุขุมวิทสายเก่า", expire: "2572-01-08" },
            { name: "Pimpisa (พิมพ์พิศา)", type: "Massage", district: "บางบ่อ", license: "สส110200010-67", mapQuery: "Bang Bo", address: "327/9 บางบ่อ", expire: "2572-02-28" },
            { name: "Anya (อัญญา)", type: "Massage", district: "บางบ่อ", license: "สส110200045-68", mapQuery: "Bang Bo", address: "108/1 ปานวิถี", expire: "-" }
        ].map(item => {
            // Add mock score for existing items if missing
            if (!item.score) {
                const safe = Math.floor(Math.random() * (30 - 24 + 1)) + 24;
                const clean = Math.floor(Math.random() * (30 - 24 + 1)) + 24;
                const service = Math.floor(Math.random() * (20 - 15 + 1)) + 15;
                const place = Math.floor(Math.random() * (20 - 15 + 1)) + 15;
                item.score = { safe, clean, service, place };
            }
            return item;
        });

        let myPlan = [];
        let scoreChart = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderListings();
            initRanking();
            initOneDayItinerary();
            initTwoDayItinerary();
            initCustomSlots(); // Initialize Custom Slots
        });

        // --- RANKING LOGIC ---
        function initRanking() {
            // 1. Populate Top 5 List
            const top5 = allLocations.sort((a, b) => {
                const scoreA = (a.score?.safe + a.score?.clean + a.score?.service + a.score?.place) || 0;
                const scoreB = (b.score?.safe + b.score?.clean + b.score?.service + b.score?.place) || 0;
                return scoreB - scoreA;
            }).slice(0, 5);

            const top5List = document.getElementById('top5List');
            top5List.innerHTML = '';
            top5.forEach((item, index) => {
                const total = item.score.safe + item.score.clean + item.score.service + item.score.place;
                top5List.innerHTML += `
                    <div class="card-bali p-4 flex items-center gap-4 cursor-pointer hover:bg-bali-base/50" onclick="selectScoreDetail('${item.name}')">
                        <div class="w-12 h-12 flex-shrink-0 bg-bali-gold text-white rounded-xl flex items-center justify-center text-2xl font-serif font-bold shadow">${index + 1}</div>
                        <div class="flex-1 min-w-0">
                            <h4 class="font-bold text-gray-800 truncate">${item.name}</h4>
                            <p class="text-xs text-gray-500">${item.district} | ${item.type}</p>
                        </div>
                        <div class="text-right">
                            <span class="text-2xl font-bold text-bali-green">${total}</span>
                            <span class="text-xs text-gray-400 block">คะแนน</span>
                        </div>
                    </div>
                `;
            });

            // 2. Populate Dropdown
            const dropdown = document.getElementById('scoreSelect');
            dropdown.innerHTML = '';
            const sortedLocations = [...allLocations].sort((a, b) => a.name.localeCompare(b.name, 'th'));
            sortedLocations.forEach(loc => {
                if(loc.score) {
                    const option = document.createElement('option');
                    option.value = loc.name;
                    option.text = loc.name;
                    dropdown.appendChild(option);
                }
            });

            if(top5.length > 0) selectScoreDetail(top5[0].name);
        }

        function updateScoreChart() {
            const name = document.getElementById('scoreSelect').value;
            selectScoreDetail(name);
        }

        function selectScoreDetail(name) {
            const item = allLocations.find(l => l.name === name);
            if(!item || !item.score) return;

            document.getElementById('selectedName').innerText = item.name;
            document.getElementById('selectedType').innerText = `${item.district} • ${item.type}`;
            document.getElementById('totalScore').innerText = item.score.safe + item.score.clean + item.score.service + item.score.place;
            document.getElementById('scoreSelect').value = name;

            const ctx = document.getElementById('scoreChart').getContext('2d');
            if(scoreChart) scoreChart.destroy();

            scoreChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: ['ความปลอดภัย (30)', 'ความสะอาด (30)', 'การบริการ (20)', 'สถานที่ (20)'],
                    datasets: [{
                        label: 'คะแนน',
                        data: [item.score.safe, item.score.clean, item.score.service, item.score.place],
                        backgroundColor: [
                            'rgba(34, 197, 94, 0.7)', 'rgba(59, 130, 246, 0.7)', 'rgba(234, 179, 8, 0.7)', 'rgba(168, 85, 247, 0.7)'
                        ],
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true, max: 30 } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        // --- PLANNER LOGIC ---
        function selectTripType(type) {
            ['oneday', 'twoday', 'custom'].forEach(t => {
                const btn = document.getElementById(`btn-${t}`);
                if(t === type) {
                    btn.classList.remove('bg-gray-100', 'text-gray-600');
                    btn.classList.add('bg-bali-green', 'text-white');
                } else {
                    btn.classList.remove('bg-bali-green', 'text-white');
                    btn.classList.add('bg-gray-100', 'text-gray-600');
                }
            });

            document.getElementById('welcomeMsg').classList.add('hidden');
            document.getElementById('onedayContent').classList.add('hidden');
            document.getElementById('twodayContent').classList.add('hidden');
            document.getElementById('customContent').classList.add('hidden');

            const content = document.getElementById(`${type}Content`);
            content.classList.remove('hidden');
            content.classList.add('slide-in-bottom');
        }

        function initOneDayItinerary() {
            const list = document.getElementById('onedayList');
            const items = [
                { time: '09:00', name: 'Pran Spa', desc: 'นวดผ่อนคลายหลังเดินทาง', map: 'Divalux Resort and Spa Suvarnabhumi' },
                { time: '11:30', name: 'Ohkajhu', desc: 'มื้อเที่ยงสุขภาพ (สาขาดาดฟ้า)', map: 'Ohkajhu Dadfa Lasalle' },
                { time: '13:30', name: 'Bang Krachao', desc: 'ปั่นจักรยานสูดโอโซน', map: 'Sri Nakhon Khuean Khan Park' },
                { time: '16:30', name: 'Sasa Onsen', desc: 'แช่น้ำแร่คลายกล้ามเนื้อ', map: 'Sasa Onsen and Spa' },
            ];
            list.innerHTML = '';
            items.forEach(item => {
                list.innerHTML += createItineraryCard(item);
            });
        }

        function initTwoDayItinerary() {
            const list = document.getElementById('twodayList');
            list.innerHTML = `
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100">
                    <h4 class="font-bold text-blue-800 mb-2">Day 1: Culture & Luxury</h4>
                    <div class="space-y-3 pl-4 border-l-2 border-blue-200">
                        ${createMiniCard('เช้า', 'Explore Spa', 'Summit Windmill Golf Club')}
                        ${createMiniCard('บ่าย', 'Ancient City', 'The Ancient City')}
                        ${createMiniCard('พัก', 'Divalux Resort', 'Divalux Resort')}
                    </div>
                </div>
                <div class="bg-green-50 p-4 rounded-xl border border-green-100">
                    <h4 class="font-bold text-green-800 mb-2">Day 2: Eco-Living</h4>
                    <div class="space-y-3 pl-4 border-l-2 border-green-200">
                        ${createMiniCard('เช้า', 'Bang Nam Phueng Market', 'Bang Nam Phueng Floating Market')}
                        ${createMiniCard('บ่าย', 'Baan Thoop Hom', 'Baan Thoop Hom')}
                        ${createMiniCard('เย็น', 'Bangkok Tree House', 'Bangkok Tree House')}
                    </div>
                </div>
            `;
        }

        // --- CUSTOM TRIP LOGIC (NEW) ---
        let customSlotsCount = 3;

        function initCustomSlots() {
            const container = document.getElementById('customSlots');
            container.innerHTML = '';
            // Create initial 3 slots
            for(let i = 0; i < 3; i++) {
                addCustomSlotHTML(i);
            }
        }

        function addCustomSlot() {
            addCustomSlotHTML(customSlotsCount++);
        }

        function addCustomSlotHTML(index) {
            const container = document.getElementById('customSlots');
            const div = document.createElement('div');
            div.className = "bg-gray-50 p-4 rounded-xl border border-gray-200 relative group";
            div.id = `slot-${index}`;
            
            // Build Dropdown Options
            let options = '<option value="">-- เลือกสถานที่ --</option>';
            // Sort alphabetically for better UX
            const sorted = [...allLocations].sort((a,b) => a.name.localeCompare(b.name, 'th'));
            sorted.forEach(loc => {
                options += `<option value="${loc.name}">${loc.name} (${loc.type})</option>`;
            });

            div.innerHTML = `
                <div class="flex justify-between items-center mb-2">
                    <span class="text-xs font-bold text-bali-green bg-white px-2 py-1 rounded shadow-sm">จุดแวะที่ ${index + 1}</span>
                    <button onclick="removeCustomSlot('slot-${index}')" class="text-red-400 hover:text-red-600 text-xs"><i class="fas fa-trash"></i> ลบ</button>
                </div>
                <select id="select-${index}" onchange="previewSelection(${index})" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-bali-green focus:border-bali-green text-sm">
                    ${options}
                </select>
                <div id="preview-${index}" class="mt-3 hidden">
                    <!-- Preview Content injected here -->
                </div>
            `;
            container.appendChild(div);
        }

        function removeCustomSlot(id) {
            const el = document.getElementById(id);
            if(el) el.remove();
        }

        function previewSelection(index) {
            const select = document.getElementById(`select-${index}`);
            const preview = document.getElementById(`preview-${index}`);
            const name = select.value;
            
            if(!name) {
                preview.classList.add('hidden');
                return;
            }

            const loc = allLocations.find(l => l.name === name);
            if(loc) {
                preview.innerHTML = `
                    <div class="flex items-start gap-3 p-3 bg-white rounded-lg border border-bali-green/20">
                        <div class="bg-bali-lightGreen/20 p-2 rounded-full text-bali-green"><i class="fas fa-map-marker-alt"></i></div>
                        <div class="flex-1 min-w-0">
                            <h5 class="font-bold text-gray-800 text-sm truncate">${loc.name}</h5>
                            <p class="text-xs text-gray-500">${loc.district} • ${loc.type}</p>
                            <button onclick="updateMap('${loc.name}', '${loc.mapQuery}')" class="text-xs text-bali-gold hover:underline mt-1">ดูแผนที่</button>
                        </div>
                    </div>
                `;
                preview.classList.remove('hidden');
            }
        }

        function saveCustomTrip() {
            const container = document.getElementById('customSlots');
            const selects = container.querySelectorAll('select');
            let selectedCount = 0;

            selects.forEach(select => {
                const name = select.value;
                if(name) {
                    const loc = allLocations.find(l => l.name === name);
                    if(loc) {
                        addToPlan(loc.name, loc.type, 'Custom Trip', loc.mapQuery);
                        selectedCount++;
                    }
                }
            });

            if(selectedCount > 0) {
                Swal.fire({
                    icon: 'success',
                    title: 'บันทึกเรียบร้อย',
                    text: `เพิ่ม ${selectedCount} สถานที่ลงในกระเป๋าเดินทางแล้ว`,
                    confirmButtonColor: '#2C5F2D'
                });
            } else {
                Swal.fire({
                    icon: 'warning',
                    title: 'ยังไม่ได้เลือกสถานที่',
                    text: 'กรุณาเลือกสถานที่อย่างน้อย 1 แห่ง',
                    confirmButtonColor: '#D4AF37'
                });
            }
        }

        // --- HELPER FUNCTIONS ---
        function createItineraryCard(item) {
            return `
                <div class="bg-white p-4 rounded-xl shadow-sm flex justify-between items-start border border-gray-50 hover:border-bali-lightGreen transition group">
                    <div class="absolute -left-[39px] bg-bali-lightGreen w-4 h-4 rounded-full border-2 border-white shadow"></div>
                    <div>
                        <span class="text-xs font-bold text-bali-green bg-bali-base px-2 py-1 rounded mb-1 inline-block">${item.time}</span>
                        <h4 class="font-bold text-gray-800">${item.name}</h4>
                        <p class="text-sm text-gray-500">${item.desc}</p>
                        <button onclick="updateMap('${item.name}', '${item.map}')" class="text-xs text-bali-gold hover:underline mt-2"><i class="fas fa-map-marker-alt"></i> ดูแผนที่</button>
                    </div>
                    <button onclick="addToPlan('${item.name}', 'Activity', '${item.time}', '${item.map}')" class="text-gray-300 hover:text-bali-green transition text-xl"><i class="fas fa-plus-circle"></i></button>
                </div>
            `;
        }

        function createMiniCard(time, name, map) {
            return `
                <div class="flex justify-between items-center group cursor-pointer" onclick="updateMap('${name}', '${map}')">
                    <div>
                        <span class="text-xs font-bold text-gray-400 mr-2">${time}</span>
                        <span class="text-sm text-gray-700 font-medium group-hover:text-bali-green transition">${name}</span>
                    </div>
                    <i class="fas fa-map-marker-alt text-xs text-gray-300 group-hover:text-bali-green"></i>
                </div>
            `;
        }

        // --- MAP & LISTINGS ---
        function updateMap(name, query) {
            const mapFrame = document.getElementById('googleMap');
            mapFrame.src = `https://maps.google.com/maps?q=${encodeURIComponent(query)}&t=&z=14&ie=UTF8&iwloc=&output=embed`;
            document.getElementById('planner').scrollIntoView({ behavior: 'smooth' });
        }

        function openRouteMap() {
            if(myPlan.length === 0) return Swal.fire('แจ้งเตือน', 'กรุณาเลือกสถานที่ก่อนนำทาง', 'warning');
            let routeUrl = "https://www.google.com/maps/dir/";
            myPlan.forEach(item => { const q = item.query ? encodeURIComponent(item.query) : encodeURIComponent(item.name); routeUrl += `${q}/`; });
            window.open(routeUrl, '_blank');
        }

        function renderListings() {
            const district = document.getElementById('districtFilter').value;
            const search = document.getElementById('searchInput').value.toLowerCase();
            const tbody = document.getElementById('listingsTableBody');
            const noResults = document.getElementById('noResults');
            
            tbody.innerHTML = '';
            
            const filtered = allLocations.filter(loc => {
                const matchesDistrict = district === 'all' || loc.district === district;
                const matchesSearch = loc.name.toLowerCase().includes(search) || loc.license.toLowerCase().includes(search);
                return matchesDistrict && matchesSearch;
            });

            if (filtered.length === 0) {
                noResults.classList.remove('hidden');
            } else {
                noResults.classList.add('hidden');
                filtered.forEach(loc => {
                    const row = `
                        <tr class="hover:bg-bali-base transition border-b border-gray-50 last:border-0">
                            <td class="p-4 font-medium text-gray-800">${loc.name}</td>
                            <td class="p-4"><span class="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs">${loc.type}</span></td>
                            <td class="p-4 text-sm text-gray-500">${loc.district}</td>
                            <td class="p-4 text-sm text-gray-400 font-mono">${loc.license}</td>
                            <td class="p-4 text-center">
                                <button onclick="showDetailsModal('${loc.name}')" class="text-bali-green hover:bg-bali-green hover:text-white w-8 h-8 rounded-full transition"><i class="fas fa-search"></i></button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            }
        }

        function showDetailsModal(name) {
            const loc = allLocations.find(l => l.name === name);
            if(!loc) return;

            document.getElementById('modalName').innerText = loc.name;
            document.getElementById('modalType').innerText = loc.type;
            document.getElementById('modalLicense').innerText = loc.license;
            document.getElementById('modalAddress').innerText = loc.address || loc.district;
            document.getElementById('modalExpire').innerText = loc.expire;
            document.getElementById('modalMapFrame').src = `https://maps.google.com/maps?q=${encodeURIComponent(loc.mapQuery)}&t=h&z=16&ie=UTF8&iwloc=&output=embed`;
            document.getElementById('modalMapLink').href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(loc.mapQuery)}`;

            document.getElementById('detailsModal').classList.remove('hidden');
            document.getElementById('detailsModal').classList.add('flex');
        }

        function closeDetailsModal() {
            document.getElementById('detailsModal').classList.add('hidden');
            document.getElementById('detailsModal').classList.remove('flex');
        }

        // --- SHOPPING CART (PLANNER) ---
        function addToPlan(name, type, time, query) {
            if (myPlan.some(item => item.name === name)) return;
            myPlan.push({ name, type, time, query });
            updatePlannerUI();
            const bar = document.getElementById('plannerBar');
            bar.classList.remove('translate-y-full');
            document.getElementById('plannerToggleBtn').classList.add('hidden');
        }

        function clearPlan() { myPlan = []; updatePlannerUI(); togglePlanner(); }

        function updatePlannerUI() {
            const list = document.getElementById('selectedList');
            const count = document.getElementById('itemCount');
            const badge = document.getElementById('badgeCount');
            const placeholder = document.getElementById('emptyPlaceholder');

            count.innerText = `${myPlan.length} สถานที่`;
            badge.innerText = myPlan.length;

            if (myPlan.length === 0) {
                list.innerHTML = ''; list.appendChild(placeholder); placeholder.classList.remove('hidden'); return;
            } else { placeholder.classList.add('hidden'); }

            list.innerHTML = '';
            myPlan.forEach((item, index) => {
                list.innerHTML += `
                    <div class="min-w-[140px] bg-bali-base border border-bali-green/20 p-3 rounded-xl relative group flex-shrink-0">
                        <button onclick="myPlan.splice(${index},1); updatePlannerUI();" class="absolute -top-2 -right-2 bg-red-400 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow hover:bg-red-500"><i class="fas fa-times"></i></button>
                        <h5 class="font-bold text-sm truncate text-gray-800">${item.name}</h5>
                        <p class="text-xs text-gray-500">${item.time}</p>
                    </div>
                `;
            });
        }

        function togglePlanner() {
            const bar = document.getElementById('plannerBar');
            const btn = document.getElementById('plannerToggleBtn');
            if (bar.classList.contains('translate-y-full')) { bar.classList.remove('translate-y-full'); btn.classList.add('hidden'); }
            else { bar.classList.add('translate-y-full'); if (myPlan.length > 0) btn.classList.remove('hidden'); }
        }

        function confirmPlan() {
            if(myPlan.length === 0) return;
            const modalList = document.getElementById('modalList');
            modalList.innerHTML = '';
            myPlan.forEach((item, index) => {
                modalList.innerHTML += `
                    <div class="relative bg-white p-4 rounded-xl shadow-sm flex items-center gap-4">
                        <div class="absolute -left-[43px] top-1/2 -translate-y-1/2 w-6 h-6 rounded-full bg-bali-gold border-4 border-bali-base"></div>
                        <div class="flex-1">
                            <span class="text-xs font-bold text-bali-green uppercase">${item.type}</span>
                            <h4 class="font-bold text-gray-800">${item.name}</h4>
                        </div>
                    </div>
                `;
            });
            document.getElementById('itineraryModal').classList.remove('hidden');
            document.getElementById('itineraryModal').classList.add('flex');
        }

        function closeModal() {
            document.getElementById('itineraryModal').classList.add('hidden');
            document.getElementById('itineraryModal').classList.remove('flex');
        }

        function saveItineraryImage() {
            html2canvas(document.getElementById('captureArea')).then(canvas => {
                const link = document.createElement('a');
                link.download = 'My_Bali_Wellness_Trip.png';
                link.href = canvas.toDataURL();
                link.click();
            });
        }

        // --- Helper for triggers ---
        function triggerMapUpdate(id, name, query) {
            updateMap(name, query);
        }
    </script>
</body>
</html>