import React, { useState, useMemo, useEffect } from 'react';
import { 
  Users, Calendar, AlertTriangle, 
  Droplets, Utensils, Shield, HeartPulse, 
  BatteryCharging, Radio, Anchor, Dog, 
  FileText, PenTool, Info, Plus, Minus,
  ChevronDown, ChevronUp, Printer, FileDown,
  PhoneCall, Globe, X, ExternalLink, MapPin,
  Save, PlusCircle, Navigation, Crosshair,
  ClipboardCheck, PieChart, BarChart3, CheckCircle2,
  Loader2, Square, CheckSquare, Eye
} from 'lucide-react';

// --- Data Types ---
type Category = 
  | 'docs' | 'meds' | 'food' | 'clothes' | 'hygiene' 
  | 'pets' | 'comms' | 'power' | 'vehicle' | 'weapon' 
  | 'survival' | 'misc';

interface Item {
  id: string;
  name: string;
  category: Category;
  baseQty: number;
  unit: string;
  isPerPerson: boolean;
  isPerDay: boolean;
  priority: 'high' | 'medium' | 'low';
  disasterTags: string[];
  advice: string;
  isChecked?: boolean;
}

// --- Constants & Data ---
const APP_INFO = {
  author: "Jeerapat Plai",
  version: "1.7", // Update version
  createdDate: "02/12/2025"
};

const DISASTER_TYPES = [
  { id: 'flood', label: '‡∏≠‡∏∏‡∏ó‡∏Å‡∏†‡∏±‡∏¢ (‡∏ô‡πâ‡∏≥‡∏ó‡πà‡∏ß‡∏°)', icon: 'üåä', color: 'text-blue-500' },
  { id: 'earthquake', label: '‡πÅ‡∏ú‡πà‡∏ô‡∏î‡∏¥‡∏ô‡πÑ‡∏´‡∏ß/‡∏ï‡∏∂‡∏Å‡∏ñ‡∏•‡πà‡∏°', icon: 'üèöÔ∏è', color: 'text-orange-600' },
  { id: 'civil_unrest', label: '‡∏à‡∏•‡∏≤‡∏à‡∏•/‡∏™‡∏á‡∏Ñ‡∏£‡∏≤‡∏°', icon: 'üõ°Ô∏è', color: 'text-red-600' },
  { id: 'pandemic', label: '‡πÇ‡∏£‡∏Ñ‡∏£‡∏∞‡∏ö‡∏≤‡∏î/‡∏Å‡∏±‡∏Å‡∏ï‡∏±‡∏ß', icon: 'üò∑', color: 'text-emerald-500' },
  { id: 'general', label: '‡∏ó‡∏±‡πà‡∏ß‡πÑ‡∏õ/‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°', icon: 'üéí', color: 'text-slate-600' },
];

const CATEGORY_MAP: Record<Category, { label: string; icon: React.ReactNode; fromColor: string; toColor: string; textColor: string }> = {
  docs: { label: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ & ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô', icon: <FileText className="w-5 h-5" />, fromColor: 'from-blue-500', toColor: 'to-blue-600', textColor: 'text-blue-700' },
  meds: { label: '‡∏¢‡∏≤ & ‡∏õ‡∏ê‡∏°‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•', icon: <HeartPulse className="w-5 h-5" />, fromColor: 'from-red-500', toColor: 'to-red-600', textColor: 'text-red-700' },
  food: { label: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£ & ‡∏ô‡πâ‡∏≥', icon: <Utensils className="w-5 h-5" />, fromColor: 'from-orange-400', toColor: 'to-orange-500', textColor: 'text-orange-700' },
  clothes: { label: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏∏‡πà‡∏á‡∏´‡πà‡∏°', icon: <Users className="w-5 h-5" />, fromColor: 'from-indigo-500', toColor: 'to-indigo-600', textColor: 'text-indigo-700' },
  hygiene: { label: '‡∏™‡∏∏‡∏Ç‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢', icon: <Droplets className="w-5 h-5" />, fromColor: 'from-cyan-400', toColor: 'to-cyan-500', textColor: 'text-cyan-700' },
  pets: { label: '‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á', icon: <Dog className="w-5 h-5" />, fromColor: 'from-yellow-400', toColor: 'to-yellow-500', textColor: 'text-yellow-700' },
  comms: { label: '‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£', icon: <Radio className="w-5 h-5" />, fromColor: 'from-purple-500', toColor: 'to-purple-600', textColor: 'text-purple-700' },
  power: { label: '‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô', icon: <BatteryCharging className="w-5 h-5" />, fromColor: 'from-green-500', toColor: 'to-green-600', textColor: 'text-green-700' },
  vehicle: { label: '‡∏û‡∏≤‡∏´‡∏ô‡∏∞', icon: <Anchor className="w-5 h-5" />, fromColor: 'from-teal-500', toColor: 'to-teal-600', textColor: 'text-teal-700' },
  weapon: { label: '‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò', icon: <Shield className="w-5 h-5" />, fromColor: 'from-stone-500', toColor: 'to-stone-600', textColor: 'text-stone-700' },
  survival: { label: '‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ & ‡∏¢‡∏±‡∏á‡∏ä‡∏µ‡∏û', icon: <AlertTriangle className="w-5 h-5" />, fromColor: 'from-rose-500', toColor: 'to-rose-600', textColor: 'text-rose-700' },
  misc: { label: '‡∏≠‡∏∑‡πà‡∏ô‡πÜ', icon: <PenTool className="w-5 h-5" />, fromColor: 'from-slate-400', toColor: 'to-slate-500', textColor: 'text-slate-700' },
};

// Expanded Database
const INITIAL_DB: Item[] = [
  // 1. ‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ ‡∏ó‡∏£‡∏±‡∏û‡∏¢‡πå‡∏™‡∏¥‡∏ô
  { id: 'd1', name: '‡∏ö‡∏±‡∏ï‡∏£‡∏õ‡∏£‡∏∞‡∏ä‡∏≤‡∏ä‡∏ô', category: 'docs', baseQty: 1, unit: '‡πÉ‡∏ö', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡∏ñ‡πà‡∏≤‡∏¢‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å‡πÅ‡∏¢‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ ‡πÅ‡∏•‡∏∞‡∏™‡πÅ‡∏Å‡∏ô‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Cloud' },
  { id: 'd2', name: 'Passport', category: 'docs', baseQty: 1, unit: '‡πÄ‡∏•‡πà‡∏°', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏ ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô' },
  { id: 'd3', name: '‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ö‡πâ‡∏≤‡∏ô/‡πÇ‡∏â‡∏ô‡∏î', category: 'docs', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['flood', 'civil_unrest'], advice: '‡πÄ‡∏Å‡πá‡∏ö‡∏ï‡∏±‡∏ß‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ ‡∏û‡∏Å‡∏™‡∏≥‡πÄ‡∏ô‡∏≤‡πÄ‡∏Ñ‡∏•‡∏∑‡∏≠‡∏ö‡∏Å‡∏±‡∏ô‡∏ô‡πâ‡∏≥' },
  { id: 'd4', name: '‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏á‡∏¥‡∏ô/‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ç‡∏ä‡∏µ', category: 'docs', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['all'], advice: '‡∏à‡∏î‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡πÅ‡∏•‡∏∞‡πÄ‡∏ö‡∏≠‡∏£‡πå Call Center ‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£‡πÑ‡∏ß‡πâ' },
  { id: 'd5', name: '‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏î', category: 'docs', baseQty: 3000, unit: '‡∏ö‡∏≤‡∏ó', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÅ‡∏ö‡∏á‡∏Ñ‡πå‡∏¢‡πà‡∏≠‡∏¢ 20, 50, 100 ‡πÑ‡∏ß‡πâ‡∏°‡∏≤‡∏Å‡πÜ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ã‡∏∑‡πâ‡∏≠‡∏á‡πà‡∏≤‡∏¢' },
  { id: 'd6', name: '‡∏ó‡∏≠‡∏á‡∏Ñ‡∏≥/‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏£‡∏∞‡∏î‡∏±‡∏ö', category: 'docs', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['civil_unrest', 'general'], advice: '‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏Å‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏á‡∏¥‡∏ô‡∏ï‡∏£‡∏≤‡∏´‡∏°‡∏î‡∏Ñ‡πà‡∏≤ ‡πÄ‡∏Å‡πá‡∏ö‡∏°‡∏¥‡∏î‡∏ä‡∏¥‡∏î‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î' },

  // 2. ‡∏¢‡∏≤‡πÅ‡∏•‡∏∞‡∏ä‡∏∏‡∏î‡∏õ‡∏ê‡∏°‡∏ö‡∏≤‡∏•
  { id: 'm1', name: '‡∏¢‡∏≤‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (‡∏õ‡πã‡∏≤/‡∏õ‡∏±‡∏ô)', category: 'meds', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['all'], advice: '‡∏¢‡∏≤‡πÇ‡∏£‡∏Ñ‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡∏ï‡∏±‡∏ß‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 14 ‡∏ß‡∏±‡∏ô' },
  { id: 'm2', name: '‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏¢‡∏≤‡πÅ‡∏î‡∏á (First Aid)', category: 'meds', baseQty: 1, unit: '‡πÉ‡∏ö', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡πÄ‡∏ö‡∏ï‡∏≤‡∏î‡∏µ‡∏ô ‡∏ú‡πâ‡∏≤‡∏Å‡πä‡∏≠‡∏ã ‡πÄ‡∏ó‡∏õ‡∏ó‡∏≥‡πÅ‡∏ú‡∏• ‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£' },
  { id: 'm3', name: '‡πÄ‡∏Å‡∏•‡∏∑‡∏≠‡πÅ‡∏£‡πà (ORS)', category: 'meds', baseQty: 2, unit: '‡∏ã‡∏≠‡∏á', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['flood', 'pandemic'], advice: '‡∏ä‡∏î‡πÄ‡∏ä‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏™‡∏µ‡∏¢‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡πÑ‡∏î‡πâ‡∏î‡∏µ' },
  { id: 'm4', name: '‡∏Ñ‡∏≤‡∏£‡πå‡∏ö‡∏≠‡∏ô/‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡∏ó‡πâ‡∏≠‡∏á‡πÄ‡∏™‡∏µ‡∏¢', category: 'meds', baseQty: 1, unit: '‡πÅ‡∏ú‡∏á', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['flood'], advice: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏õ‡πá‡∏ô‡∏û‡∏¥‡∏©‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏î‡πâ‡∏á‡πà‡∏≤‡∏¢‡πÉ‡∏ô‡∏†‡∏≤‡∏ß‡∏∞‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥' },
  { id: 'm5', name: '‡∏¢‡∏≤‡∏õ‡∏è‡∏¥‡∏ä‡∏µ‡∏ß‡∏ô‡∏∞', category: 'meds', baseQty: 1, unit: '‡πÅ‡∏ú‡∏á', isPerPerson: true, isPerDay: false, priority: 'low', disasterTags: ['general'], advice: '‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏ö‡∏Ñ‡∏ó‡∏µ‡πÄ‡∏£‡∏µ‡∏¢‡∏£‡∏∏‡∏ô‡πÅ‡∏£‡∏á ‡∏õ‡∏£‡∏∂‡∏Å‡∏©‡∏≤‡πÄ‡∏†‡∏™‡∏±‡∏ä‡∏Å‡πà‡∏≠‡∏ô‡πÉ‡∏ä‡πâ' },
  { id: 'm6', name: '‡∏¢‡∏≤‡πÅ‡∏Å‡πâ‡πÅ‡∏û‡πâ', category: 'meds', baseQty: 1, unit: '‡πÅ‡∏ú‡∏á', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['all'], advice: '‡∏•‡∏î‡∏ô‡πâ‡∏≥‡∏°‡∏π‡∏Å‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏Å‡∏≤‡∏£‡πÅ‡∏û‡πâ‡∏≠‡∏≤‡∏Å‡∏≤‡∏®/‡πÅ‡∏°‡∏•‡∏á‡∏Å‡∏±‡∏î‡∏ï‡πà‡∏≠‡∏¢' },
  { id: 'm7', name: '‡∏û‡∏≤‡∏£‡∏≤‡πÄ‡∏ã‡∏ï‡∏≤‡∏°‡∏≠‡∏•', category: 'meds', baseQty: 1, unit: '‡πÅ‡∏ú‡∏á', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡∏•‡∏î‡πÑ‡∏Ç‡πâ ‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏õ‡∏ß‡∏î' },
  { id: 'm8', name: '‡∏¢‡∏≤‡∏ô‡∏ß‡∏î/Counterpain', category: 'meds', baseQty: 1, unit: '‡∏´‡∏•‡∏≠‡∏î', isPerPerson: false, isPerDay: false, priority: 'low', disasterTags: ['earthquake', 'flood'], advice: '‡∏ö‡∏£‡∏£‡πÄ‡∏ó‡∏≤‡∏õ‡∏ß‡∏î‡∏Å‡∏•‡πâ‡∏≤‡∏°‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ç‡∏ô‡∏Ç‡∏≠‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡πÑ‡∏Å‡∏•' },

  // 3. ‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÅ‡∏´‡πâ‡∏á ‡∏ô‡πâ‡∏≥
  { id: 'f1', name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô (MRE)', category: 'food', baseQty: 3, unit: '‡∏°‡∏∑‡πâ‡∏≠', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['all'], advice: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö‡πÉ‡∏´‡πâ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô‡∏™‡∏π‡∏á‡πÅ‡∏•‡∏∞‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ô‡πâ‡∏≥‡∏£‡πâ‡∏≠‡∏ô‡∏õ‡∏£‡∏∏‡∏á' },
  { id: 'f2', name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', category: 'food', baseQty: 2, unit: '‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', isPerPerson: true, isPerDay: true, priority: 'medium', disasterTags: ['flood', 'general'], advice: '‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏´‡∏π‡πÄ‡∏õ‡∏¥‡∏î‡∏á‡πà‡∏≤‡∏¢ (Easy open) ‡∏´‡∏£‡∏∑‡∏≠‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á‡πÑ‡∏ß‡πâ' },
  { id: 'f3', name: '‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° (‡∏Ç‡∏ß‡∏î/‡∏ñ‡∏∏‡∏á)', category: 'food', baseQty: 3, unit: '‡∏•‡∏¥‡∏ï‡∏£', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['all'], advice: '‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πà‡∏≥ 3 ‡∏•‡∏¥‡∏ï‡∏£/‡∏Ñ‡∏ô/‡∏ß‡∏±‡∏ô ‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Å‡∏ß‡πà‡∏≤‡∏≠‡∏≤‡∏´‡∏≤‡∏£' },
  { id: 'f4', name: '‡∏ñ‡∏∏‡∏á‡πÉ‡∏™‡πà‡∏ô‡πâ‡∏≥ 10 ‡∏•‡∏¥‡∏ï‡∏£', category: 'food', baseQty: 1, unit: '‡πÉ‡∏ö', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['general'], advice: '‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏Å‡∏ô‡πâ‡∏≥‡∏à‡∏≤‡∏Å‡πÅ‡∏´‡∏•‡πà‡∏á‡∏ô‡πâ‡∏≥‡∏Å‡∏•‡∏≤‡∏á‡∏°‡∏≤‡∏Å‡∏±‡∏Å‡∏ï‡∏∏‡∏ô' },
  { id: 'f5', name: '‡πÄ‡∏ï‡∏≤‡πÅ‡∏Å‡πä‡∏™‡∏õ‡∏¥‡∏Ñ‡∏ô‡∏¥‡∏Ñ + ‡πÅ‡∏Å‡πä‡∏™', category: 'food', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['flood', 'civil_unrest'], advice: '‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏°‡∏ô‡πâ‡∏≥‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠‡πÅ‡∏•‡∏∞‡∏ó‡∏≥‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏£‡πâ‡∏≠‡∏ô' },
  { id: 'f6', name: '‡∏à‡∏≤‡∏ô/‡∏ä‡πâ‡∏≠‡∏ô/‡∏™‡πâ‡∏≠‡∏° (‡∏û‡∏•‡∏≤‡∏™‡∏ï‡∏¥‡∏Å)', category: 'food', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: true, isPerDay: false, priority: 'low', disasterTags: ['general'], advice: '‡πÅ‡∏ö‡∏ö‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ó‡∏¥‡πâ‡∏á‡∏ä‡πà‡∏ß‡∏¢‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ô‡πâ‡∏≥‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô' },
  { id: 'f7', name: '‡∏´‡∏°‡πâ‡∏≠‡∏™‡∏ô‡∏≤‡∏°', category: 'food', baseQty: 1, unit: '‡πÉ‡∏ö', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['civil_unrest'], advice: '‡∏ó‡∏ô‡∏ó‡∏≤‡∏ô ‡πÉ‡∏ä‡πâ‡∏ï‡πâ‡∏°‡∏ô‡πâ‡∏≥‡πÑ‡∏î‡πâ‡∏î‡∏µ ‡∏û‡∏Å‡∏û‡∏≤‡∏á‡πà‡∏≤‡∏¢' },

  // 4. ‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ô‡∏∏‡πà‡∏á‡∏´‡πà‡∏°
  { id: 'c1', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ä‡∏π‡∏ä‡∏µ‡∏û', category: 'clothes', baseQty: 1, unit: '‡∏ï‡∏±‡∏ß', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['flood'], advice: '‡∏ï‡∏¥‡∏î‡∏ô‡∏Å‡∏´‡∏ß‡∏µ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ä‡∏π‡∏ä‡∏µ‡∏û‡∏ó‡∏∏‡∏Å‡∏ï‡∏±‡∏ß' },
  { id: 'c2', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ô‡∏ù‡∏ô', category: 'clothes', baseQty: 1, unit: '‡∏ï‡∏±‡∏ß', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['flood', 'general'], advice: '‡∏Å‡∏±‡∏ô‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å‡πÅ‡∏•‡∏∞‡∏Å‡∏±‡∏ô‡∏•‡∏°‡∏´‡∏ô‡∏≤‡∏ß‡πÑ‡∏î‡πâ‡∏î‡∏µ' },
  { id: 'c3', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏Å‡∏±‡∏ô‡∏´‡∏ô‡∏≤‡∏ß', category: 'clothes', baseQty: 1, unit: '‡∏ï‡∏±‡∏ß', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['general'], advice: '‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏•‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á‡∏Å‡∏≤‡∏£‡∏õ‡πà‡∏ß‡∏¢' },
  { id: 'c4', name: '‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏ö‡∏π‡∏ó/‡∏£‡∏≠‡∏á‡πÄ‡∏ó‡πâ‡∏≤‡∏¢‡∏≤‡∏á', category: 'clothes', baseQty: 1, unit: '‡∏Ñ‡∏π‡πà', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['flood'], advice: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ‡∏ô‡πâ‡∏≥‡∏Å‡∏±‡∏î‡πÄ‡∏ó‡πâ‡∏≤‡πÅ‡∏•‡∏∞‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏°‡∏µ‡∏û‡∏¥‡∏©‡πÉ‡∏ô‡∏ô‡πâ‡∏≥' },
  { id: 'c5', name: '‡∏ä‡∏∏‡∏î‡∏•‡∏≥‡∏•‡∏≠‡∏á (‡∏õ‡πã‡∏≤/‡πÅ‡∏°‡πà/‡∏õ‡∏±‡∏ô)', category: 'clothes', baseQty: 3, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['all'], advice: '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡πâ‡∏≤‡πÅ‡∏´‡πâ‡∏á‡πÑ‡∏ß ‡∏£‡∏∞‡∏ö‡∏≤‡∏¢‡∏≠‡∏≤‡∏Å‡∏≤‡∏®‡∏î‡∏µ' },

  // 5. ‡∏™‡∏∏‡∏Ç‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢
  { id: 'h1', name: '‡∏ó‡∏¥‡∏ä‡∏ä‡∏π‡πà/‡πÄ‡∏õ‡∏µ‡∏¢‡∏Å/‡πÅ‡∏´‡πâ‡∏á', category: 'hygiene', baseQty: 1, unit: '‡πÅ‡∏û‡πá‡∏Ñ', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['all'], advice: '‡∏≠‡πÄ‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå ‡πÉ‡∏ä‡πâ‡πÄ‡∏ä‡πá‡∏î‡∏ï‡∏±‡∏ß ‡πÄ‡∏ä‡πá‡∏î‡∏Å‡πâ‡∏ô ‡πÄ‡∏ä‡πá‡∏î‡∏à‡∏≤‡∏ô' },
  { id: 'h2', name: '‡∏™‡∏ö‡∏π‡πà/‡πÅ‡∏ä‡∏°‡∏û‡∏π/‡∏¢‡∏≤‡∏™‡∏µ‡∏ü‡∏±‡∏ô', category: 'hygiene', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['general'], advice: '‡πÉ‡∏ä‡πâ‡∏Ç‡∏ô‡∏≤‡∏î‡∏û‡∏Å‡∏û‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏™‡∏ö‡∏π‡πà‡∏Å‡πâ‡∏≠‡∏ô‡∏ï‡∏±‡∏î‡πÅ‡∏ö‡πà‡∏á' },
  { id: 'h3', name: '‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢', category: 'hygiene', baseQty: 1, unit: '‡∏ä‡∏¥‡πâ‡∏ô', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['pandemic', 'civil_unrest'], advice: '‡∏Å‡∏±‡∏ô‡πÇ‡∏£‡∏Ñ ‡∏Å‡∏±‡∏ô‡∏ù‡∏∏‡πà‡∏ô‡∏Ñ‡∏ß‡∏±‡∏ô' },
  { id: 'h4', name: '‡∏ñ‡∏∏‡∏á‡∏î‡∏≥', category: 'hygiene', baseQty: 2, unit: '‡πÉ‡∏ö', isPerPerson: true, isPerDay: true, priority: 'high', disasterTags: ['flood', 'general'], advice: '‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏°‡∏≤‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡∏¢‡∏∞‡πÅ‡∏•‡∏∞‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢' },
  { id: 'h5', name: '‡πÅ‡∏≠‡∏•‡∏Å‡∏≠‡∏Æ‡∏≠‡∏•‡πå/‡∏ô‡πâ‡∏≥‡∏¢‡∏≤‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏≤‡∏ô', category: 'hygiene', baseQty: 1, unit: '‡∏Ç‡∏ß‡∏î', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['pandemic', 'general'], advice: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏∞‡∏≠‡∏≤‡∏î‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏¥‡∏ô‡∏Ç‡πâ‡∏≤‡∏ß' },

  // 6. ‡∏™‡∏±‡∏ï‡∏ß‡πå‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á
  { id: 'p1', name: '‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡∏™‡∏∏‡∏ô‡∏±‡∏Ç', category: 'pets', baseQty: 1, unit: '‡∏ñ‡∏∏‡∏á', isPerPerson: false, isPerDay: true, priority: 'high', disasterTags: ['all'], advice: '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÉ‡∏´‡πâ‡∏û‡∏≠‡∏î‡∏µ‡∏ß‡∏±‡∏ô + ‡πÄ‡∏ú‡∏∑‡πà‡∏≠ 3 ‡∏ß‡∏±‡∏ô' },
  { id: 'p2', name: '‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ä‡∏π‡∏ä‡∏µ‡∏û‡∏™‡∏∏‡∏ô‡∏±‡∏Ç', category: 'pets', baseQty: 1, unit: '‡∏ï‡∏±‡∏ß', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['flood'], advice: '‡∏ä‡πà‡∏ß‡∏¢‡∏û‡∏¢‡∏∏‡∏á‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÄ‡∏ß‡∏•‡∏≤‡∏Ç‡∏∂‡πâ‡∏ô‡∏•‡∏á‡πÄ‡∏£‡∏∑‡∏≠' },
  { id: 'p3', name: '‡πÅ‡∏ú‡πà‡∏ô‡∏£‡∏≠‡∏á‡∏â‡∏µ‡πà', category: 'pets', baseQty: 2, unit: '‡πÅ‡∏ú‡πà‡∏ô', isPerPerson: false, isPerDay: true, priority: 'medium', disasterTags: ['flood', 'general'], advice: '‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏û‡∏≤‡∏™‡∏∏‡∏ô‡∏±‡∏Ç‡πÑ‡∏õ‡∏Ç‡∏±‡∏ö‡∏ñ‡πà‡∏≤‡∏¢‡∏Ç‡πâ‡∏≤‡∏á‡∏ô‡∏≠‡∏Å‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ' },

  // 7. ‡∏Å‡∏≤‡∏£‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£
  { id: 'cm1', name: '‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠ + ‡∏™‡∏≤‡∏¢‡∏ä‡∏≤‡∏£‡πå‡∏à', category: 'comms', baseQty: 1, unit: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏≠‡∏õ Offline map ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô' },
  { id: 'cm2', name: '‡∏ß‡∏¥‡∏ó‡∏¢‡∏∏‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£ (Walkie Talkie)', category: 'comms', baseQty: 1, unit: '‡∏Ñ‡∏π‡πà', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['flood', 'civil_unrest'], advice: '‡πÉ‡∏ä‡πâ‡∏™‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏•‡πà‡∏°' },
  { id: 'cm3', name: 'iPad/Tablet', category: 'comms', baseQty: 1, unit: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', isPerPerson: false, isPerDay: false, priority: 'low', disasterTags: ['general'], advice: '‡πÉ‡∏ä‡πâ‡∏î‡∏π‡∏Ç‡πà‡∏≤‡∏ß‡∏™‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏à‡∏≠‡πÉ‡∏´‡∏ç‡πà' },

  // 8. ‡∏û‡∏•‡∏±‡∏á‡∏á‡∏≤‡∏ô
  { id: 'pw1', name: 'Power Bank', category: 'power', baseQty: 1, unit: '‡∏≠‡∏±‡∏ô', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡∏Ñ‡∏ß‡∏£‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏à‡∏∏ 20,000 mAh ‡∏Ç‡∏∂‡πâ‡∏ô‡πÑ‡∏õ' },
  { id: 'pw2', name: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏õ‡∏±‡πà‡∏ô‡πÑ‡∏ü/Power Station', category: 'power', baseQty: 1, unit: '‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['flood', 'general'], advice: '‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏ö‡∏û‡∏±‡∏î‡∏•‡∏°‡∏´‡∏£‡∏∑‡∏≠‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÑ‡∏ü‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÉ‡∏´‡∏ç‡πà' },
  { id: 'pw3', name: '‡πÑ‡∏ü‡∏â‡∏≤‡∏¢/‡πÑ‡∏ü‡∏™‡πâ‡∏°', category: 'power', baseQty: 2, unit: '‡∏î‡∏ß‡∏á', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['all'], advice: '‡πÑ‡∏ü‡∏™‡πâ‡∏°‡πÑ‡∏•‡πà‡πÅ‡∏°‡∏•‡∏á‡πÑ‡∏î‡πâ‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÑ‡∏ü‡∏Ç‡∏≤‡∏ß' },
  { id: 'pw4', name: '‡∏õ‡∏•‡∏±‡πä‡∏Å‡∏û‡πà‡∏ß‡∏á', category: 'power', baseQty: 1, unit: '‡∏≠‡∏±‡∏ô', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['general'], advice: '‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏∏‡∏î‡∏ä‡∏≤‡∏£‡πå‡∏à‡∏£‡∏ß‡∏°' },

  // 9. ‡∏û‡∏≤‡∏´‡∏ô‡∏∞
  { id: 'v1', name: '‡πÄ‡∏£‡∏∑‡∏≠‡πÑ‡∏ü‡πÄ‡∏ö‡∏≠‡∏£‡πå/‡πÄ‡∏£‡∏∑‡∏≠‡∏¢‡∏≤‡∏á', category: 'vehicle', baseQty: 1, unit: '‡∏•‡∏≥', isPerPerson: false, isPerDay: false, priority: 'high', disasterTags: ['flood'], advice: '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏¢‡∏£‡∏±‡πà‡∏ß‡πÅ‡∏•‡∏∞‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏ö‡∏•‡∏°' },

  // 10. ‡∏≠‡∏≤‡∏ß‡∏∏‡∏ò
  { id: 'w1', name: '‡∏°‡∏µ‡∏î‡∏û‡∏±‡∏ö/‡∏°‡∏µ‡∏î‡∏™‡∏õ‡∏£‡∏¥‡∏á', category: 'weapon', baseQty: 1, unit: '‡πÄ‡∏•‡πà‡∏°', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['civil_unrest', 'survival'], advice: '‡πÉ‡∏ä‡πâ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏î‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å' },
  { id: 'w2', name: '‡∏õ‡∏∑‡∏ô‡∏≠‡∏±‡∏î‡∏•‡∏°/‡∏õ‡∏£‡∏∞‡∏ó‡∏±‡∏î', category: 'weapon', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: false, isPerDay: false, priority: 'low', disasterTags: ['civil_unrest'], advice: '‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏•‡πà‡∏™‡∏±‡∏ï‡∏ß‡πå‡∏£‡πâ‡∏≤‡∏¢' },

  // 11. ‡∏≠‡∏∑‡πà‡∏ô‡πÜ
  { id: 'mi1', name: '‡πÄ‡∏ó‡∏õ‡∏Å‡∏≤‡∏ß (Duct Tape)', category: 'misc', baseQty: 1, unit: '‡∏°‡πâ‡∏ß‡∏ô', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['all'], advice: '‡∏ã‡πà‡∏≠‡∏°‡πÅ‡∏ã‡∏°‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô‡πÑ‡∏î‡πâ‡∏ó‡∏∏‡∏Å‡∏≠‡∏¢‡πà‡∏≤‡∏á' },
  { id: 'mi2', name: '‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤‡πÄ‡∏°‡∏à‡∏¥‡∏Å', category: 'misc', baseQty: 1, unit: '‡∏î‡πâ‡∏≤‡∏°', isPerPerson: false, isPerDay: false, priority: 'low', disasterTags: ['general'], advice: '‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏õ‡πâ‡∏≤‡∏¢‡∏Ç‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠' },

  // 12. ‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢ (Survival)
  { id: 's1', name: '‡∏ñ‡∏∏‡∏á‡∏ô‡∏≠‡∏ô/‡πÄ‡∏ï‡πá‡∏ô‡∏ó‡πå/‡∏ú‡πâ‡∏≤‡∏´‡πà‡∏°‡∏ü‡∏≠‡∏¢‡∏•‡πå', category: 'survival', baseQty: 1, unit: '‡∏ä‡∏∏‡∏î', isPerPerson: true, isPerDay: false, priority: 'medium', disasterTags: ['general'], advice: '‡∏£‡∏±‡∏Å‡∏©‡∏≤‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Ç‡∏ì‡∏∞‡∏ô‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏ö' },
  { id: 's2', name: '‡∏ô‡∏Å‡∏´‡∏ß‡∏µ‡∏î', category: 'survival', baseQty: 1, unit: '‡∏≠‡∏±‡∏ô', isPerPerson: true, isPerDay: false, priority: 'high', disasterTags: ['flood', 'earthquake'], advice: '‡πÄ‡∏õ‡πà‡∏≤ 3 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏™‡∏±‡πâ‡∏ô‡πÜ ‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì SOS' },
  { id: 's3', name: '‡πÄ‡∏ä‡∏∑‡∏≠‡∏Å/Paracord', category: 'survival', baseQty: 1, unit: '‡πÄ‡∏™‡πâ‡∏ô', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['flood'], advice: '‡πÉ‡∏ä‡πâ‡∏ú‡∏π‡∏Å‡πÄ‡∏£‡∏∑‡∏≠ ‡∏ï‡∏≤‡∏Å‡∏ú‡πâ‡∏≤ ‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏Ç‡∏≠‡∏á' },
  { id: 's4', name: '‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÄ‡∏≠‡∏ô‡∏Å‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå (Multi-tool)', category: 'survival', baseQty: 1, unit: '‡∏≠‡∏±‡∏ô', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['all'], advice: '‡∏°‡∏µ‡∏Ñ‡∏µ‡∏° ‡πÑ‡∏Ç‡∏Ñ‡∏ß‡∏á ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏¥‡∏î‡∏Ç‡∏ß‡∏î ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏î‡∏µ‡∏¢‡∏ß' },
  { id: 's5', name: '‡∏™‡πÄ‡∏õ‡∏£‡∏¢‡πå‡∏Å‡∏±‡∏ô‡πÅ‡∏°‡∏•‡∏á', category: 'survival', baseQty: 1, unit: '‡∏Ç‡∏ß‡∏î', isPerPerson: false, isPerDay: false, priority: 'medium', disasterTags: ['flood'], advice: '‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏¢‡∏∏‡∏á‡∏û‡∏≤‡∏´‡∏∞‡πÇ‡∏£‡∏Ñ' },
];

declare global {
  interface Window {
    html2pdf: any;
  }
}

// --- Shared Document Component (Used in Modal & Hidden Print Div) ---
const PrintableDocument = ({ 
  inventory, people, days, disaster, date, author 
}: { 
  inventory: Item[], people: number, days: number, disaster: any, date: string, author: string 
}) => {
  const totalItems = inventory.reduce((acc, cur) => acc + cur.calculatedQty, 0);
  const highPriorityItems = inventory.filter(i => i.priority === 'high' && i.calculatedQty > 0).length;

  return (
    <div className="bg-white text-black p-8 max-w-[210mm] mx-auto" style={{ width: '100%' }}>
      {/* Header */}
      <div className="border-b-2 border-black pb-4 mb-4">
        <div className="flex justify-between items-end">
          <div>
            <h1 className="text-3xl font-bold mb-2">‡πÅ‡∏ú‡∏ô‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏£‡∏±‡∏ö‡∏°‡∏∑‡∏≠‡∏†‡∏±‡∏¢‡∏û‡∏¥‡∏ö‡∏±‡∏ï‡∏¥</h1>
            <p className="text-sm text-gray-600 font-semibold uppercase tracking-wider">Disaster Survival Checklist</p>
          </div>
          <div className="text-right text-sm">
            <p>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏û‡∏¥‡∏°‡∏û‡πå: {date}</p>
            <p>‡∏à‡∏±‡∏î‡∏ó‡∏≥‡πÇ‡∏î‡∏¢: {author}</p>
          </div>
        </div>
      </div>

      {/* Summary Section */}
      <div className="mb-8 border border-gray-300 rounded-lg overflow-hidden">
        <div className="bg-gray-100 p-2 border-b border-gray-300 font-bold text-center text-gray-700 uppercase text-xs tracking-wide">
          ‡∏™‡∏£‡∏∏‡∏õ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç (Summary)
        </div>
        <div className="flex text-sm flex-wrap">
            <div className="flex-1 p-3 border-r border-gray-300 min-w-[100px]">
              <div className="text-xs text-gray-500 mb-1">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</div>
              <div className="font-bold text-lg">{disaster?.label}</div>
              <div className="mt-1 text-slate-600 font-medium">{people} ‡∏Ñ‡∏ô / {days} ‡∏ß‡∏±‡∏ô</div>
            </div>
            <div className="flex-1 p-3 border-r border-gray-300 bg-orange-50 min-w-[100px]">
              <div className="text-xs text-orange-500 mb-1">‡πÄ‡∏™‡∏ö‡∏µ‡∏¢‡∏á‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô</div>
              <div className="font-bold text-orange-800">üíß ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏° ~{people * 3 * days} ‡∏•‡∏¥‡∏ï‡∏£</div>
              <div className="font-bold text-orange-800">üç≤ ‡∏≠‡∏≤‡∏´‡∏≤‡∏£ ~{people * 3 * days} ‡∏°‡∏∑‡πâ‡∏≠</div>
            </div>
            <div className="flex-1 p-3 bg-red-50 min-w-[100px]">
              <div className="text-xs text-red-500 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏û‡∏£‡πâ‡∏≠‡∏°</div>
              <div className="font-bold text-red-800">‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: {totalItems} ‡∏ä‡∏¥‡πâ‡∏ô</div>
              <div className="text-xs font-bold text-red-600">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å: {highPriorityItems} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</div>
            </div>
        </div>
      </div>

      {/* Content */}
      <div className="space-y-6">
        {(Object.keys(CATEGORY_MAP) as Category[]).map((cat) => {
          const itemsInCategory = inventory.filter(i => i.category === cat);
          if (itemsInCategory.length === 0) return null;
          return (
            <div key={cat} className="break-inside-avoid">
              <h3 className={`font-bold text-lg mb-2 border-b pb-1 flex items-center gap-2 ${CATEGORY_MAP[cat].textColor}`}>{CATEGORY_MAP[cat].label}</h3>
              <table className="w-full text-sm text-left">
                <thead><tr className="text-gray-500 text-xs border-b"><th className="w-8 py-1">Check</th><th className="py-1">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</th><th className="w-16 py-1 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th><th className="w-32 py-1">‡πÄ‡∏Å‡πá‡∏ö‡πÑ‡∏ß‡πâ‡∏ó‡∏µ‡πà</th></tr></thead>
                <tbody>
                  {itemsInCategory.map(item => (
                    <tr key={item.id} className="border-b border-gray-100">
                      <td className="py-2 align-top">
                          {item.isChecked 
                            ? <div className="w-5 h-5 border border-black rounded-sm flex items-center justify-center bg-green-100 text-green-800 text-xs">‚úì</div>
                            : <div className="w-5 h-5 border border-gray-400 rounded-sm"></div>
                          }
                      </td>
                      <td className="py-2 pr-2 align-top">
                        <div className={`font-bold ${item.isChecked ? 'line-through text-gray-400' : 'text-gray-800'}`}>{item.name}</div>
                        {item.advice && <div className="text-[10px] text-gray-500 mt-0.5 leading-tight">{item.advice}</div>}
                      </td>
                      <td className="py-2 text-center font-bold align-top pt-2">{item.calculatedQty} <span className="text-[10px] font-normal text-gray-400 block">{item.unit}</span></td>
                      <td className="py-2 align-top"><div className="border-b border-gray-300 h-6 w-full mt-1"></div></td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          );
        })}
      </div>
      <div className="mt-8 pt-4 border-t-2 border-gray-300 text-center text-xs text-gray-400">Created by {author} | Generated on {date}</div>
    </div>
  );
};

// --- Helper Components ---
const EmergencyModal = ({ onClose }: { onClose: () => void }) => (
  <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto">
      <div className="p-6 border-b sticky top-0 bg-white z-10 flex justify-between items-center">
        <h2 className="text-2xl font-bold flex items-center gap-2 text-slate-800"><PhoneCall className="text-red-600" /> ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô & ‡πÄ‡∏ß‡πá‡∏ö‡πÑ‡∏ã‡∏ï‡πå‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</h2>
        <button onClick={onClose} className="p-2 hover:bg-slate-100 rounded-full transition"><X /></button>
      </div>
      <div className="p-6 space-y-6">
        <div>
          <h3 className="text-lg font-bold text-blue-800 mb-3 flex items-center gap-2"><MapPin className="w-5 h-5" /> ‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
            <ContactCard title="‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏´‡∏ï‡∏∏‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏†‡∏±‡∏¢ (‡∏õ‡∏†.)" number="02-382-6040" />
            <ContactCard title="‡∏°‡∏π‡∏•‡∏ô‡∏¥‡∏ò‡∏¥‡∏£‡πà‡∏ß‡∏°‡∏Å‡∏ï‡∏±‡∏ç‡∏ç‡∏π (‡∏ö‡∏≤‡∏á‡∏û‡∏•‡∏µ)" number="02-751-0951" />
            <ContactCard title="‡∏™‡∏™‡∏à. ‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£" number="02-389-5980" />
            <ContactCard title="‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏†‡∏π‡∏ò‡∏£‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î" number="02-390-2216" />
          </div>
        </div>
        <div>
          <h3 className="text-lg font-bold text-slate-700 mb-3">üìû ‡∏™‡∏≤‡∏¢‡∏î‡πà‡∏ß‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á</h3>
          <div className="grid grid-cols-2 md:grid-cols-4 gap-3">
            <ContactCard title="‡πÄ‡∏à‡πá‡∏ö‡∏õ‡πà‡∏ß‡∏¢‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô" number="1669" simple />
            <ContactCard title="‡πÄ‡∏´‡∏ï‡∏∏‡∏î‡πà‡∏ß‡∏ô‡πÄ‡∏´‡∏ï‡∏∏‡∏£‡πâ‡∏≤‡∏¢" number="191" simple />
            <ContactCard title="‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á/‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢" number="199" simple />
            <ContactCard title="‡∏ï‡∏≥‡∏£‡∏ß‡∏à‡∏ó‡πà‡∏≠‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏ß" number="1155" simple />
          </div>
        </div>
      </div>
    </div>
  </div>
);

const MapModal = ({ onClose }: { onClose: () => void }) => {
  const [coords, setCoords] = useState<{lat: number, lng: number} | null>(null);
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const getLocation = () => {
    setLoading(true); setError('');
    if (!navigator.geolocation) { setError('Browser ‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö Geolocation'); setLoading(false); return; }
    navigator.geolocation.getCurrentPosition(
      (pos) => { setCoords({ lat: pos.coords.latitude, lng: pos.coords.longitude }); setLoading(false); },
      (err) => { setError('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡πÑ‡∏î‡πâ: ' + err.message); setLoading(false); }
    );
  };
  const openGoogleMaps = () => {
    if (coords) window.open(`https://www.google.com/maps/search/rescue+unit/@${coords.lat},${coords.lng},13z`, '_blank');
    else window.open(`https://www.google.com/maps/search/rescue+unit+near+me`, '_blank');
  };
  return (
    <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-sm text-center p-6">
        <div className="flex justify-end"><button onClick={onClose}><X className="text-gray-400 hover:text-gray-800" /></button></div>
        <div className="mb-4 flex justify-center"><div className="bg-red-100 p-4 rounded-full"><Crosshair className="w-8 h-8 text-red-600" /></div></div>
        <h3 className="text-xl font-bold text-slate-800 mb-2">‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì & ‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á</h3>
        {coords && <div className="bg-slate-100 p-3 rounded-lg mb-4 text-sm font-mono text-slate-600">Lat: {coords.lat.toFixed(5)} <br/> Long: {coords.lng.toFixed(5)}</div>}
        {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
        <div className="space-y-3">
          {!coords && <button onClick={getLocation} disabled={loading} className="w-full bg-slate-800 text-white py-3 rounded-xl font-bold hover:bg-slate-900 transition flex items-center justify-center gap-2">{loading ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤...' : <><Navigation className="w-4 h-4" /> ‡∏Å‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏£‡∏∞‡∏ö‡∏∏‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏â‡∏±‡∏ô</>}</button>}
          <button onClick={openGoogleMaps} className={`w-full py-3 rounded-xl font-bold border-2 flex items-center justify-center gap-2 transition ${coords ? 'bg-red-600 text-white border-red-600 hover:bg-red-700' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}><MapPin className="w-4 h-4" /> ‡πÄ‡∏õ‡∏¥‡∏î‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢</button>
        </div>
      </div>
    </div>
  );
};

const AddItemModal = ({ onClose, onAdd }: { onClose: () => void, onAdd: (item: Item) => void }) => {
  const [formData, setFormData] = useState<Partial<Item>>({ name: '', category: 'misc', baseQty: 1, unit: '‡∏ä‡∏¥‡πâ‡∏ô', isPerPerson: true, isPerDay: false, advice: '', priority: 'medium', disasterTags: ['all'], isChecked: false });
  const handleSubmit = (e: React.FormEvent) => { e.preventDefault(); if (!formData.name) return; onAdd({ ...formData as Item, id: `custom_${Date.now()}` }); onClose(); };
  return (
    <div className="fixed inset-0 z-[100] bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg">
        <div className="p-6 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl"><h2 className="text-xl font-bold text-slate-800 flex items-center gap-2"><PlusCircle className="text-green-600" /> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡∏°‡πà</h2><button onClick={onClose} className="p-2 hover:bg-slate-200 rounded-full transition"><X /></button></div>
        <form onSubmit={handleSubmit} className="p-6 space-y-4">
          <div><label className="block text-sm font-semibold text-slate-700 mb-1">‡∏ä‡∏∑‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</label><input required autoFocus className="w-full p-2 border border-slate-300 rounded-lg outline-none" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏¢‡∏≤‡∏Ü‡πà‡∏≤‡πÄ‡∏ä‡∏∑‡πâ‡∏≠..." value={formData.name} onChange={e => setFormData({...formData, name: e.target.value})} /></div>
          <div className="grid grid-cols-2 gap-4">
            <div><label className="block text-sm font-semibold text-slate-700 mb-1">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label><select className="w-full p-2 border border-slate-300 rounded-lg outline-none" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value as Category})}>{(Object.keys(CATEGORY_MAP) as Category[]).map(cat => (<option key={cat} value={cat}>{CATEGORY_MAP[cat].label}</option>))}</select></div>
            <div><label className="block text-sm font-semibold text-slate-700 mb-1">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</label><select className="w-full p-2 border border-slate-300 rounded-lg outline-none" value={formData.priority} onChange={e => setFormData({...formData, priority: e.target.value as any})}><option value="high">‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏°‡∏≤‡∏Å</option><option value="medium">‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á</option><option value="low">‡πÄ‡∏ú‡∏∑‡πà‡∏≠‡πÑ‡∏ß‡πâ</option></select></div>
          </div>
          <button type="submit" className="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl shadow-lg transition active:scale-95">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</button>
        </form>
      </div>
    </div>
  );
};

// --- PREVIEW MODAL (NEW) ---
const PreviewModal = ({ 
  onClose, 
  onSave, 
  isSaving,
  inventory, 
  people, 
  days,
  disaster,
  date,
  author
}: any) => {
  return (
    <div className="fixed inset-0 z-[100] bg-black/70 backdrop-blur-sm flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-slate-100 rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden">
        {/* Header */}
        <div className="bg-slate-900 text-white p-4 flex justify-between items-center">
          <div className="flex items-center gap-2">
            <Eye className="w-5 h-5 text-blue-400" />
            <h2 className="font-bold text-lg">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£ (Document Preview)</h2>
          </div>
          <button onClick={onClose} className="p-2 hover:bg-slate-800 rounded-full transition"><X /></button>
        </div>

        {/* Preview Content Area (Scrollable) */}
        <div className="flex-1 overflow-y-auto p-4 md:p-8 bg-gray-200 flex justify-center">
          <div className="shadow-xl">
             {/* Re-use the PrintableDocument component for visual consistency */}
             <PrintableDocument 
               inventory={inventory}
               people={people}
               days={days}
               disaster={disaster}
               date={date}
               author={author}
             />
          </div>
        </div>

        {/* Footer Actions */}
        <div className="bg-white border-t p-4 flex justify-end gap-3 items-center">
          <span className="text-xs text-gray-400 mr-auto hidden md:inline">‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</span>
          <button onClick={onClose} className="px-6 py-2.5 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition border border-slate-200">
            ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç
          </button>
          <button 
            onClick={onSave} 
            disabled={isSaving}
            className="bg-green-600 hover:bg-green-700 text-white px-6 py-2.5 rounded-lg font-bold shadow-lg shadow-green-200 flex items-center gap-2 transition active:scale-95 disabled:opacity-50"
          >
            {isSaving ? <Loader2 className="w-4 h-4 animate-spin" /> : <FileDown className="w-4 h-4" />}
            Download PDF
          </button>
        </div>
      </div>
    </div>
  );
};

const ContactCard = ({ title, number, simple }: { title: string, number: string, simple?: boolean }) => (
  <div className={`p-3 rounded-lg border border-slate-200 flex flex-col justify-center ${simple ? 'bg-slate-50 text-center' : 'bg-white'}`}>
    <div className="text-sm text-slate-500 mb-1">{title}</div>
    <a href={`tel:${number}`} className="text-xl font-bold text-slate-800 hover:text-red-600 transition">{number}</a>
  </div>
);

// --- Main Component ---
export default function SurvivalAppV9() {
  const [people, setPeople] = useState(3);
  const [days, setDays] = useState(3);
  const [disaster, setDisaster] = useState('flood');
  const [activeTab, setActiveTab] = useState<Category | 'all'>('all');
  const [inventory, setInventory] = useState<Item[]>(INITIAL_DB);
  const [expandedItem, setExpandedItem] = useState<string | null>(null);
  
  // States
  const [showEmergency, setShowEmergency] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showMapModal, setShowMapModal] = useState(false);
  const [showPreviewModal, setShowPreviewModal] = useState(false); // New state for preview
  const [currentDate, setCurrentDate] = useState('');
  const [isPrinting, setIsPrinting] = useState(false);

  useEffect(() => {
    setCurrentDate(new Date().toLocaleDateString('th-TH', { year: 'numeric', month: 'long', day: 'numeric' }));
    const script = document.createElement('script');
    script.src = "https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js";
    script.async = true;
    document.body.appendChild(script);
    return () => { document.body.removeChild(script); }
  }, []);

  const calculatedInventory = useMemo(() => {
    return inventory.map(item => {
      let qty = item.baseQty;
      if (item.isPerPerson) qty *= people;
      if (item.isPerDay) qty *= days;
      let relevanceScore = 1;
      if (item.disasterTags.includes('all')) relevanceScore = 2;
      if (item.disasterTags.includes(disaster)) relevanceScore = 3;
      return { ...item, calculatedQty: Math.ceil(qty), relevanceScore };
    }).sort((a, b) => b.relevanceScore - a.relevanceScore);
  }, [people, days, disaster, inventory]);

  const filteredInventory = useMemo(() => {
    if (activeTab === 'all') return calculatedInventory;
    return calculatedInventory.filter(i => i.category === activeTab);
  }, [activeTab, calculatedInventory]);

  const updateQuantity = (id: string, delta: number) => {
    setInventory(prev => prev.map(item => item.id === id ? { ...item, baseQty: Math.max(0, item.baseQty + delta) } : item));
  };

  const toggleCheck = (id: string) => {
    setInventory(prev => prev.map(item => item.id === id ? { ...item, isChecked: !item.isChecked } : item));
  };

  const handleAddItem = (newItem: Item) => setInventory(prev => [newItem, ...prev]);
  
  // Revised Save Logic (triggered from Preview Modal)
  const handleSavePDF = async () => {
    setIsPrinting(true);
    // Use a small timeout to allow UI update
    setTimeout(async () => {
      // We can grab the content from the modal itself or the hidden print div
      // Using the hidden print div is safer for layout consistency
      const element = document.getElementById('print-content');
      
      if (typeof window.html2pdf !== 'undefined' && element) {
        try {
          const opt = {
            margin: 0.2,
            filename: `Survival_Plan_${new Date().toISOString().split('T')[0]}.pdf`,
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 2, useCORS: true, logging: false },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
          };
          await window.html2pdf().set(opt).from(element).save();
          setIsPrinting(false);
          setShowPreviewModal(false); // Close modal after save
        } catch (e) {
          console.error("PDF generation failed", e);
          window.print();
          setIsPrinting(false);
        }
      } else {
        window.print();
        setIsPrinting(false);
      }
    }, 500);
  };

  const selectedDisaster = DISASTER_TYPES.find(d => d.id === disaster);

  return (
    <div className="min-h-screen bg-slate-50 text-gray-800 font-sans">
      <style>{`
        @media print { 
          @page { margin: 0.5cm; size: A4; } 
          body { -webkit-print-color-adjust: exact; print-color-adjust: exact; } 
          .no-print { display: none !important; }
          .print-only { display: block !important; }
        }
      `}</style>

      {/* --- Modals --- */}
      {showEmergency && <EmergencyModal onClose={() => setShowEmergency(false)} />}
      {showAddModal && <AddItemModal onClose={() => setShowAddModal(false)} onAdd={handleAddItem} />}
      {showMapModal && <MapModal onClose={() => setShowMapModal(false)} />}
      
      {/* PREVIEW MODAL */}
      {showPreviewModal && (
        <PreviewModal 
          onClose={() => setShowPreviewModal(false)}
          onSave={handleSavePDF}
          isSaving={isPrinting}
          inventory={calculatedInventory}
          people={people}
          days={days}
          disaster={selectedDisaster}
          date={currentDate}
          author={APP_INFO.author}
        />
      )}

      {/* --- SCREEN VIEW --- */}
      <div className="no-print">
        {/* Top Bar */}
        <div className="bg-slate-900 text-slate-300 py-2 px-6 text-xs flex justify-between items-center">
          <span>{currentDate} - ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß</span>
          <div className="flex gap-4"><span>‡∏™‡∏°‡∏∏‡∏ó‡∏£‡∏õ‡∏£‡∏≤‡∏Å‡∏≤‡∏£, ‡∏õ‡∏£‡∏∞‡πÄ‡∏ó‡∏®‡πÑ‡∏ó‡∏¢</span></div>
        </div>

        <header className="bg-white border-b border-slate-200 sticky top-0 z-40 shadow-sm">
          <div className="max-w-5xl mx-auto p-4 md:p-6">
            <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
              <div>
                <h1 className="text-3xl font-black text-slate-800 flex items-center gap-3">
                  <div className="bg-red-600 text-white p-2 rounded-lg"><Shield className="w-6 h-6" /></div>
                  Disaster Planner
                </h1>
                <p className="text-slate-500 mt-1 text-xs md:text-sm">Created by <span className="font-bold text-slate-700">{APP_INFO.author}</span> (v{APP_INFO.version})</p>
              </div>

              <div className="flex flex-wrap gap-2">
                 <button onClick={() => setShowMapModal(true)} className="bg-orange-500 hover:bg-orange-600 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-orange-200 flex items-center gap-2 transition active:scale-95 text-sm md:text-base"><Navigation className="w-4 h-4" /> <span className="hidden md:inline">‡∏û‡∏¥‡∏Å‡∏±‡∏î &</span> ‡∏Å‡∏π‡πâ‡∏†‡∏±‡∏¢</button>
                 <button onClick={() => setShowEmergency(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-blue-200 flex items-center gap-2 transition active:scale-95 text-sm md:text-base"><PhoneCall className="w-4 h-4" /> ‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</button>
                 <button onClick={() => setShowAddModal(true)} className="bg-green-600 hover:bg-green-700 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-green-200 flex items-center gap-2 transition active:scale-95 text-sm md:text-base"><PlusCircle className="w-4 h-4" /> <span className="hidden md:inline">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£</span></button>
                <button 
                  onClick={() => setShowPreviewModal(true)} 
                  className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2.5 rounded-lg font-bold shadow-lg shadow-slate-300 flex items-center gap-2 transition active:scale-95 text-sm md:text-base"
                >
                  <Eye className="w-4 h-4" /> ‡∏™‡∏£‡∏∏‡∏õ & ‡∏û‡∏¥‡∏°‡∏û‡πå
                </button>
              </div>
            </div>

            {/* Controls Panel */}
            <div className="bg-slate-100 rounded-2xl p-4 grid grid-cols-1 md:grid-cols-3 gap-4 border border-slate-200">
              <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</label>
                <div className="flex items-center gap-3"><div className="bg-blue-100 p-2 rounded-lg text-blue-600"><Users className="w-5 h-5" /></div><input type="number" min="1" value={people} onChange={(e) => setPeople(parseInt(e.target.value) || 1)} className="w-full font-bold text-xl text-slate-700 outline-none" /><span className="text-sm text-slate-400 font-medium">‡∏Ñ‡∏ô</span></div>
              </div>
              <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</label>
                <div className="flex items-center gap-3"><div className="bg-orange-100 p-2 rounded-lg text-orange-600"><Calendar className="w-5 h-5" /></div><input type="number" min="1" value={days} onChange={(e) => setDays(parseInt(e.target.value) || 1)} className="w-full font-bold text-xl text-slate-700 outline-none" /><span className="text-sm text-slate-400 font-medium">‡∏ß‡∏±‡∏ô</span></div>
              </div>
              <div className="bg-white p-3 rounded-xl border border-slate-200 shadow-sm relative group">
                <label className="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1 block">‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå</label>
                <div className="flex items-center gap-2"><div className="bg-red-100 p-2 rounded-lg text-red-600"><AlertTriangle className="w-5 h-5" /></div><select value={disaster} onChange={(e) => setDisaster(e.target.value)} className="w-full font-bold text-slate-700 outline-none bg-transparent appearance-none cursor-pointer z-10">{DISASTER_TYPES.map(d => (<option key={d.id} value={d.id}>{d.label}</option>))}</select><ChevronDown className="absolute right-4 text-slate-400 pointer-events-none" /></div>
              </div>
            </div>
          </div>
        </header>

        <main className="max-w-5xl mx-auto p-4 md:p-6 pb-24">
          <div className="flex flex-wrap gap-2 mb-6 justify-center md:justify-start">
            <button onClick={() => setActiveTab('all')} className={`px-5 py-2.5 rounded-xl font-bold text-sm transition-all duration-300 shadow-sm ${activeTab === 'all' ? 'bg-slate-800 text-white shadow-lg scale-105' : 'bg-white text-slate-600 hover:bg-slate-50 border border-slate-200'}`}>‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
            {(Object.keys(CATEGORY_MAP) as Category[]).map((cat) => {
              const isActive = activeTab === cat;
              const style = CATEGORY_MAP[cat];
              return (
                <button key={cat} onClick={() => setActiveTab(cat)} className={`px-4 py-2.5 rounded-xl font-bold text-sm transition-all duration-300 flex items-center gap-2 border ${isActive ? `bg-gradient-to-r ${style.fromColor} ${style.toColor} text-white shadow-lg scale-105 border-transparent` : 'bg-white text-slate-600 hover:bg-slate-50 border-slate-200 grayscale hover:grayscale-0'}`}>
                  {style.icon} <span className="hidden md:inline">{style.label}</span>
                </button>
              );
            })}
          </div>

          <div className="space-y-3">
            {filteredInventory.map((item) => {
              const isRelevant = item.disasterTags.includes(disaster) || item.disasterTags.includes('all');
              const isExpanded = expandedItem === item.id;
              const categoryStyle = CATEGORY_MAP[item.category];

              return (
                <div key={item.id} className={`bg-white rounded-2xl shadow-sm border transition-all duration-200 overflow-hidden ${isRelevant ? 'border-l-8 border-l-red-500 ring-1 ring-red-100' : 'border-slate-100 opacity-90 hover:opacity-100'} ${item.isChecked ? 'bg-green-50 ring-1 ring-green-200' : ''}`}>
                  <div className="p-4 flex items-center gap-4">
                    <button onClick={() => toggleCheck(item.id)} className="shrink-0 text-gray-400 hover:text-green-500 transition">
                      {item.isChecked ? <CheckCircle2 className="w-6 h-6 text-green-500" /> : <Square className="w-6 h-6" />}
                    </button>
                    <div className={`w-14 h-14 rounded-2xl flex items-center justify-center shrink-0 bg-gradient-to-br ${categoryStyle.fromColor} ${categoryStyle.toColor} text-white shadow-md`}>{categoryStyle.icon}</div>
                    <div className="flex-1 min-w-0">
                      <div className="flex items-center gap-2 mb-1">
                        <h3 className={`font-bold text-lg truncate ${item.isChecked ? 'text-green-800 line-through decoration-slate-400' : 'text-slate-800'}`}>{item.name}</h3>
                        {isRelevant && !item.isChecked && <span className="px-2 py-0.5 bg-red-50 text-red-600 text-[10px] rounded-full font-bold border border-red-100 tracking-wide uppercase">Priority</span>}
                      </div>
                      <p className="text-xs md:text-sm text-slate-500 font-medium">{item.isPerPerson ? '‡∏ï‡πà‡∏≠‡∏Ñ‡∏ô' : '‡∏™‡πà‡∏ß‡∏ô‡∏Å‡∏•‡∏≤‡∏á'} {item.isPerDay && ' ‚Ä¢ ‡∏ï‡πà‡∏≠‡∏ß‡∏±‡∏ô'} {' '}| ‡∏ê‡∏≤‡∏ô: {item.baseQty} {item.unit}</p>
                    </div>
                    <div className="flex items-center gap-1 md:gap-3 bg-slate-50 rounded-xl p-1.5 border border-slate-100">
                      <button onClick={() => updateQuantity(item.id, -0.5)} className="w-8 h-8 flex items-center justify-center rounded-lg bg-white shadow-sm hover:bg-red-50 text-slate-600 hover:text-red-500 transition active:scale-90"><Minus className="w-4 h-4" /></button>
                      <div className="text-center min-w-[3rem]"><span className="block font-black text-xl text-slate-800 leading-none">{item.calculatedQty}</span><span className="text-[10px] text-slate-400 font-bold">{item.unit}</span></div>
                      <button onClick={() => updateQuantity(item.id, 0.5)} className="w-8 h-8 flex items-center justify-center rounded-lg bg-white shadow-sm hover:bg-green-50 text-slate-600 hover:text-green-500 transition active:scale-90"><Plus className="w-4 h-4" /></button>
                    </div>
                    <button onClick={() => setExpandedItem(isExpanded ? null : item.id)} className={`p-2 rounded-full transition ${isExpanded ? 'bg-slate-100 text-slate-800' : 'text-slate-300 hover:text-slate-500'}`}>{isExpanded ? <ChevronUp /> : <ChevronDown />}</button>
                  </div>
                  {isExpanded && (
                    <div className="bg-slate-50 p-4 border-t border-slate-100 animate-in slide-in-from-top-1">
                      <div className="flex gap-3">
                        <div className="mt-1"><Info className="w-5 h-5 text-blue-500" /></div>
                        <div><h4 className="font-bold text-slate-700 text-sm mb-1">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ú‡∏π‡πâ‡πÄ‡∏ä‡∏µ‡πà‡∏¢‡∏ß‡∏ä‡∏≤‡∏ç:</h4><p className="text-slate-600 text-sm leading-relaxed">{item.advice}</p></div>
                      </div>
                    </div>
                  )}
                </div>
              );
            })}
          </div>
          <div className="mt-8 text-center text-slate-400 text-sm">Created by <span className="font-bold">{APP_INFO.author}</span> (v{APP_INFO.version}) | {APP_INFO.createdDate}</div>
        </main>
      </div>

      {/* --- PRINT CONTENT (Hidden, used by html2pdf) --- */}
      {/* We keep this hidden block as the source of truth for PDF generation to ensure clean styling regardless of screen state */}
      <div 
        id="print-content" 
        className="fixed top-0 left-0 z-[-1] pointer-events-none opacity-0"
        style={{ width: '210mm', minHeight: '297mm' }}
      >
         <PrintableDocument 
           inventory={calculatedInventory}
           people={people}
           days={days}
           disaster={selectedDisaster}
           date={currentDate}
           author={APP_INFO.author}
         />
      </div>
    </div>
  );
}