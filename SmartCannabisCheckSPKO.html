import React, { useState, useEffect, useMemo, useRef } from 'react';
import { MapPin, Phone, Navigation, Store, Map as MapIcon, Info, ExternalLink, Upload, FileText, CheckCircle, Plus, Trash2, Map, ClipboardList, Save, Calendar, AlertCircle, Check, XCircle, LayoutDashboard, Search, Menu, User, Briefcase, Printer, ChevronRight, X } from 'lucide-react';

// ข้อมูลตัวอย่างเริ่มต้น
const INITIAL_DATA = [
  { id: 1, license: "1136700021", name: "ลูกาโน (Lugano)", address: "111/4 หมู่ 1 เทศบาลบางปู50", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "061 594 5550", coords: [13.56784, 100.60754] },
  { id: 2, license: "สป-3-182/2566", name: "บริษัท โกรว์โทเปีย จำกัด", address: "111/4 หมู่ 1", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10270", phone: "0 2254 4117-9", coords: [13.5676028, 100.6074972] },
  { id: 3, license: "สป-3-185/2566", name: "สเตเบิ้ล (STABLE)", address: "699/596 หมู่ 6 เทศบาลบางปู 23", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "08 3700 3703", coords: [13.563114, 100.588425] },
  { id: 4, license: "สป-03-10/2565", name: "วิซวีด (Wiz weed)", address: "99/306 หมู่ 4", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "-", coords: [13.565, 100.600] },
  { id: 324, license: "สป-3-228/2567", name: "บริษัท ครีม เจเนติคส์ จำกัด", address: "246/42, 246/43 หมู่ 4", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "0 2719 6633, 08 1903 8918", coords: [13.557966663370504, 100.80374636767935] },
  { id: 325, license: "สป-3-231/2567", name: "แอคเธรา (ACTERA)", address: "122/58 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "02 077 5459", coords: [13.5452780, 100.7770280] },
  { id: 326, license: "สป-3-237/2567", name: "เลิฟ เลิฟ", address: "235/3 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "0 95 902 6983", coords: [13.544897076547626, 100.78932378547727] },
  { id: 327, license: "สป-3-277/2567", name: "บริษัท คานา ออสตราเลเซีย พีทีวาย จำกัด", address: "122/32 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "-", coords: [13.546, 100.778] },
];

export default function ShopFinderApp() {
  const [activeTab, setActiveTab] = useState('dashboard');
  const [shops, setShops] = useState(INITIAL_DATA);
  const [isDataLoaded, setIsDataLoaded] = useState(false);
  const fileInputRef = useRef(null);

  // --- Search Mode State ---
  const [selectedDistrict, setSelectedDistrict] = useState('');
  const [selectedShopId, setSelectedShopId] = useState('');

  // --- Route Mode State ---
  const [routeDistrict, setRouteDistrict] = useState('');
  const [routeShopId, setRouteShopId] = useState('');
  const [routeList, setRouteList] = useState([]);

  // --- Inspection Mode State ---
  const [inspectDistrict, setInspectDistrict] = useState('');
  const [inspectShopId, setInspectShopId] = useState('');
  const [inspectionRecords, setInspectionRecords] = useState([]);
  
  // Inspection Form State
  const [formDate, setFormDate] = useState(new Date().toISOString().substr(0, 10));
  const [inspectorName, setInspectorName] = useState(''); // ชื่อผู้ตรวจ
  const [inspectorPosition, setInspectorPosition] = useState(''); // ตำแหน่ง
  const [formStatus, setFormStatus] = useState('pass');
  const [formNote, setFormNote] = useState('');
  
  // Report Modal State
  const [showReportModal, setShowReportModal] = useState(false);
  const [reportData, setReportData] = useState(null);

  const [checklist, setChecklist] = useState({
    item1: 'have', item2: 'have', item3: 'have', item4: 'have', item5: 'have'
  });

  const [checklistPart2, setChecklistPart2] = useState({
    item1: 'found', item2: 'found', item3: 'not_found', item4: 'not_found',
    item5: 'not_found', item6: 'not_found', item7: 'not_found',
  });
  
  // Helper: Get Unique Districts
  const districts = useMemo(() => {
    return [...new Set(shops.map(shop => shop.district))].sort();
  }, [shops]);

  // Helpers: Filter Shops
  const filteredShops = useMemo(() => {
    if (!selectedDistrict) return [];
    return shops.filter(shop => shop.district === selectedDistrict);
  }, [selectedDistrict, shops]);

  const routeFilteredShops = useMemo(() => {
    if (!routeDistrict) return [];
    return shops.filter(shop => shop.district === routeDistrict);
  }, [routeDistrict, shops]);

  const inspectFilteredShops = useMemo(() => {
    if (!inspectDistrict) return [];
    return shops.filter(shop => shop.district === inspectDistrict);
  }, [inspectDistrict, shops]);

  const selectedShop = useMemo(() => shops.find(shop => shop.id.toString() === selectedShopId), [selectedShopId, shops]);
  const routeSelectedShopToAdd = useMemo(() => shops.find(shop => shop.id.toString() === routeShopId), [routeShopId, shops]);
  const inspectSelectedShop = useMemo(() => shops.find(shop => shop.id.toString() === inspectShopId), [inspectShopId, shops]);

  // Shop specific history
  const currentShopHistory = useMemo(() => {
    if(!inspectShopId) return [];
    return inspectionRecords.filter(r => r.shopId.toString() === inspectShopId.toString()).sort((a,b) => b.id - a.id);
  }, [inspectShopId, inspectionRecords]);

  // --- CSV Import ---
  const handleFileUpload = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
      try {
        const text = e.target.result;
        const lines = text.split(/\r?\n/);
        const newShops = [];
        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;
          const columns = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
          if (columns.length < 10) continue;
          
          let coords = [13.5991, 100.5968];
          const rawCoords = columns[12] || "";
          if (rawCoords) {
             const parts = rawCoords.split(',');
             if (parts.length >= 2) {
               const lat = parseFloat(parts[0]);
               const lng = parseFloat(parts[1]);
               if (!isNaN(lat) && !isNaN(lng)) coords = [lat, lng];
             }
          }
          newShops.push({
            id: columns[0] || i,
            license: columns[1] || "-",
            name: columns[2] || "ไม่ระบุชื่อ",
            address: `${columns[3]} ${columns[4] && columns[4] !== '-' ? 'หมู่ '+columns[4] : ''} ${columns[5] && columns[5] !== '-' ? 'ซ.'+columns[5] : ''} ${columns[6] && columns[6] !== '-' ? 'ถ.'+columns[6] : ''}`,
            subDistrict: columns[7],
            district: columns[8],
            province: columns[9],
            zip: columns[10],
            phone: columns[11] || "-",
            coords: coords
          });
        }
        if (newShops.length > 0) {
          setShops(newShops);
          setIsDataLoaded(true);
          setInspectionRecords([]); // Reset inspections on new data import
          alert(`✅ นำเข้าข้อมูลสำเร็จ!\n- พบข้อมูลทั้งหมด: ${newShops.length} รายการ`);
        }
      } catch (error) {
        alert('❌ เกิดข้อผิดพลาดในการอ่านไฟล์ CSV');
      }
    };
    reader.readAsText(file);
  };

  // --- Logic Handlers ---
  const addToRoute = () => {
    if (routeSelectedShopToAdd && !routeList.some(item => item.id === routeSelectedShopToAdd.id)) {
      setRouteList([...routeList, routeSelectedShopToAdd]);
      setRouteShopId('');
    }
  };

  const calculatePart2Result = (itemKey, value) => ['item1', 'item2'].includes(itemKey) ? value === 'found' : value === 'not_found';

  const saveInspection = () => {
    if (!inspectSelectedShop) return;
    if (!inspectorName) { alert("กรุณาระบุชื่อผู้ตรวจ"); return; }

    const score1 = Object.values(checklist).filter(v => v === 'have').length;
    let score2 = 0;
    Object.entries(checklistPart2).forEach(([key, value]) => { if (calculatePart2Result(key, value)) score2++; });
    
    const newRecord = {
      id: Date.now(),
      shopId: inspectSelectedShop.id,
      shopName: inspectSelectedShop.name,
      license: inspectSelectedShop.license, // Added license
      address: inspectSelectedShop.address, // Added address details for report
      subDistrict: inspectSelectedShop.subDistrict,
      district: inspectSelectedShop.district,
      province: inspectSelectedShop.province,
      date: formDate,
      inspector: inspectorName,
      position: inspectorPosition,
      status: formStatus,
      checklist: { ...checklist },
      checklistPart2: { ...checklistPart2 },
      scorePart1: score1,
      scorePart2: score2,
      note: formNote
    };
    setInspectionRecords([newRecord, ...inspectionRecords]);
    setFormNote('');
    
    // Open Report Modal immediately
    setReportData(newRecord);
    setShowReportModal(true);
  };

  const openReport = (record) => {
    setReportData(record);
    setShowReportModal(true);
  };

  // --- Stats Calculation ---
  const stats = useMemo(() => {
      const totalShops = shops.length;
      const inspectedShopIds = new Set(inspectionRecords.map(r => r.shopId));
      const inspectedCount = inspectedShopIds.size;
      const passCount = inspectionRecords.filter(r => r.status === 'pass').length;
      const warnCount = inspectionRecords.filter(r => r.status === 'warn').length;
      const failCount = inspectionRecords.filter(r => r.status === 'fail').length;

      // District Breakdown
      const districtStats = districts.map(district => {
         const shopsInDistrict = shops.filter(s => s.district === district);
         const recordsInDistrict = inspectionRecords.filter(r => r.district === district);
         const inspectedInDistrict = new Set(recordsInDistrict.map(r => r.shopId)).size;
         
         return {
            name: district,
            total: shopsInDistrict.length,
            inspected: inspectedInDistrict,
            pass: recordsInDistrict.filter(r => r.status === 'pass').length,
            warn: recordsInDistrict.filter(r => r.status === 'warn').length,
            fail: recordsInDistrict.filter(r => r.status === 'fail').length,
         };
      });

      return { totalShops, inspectedCount, passCount, warnCount, failCount, districtStats };
  }, [shops, inspectionRecords, districts]);

  // --- Map ---
  let mapCenterShop = null;
  if (activeTab === 'search') mapCenterShop = selectedShop;
  else if (activeTab === 'route') mapCenterShop = routeList.length > 0 ? routeList[routeList.length - 1] : null;
  else if (activeTab === 'inspection') mapCenterShop = inspectSelectedShop;

  const getMapEmbedUrl = (lat, lng) => {
    const diff = 0.005; 
    return `https://www.openstreetmap.org/export/embed.html?bbox=${lng-diff},${lat-diff},${lng+diff},${lat+diff}&layer=mapnik&marker=${lat},${lng}`;
  };

  const handlePrint = () => {
    window.print();
  };

  return (
    <div className="min-h-screen bg-gray-50 flex flex-col font-sans text-gray-800 pb-20 lg:pb-0">
      
      {/* Print Styles */}
      <style>{`
        @media print {
          body * {
            visibility: hidden;
          }
          #printable-report, #printable-report * {
            visibility: visible;
          }
          #printable-report {
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 20px;
            background: white;
            z-index: 9999;
          }
          .no-print {
            display: none !important;
          }
        }
      `}</style>

      {/* Header (Hidden in Print) */}
      <header className="bg-green-600 text-white p-4 shadow-lg sticky top-0 z-50 no-print">
        <div className="container mx-auto flex items-center justify-between">
          <div className="flex items-center gap-2">
            <Store className="h-9 w-9" />
            <div>
              <div className="flex items-center gap-2">
                 <h1 className="text-xl font-bold">Smart Cannabis Check</h1>
                 <span className="bg-green-700 text-green-100 text-[10px] px-2 py-0.5 rounded-full font-medium shadow-sm border border-green-500">v1.0 (ทดลองใช้)</span>
              </div>
              <p className="text-xs text-green-100">ระบบตรวจสอบร้านกัญชา สมุทรปราการ</p>
              <p className="text-[10px] text-green-200 mt-0.5 opacity-90">ผู้จัดทำ: Jeerapat</p>
            </div>
          </div>
        </div>
      </header>

      <main className="flex-grow container mx-auto p-4 flex flex-col lg:flex-row gap-6 no-print">
        
        {/* Left Column */}
        <div className="w-full lg:w-1/3 flex flex-col gap-4 order-2 lg:order-1">
          
          {/* Data Import */}
          <div className={`p-3 rounded-xl border flex items-center justify-between ${isDataLoaded ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-100'}`}>
             <div className="flex items-center gap-2">
                <FileText className={`h-4 w-4 ${isDataLoaded ? 'text-green-600' : 'text-blue-600'}`} />
                <div>
                   <span className="text-xs font-bold block">{isDataLoaded ? 'ฐานข้อมูลพร้อม' : 'ข้อมูลตัวอย่าง'}</span>
                   <span className="text-[10px] text-gray-500">{shops.length} ร้านค้า</span>
                </div>
             </div>
             <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
             <button onClick={() => fileInputRef.current.click()} className="bg-white hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs border shadow-sm flex items-center gap-1">
                <Upload className="h-3 w-3" /> นำเข้า
             </button>
          </div>

          {/* Desktop Tabs */}
          <div className="hidden lg:flex bg-gray-200 p-1 rounded-xl">
            {['dashboard', 'search', 'route', 'inspection'].map(tab => (
              <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 text-xs font-bold rounded-lg gap-1 transition-all flex flex-col items-center ${activeTab === tab ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500'}`}>
                 {tab === 'dashboard' && <LayoutDashboard className="h-4 w-4" />}
                 {tab === 'search' && <Search className="h-4 w-4" />}
                 {tab === 'route' && <Map className="h-4 w-4" />}
                 {tab === 'inspection' && <ClipboardList className="h-4 w-4" />}
                 {tab === 'dashboard' ? 'ภาพรวม' : tab === 'search' ? 'ค้นหา' : tab === 'route' ? 'วางแผน' : 'ตรวจ'}
              </button>
            ))}
          </div>

          {/* --- DASHBOARD MODE --- */}
          {activeTab === 'dashboard' && (
              <div className="animate-fade-in space-y-4">
                  <div className="grid grid-cols-2 gap-3">
                      <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                          <span className="text-3xl font-bold text-gray-800">{stats.totalShops}</span>
                          <span className="text-xs text-gray-500 block">ร้านทั้งหมด</span>
                      </div>
                      <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                          <span className="text-3xl font-bold text-blue-600">{stats.inspectedCount}</span>
                          <span className="text-xs text-gray-500 block">ตรวจแล้ว</span>
                      </div>
                  </div>

                  {/* District Breakdown with Bar Chart */}
                  <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100 overflow-hidden">
                      <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                        <LayoutDashboard className="h-4 w-4"/> ฐานข้อมูลร้านค้าแยกรายอำเภอ
                      </h3>
                      <div className="space-y-3">
                        {stats.districtStats.map((d) => {
                           const percentage = stats.totalShops > 0 ? (d.total / stats.totalShops) * 100 : 0;
                           return (
                             <div key={d.name} className="text-xs">
                                <div className="flex justify-between mb-1">
                                  <span className="font-medium text-gray-700">{d.name}</span>
                                  <span className="text-gray-500">{d.total} ร้าน</span>
                                </div>
                                <div className="w-full bg-gray-100 rounded-full h-2.5">
                                  <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${percentage}%` }}></div>
                                </div>
                                <div className="flex justify-end gap-2 mt-1 text-[10px] text-gray-400">
                                   <span>ตรวจแล้ว {d.inspected}</span>
                                </div>
                             </div>
                           )
                        })}
                      </div>
                  </div>

                  {/* Recent Inspections List */}
                  <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                     <h3 className="text-sm font-bold text-gray-700 mb-2">ประวัติการตรวจล่าสุด</h3>
                     <div className="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar">
                        {inspectionRecords.length === 0 ? (
                           <p className="text-xs text-gray-400 text-center py-4">ยังไม่มีข้อมูลการตรวจ</p>
                        ) : (
                           inspectionRecords.slice(0, 5).map(r => (
                              <div key={r.id} className="text-xs border-b border-gray-100 pb-2 mb-2 flex justify-between items-center group">
                                 <div>
                                   <div className="flex gap-2 font-bold text-gray-700">
                                      <span>{r.shopName}</span>
                                   </div>
                                   <div className="text-gray-500 mt-1">
                                       <span>{r.date} โดย {r.inspector}</span>
                                   </div>
                                 </div>
                                 <button onClick={() => openReport(r)} className="text-blue-600 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition-colors">
                                    <Printer className="h-4 w-4" />
                                 </button>
                              </div>
                           ))
                        )}
                     </div>
                  </div>
              </div>
          )}

          {/* --- SEARCH MODE --- */}
          {activeTab === 'search' && (
            <div className="animate-fade-in space-y-4">
              <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                <h2 className="text-md font-semibold mb-4 text-green-800">ค้นหาข้อมูลร้านค้า</h2>
                <div className="mb-3">
                  <label className="text-xs font-semibold text-gray-500 uppercase">อำเภอ</label>
                  <select value={selectedDistrict} onChange={(e) => { setSelectedDistrict(e.target.value); setSelectedShopId(''); }} className="w-full mt-1 p-3 border rounded-lg text-sm">
                    <option value="">-- เลือกอำเภอ --</option>
                    {districts.map(d => <option key={d} value={d}>{d}</option>)}
                  </select>
                </div>
                <div>
                  <label className="text-xs font-semibold text-gray-500 uppercase">ร้านค้า</label>
                  <select value={selectedShopId} onChange={(e) => setSelectedShopId(e.target.value)} disabled={!selectedDistrict} className="w-full mt-1 p-3 border rounded-lg text-sm disabled:bg-gray-100">
                    <option value="">-- เลือกร้านค้า ({filteredShops.length}) --</option>
                    {filteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                  </select>
                </div>
              </div>
              {selectedShop && (
                <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500">
                  <h3 className="text-lg font-bold text-gray-800">{selectedShop.name}</h3>
                  <div className="text-sm text-gray-600 mt-3 space-y-2">
                    <p>{selectedShop.address} {selectedShop.subDistrict} {selectedShop.district}</p>
                    <div className="flex items-center gap-2"><Phone className="h-4 w-4 text-green-600" /> {selectedShop.phone}</div>
                    <div className="flex items-center gap-2"><Info className="h-4 w-4 text-green-600" /> {selectedShop.license}</div>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* --- ROUTE MODE --- */}
          {activeTab === 'route' && (
            <div className="animate-fade-in space-y-4">
              <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                <h2 className="text-md font-semibold mb-4 text-blue-800">เพิ่มจุดแวะพัก</h2>
                <div className="flex flex-col gap-3">
                   <select value={routeDistrict} onChange={(e) => { setRouteDistrict(e.target.value); setRouteShopId(''); }} className="w-full p-3 border rounded-lg text-sm"><option value="">เลือกอำเภอ</option>{districts.map(d => <option key={d} value={d}>{d}</option>)}</select>
                   <select value={routeShopId} onChange={(e) => setRouteShopId(e.target.value)} disabled={!routeDistrict} className="w-full p-3 border rounded-lg text-sm disabled:bg-gray-100"><option value="">เลือกร้าน</option>{routeFilteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                   <button onClick={addToRoute} disabled={!routeShopId} className="w-full bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 text-sm font-medium"><Plus className="h-4 w-4" /> เพิ่ม</button>
                </div>
              </div>
              <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                <div className="flex justify-between mb-3"><h2 className="text-md font-semibold">รายการ ({routeList.length})</h2>{routeList.length > 0 && <button onClick={() => setRouteList([])} className="text-xs text-red-500">ล้าง</button>}</div>
                <div className="space-y-2 max-h-[200px] overflow-y-auto">{routeList.map((shop, i) => (<div key={i} className="flex justify-between bg-blue-50 p-2 rounded text-sm"><span>{i+1}. {shop.name}</span><button onClick={() => setRouteList(routeList.filter(item => item.id !== shop.id))}><Trash2 className="h-3 w-3 text-red-500"/></button></div>))}</div>
                <button onClick={() => window.open(`https://www.google.com/maps/dir/${routeList.map(s => `${s.coords[0]},${s.coords[1]}`).join('/')}`, '_blank')} disabled={!routeList.length} className="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold flex justify-center gap-2"><Navigation className="h-4 w-4"/> นำทาง</button>
              </div>
            </div>
          )}

          {/* --- INSPECTION MODE --- */}
          {activeTab === 'inspection' && (
             <div className="animate-fade-in space-y-4">
                <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                  <h2 className="text-md font-semibold mb-4 text-orange-800 flex items-center gap-2"><ClipboardList className="h-5 w-5" /> บันทึกผลการตรวจ</h2>
                  
                  {/* Shop Select */}
                  <div className="grid grid-cols-2 gap-2 mb-4">
                    <select value={inspectDistrict} onChange={(e) => { setInspectDistrict(e.target.value); setInspectShopId(''); }} className="p-2 border rounded text-sm"><option value="">เลือกอำเภอ</option>{districts.map(d => <option key={d} value={d}>{d}</option>)}</select>
                    <select value={inspectShopId} onChange={(e) => setInspectShopId(e.target.value)} disabled={!inspectDistrict} className="p-2 border rounded text-sm"><option value="">เลือกร้าน</option>{inspectFilteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                  </div>

                  {/* Inspector Info */}
                  <div className="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4 space-y-3">
                      <h3 className="text-xs font-bold text-orange-800 uppercase">ข้อมูลผู้ตรวจ</h3>
                      <div className="grid grid-cols-2 gap-3">
                          <div>
                              <label className="text-xs text-gray-500 block mb-1">ชื่อผู้ตรวจ</label>
                              <div className="relative">
                                  <User className="absolute left-2 top-2 h-4 w-4 text-gray-400" />
                                  <input type="text" value={inspectorName} onChange={(e) => setInspectorName(e.target.value)} placeholder="ระบุชื่อ" className="w-full pl-8 p-2 border rounded text-sm focus:ring-1 focus:ring-orange-500 outline-none" />
                              </div>
                          </div>
                          <div>
                              <label className="text-xs text-gray-500 block mb-1">ตำแหน่ง</label>
                              <div className="relative">
                                  <Briefcase className="absolute left-2 top-2 h-4 w-4 text-gray-400" />
                                  <input type="text" value={inspectorPosition} onChange={(e) => setInspectorPosition(e.target.value)} placeholder="ระบุตำแหน่ง" className="w-full pl-8 p-2 border rounded text-sm focus:ring-1 focus:ring-orange-500 outline-none" />
                              </div>
                          </div>
                      </div>
                      <div>
                          <label className="text-xs text-gray-500 block mb-1">วันที่ตรวจ</label>
                          <div className="relative">
                             <Calendar className="absolute left-2 top-2 h-4 w-4 text-gray-400" />
                             <input type="date" value={formDate} onChange={(e) => setFormDate(e.target.value)} className="w-full pl-8 p-2 border rounded text-sm focus:ring-1 focus:ring-orange-500 outline-none bg-white" />
                          </div>
                      </div>
                  </div>

                  {/* Checklists */}
                  <div className="space-y-2 mb-4">
                     <div className="border rounded p-2">
                        <div className="text-xs font-bold mb-2">ส่วนที่ 1: ลักษณะร้าน</div>
                        <div className="space-y-1">
                            {[{id:'item1',l:'1. ป้ายชัดเจน'},{id:'item2',l:'2. มีเคาท์เตอร์'},{id:'item3',l:'3. แยกสัดส่วน'},{id:'item4',l:'4. ถูกสุขลักษณะ'},{id:'item5',l:'5. ป้ายเตือน'}].map(i=>(
                                <div key={i.id} className="flex justify-between text-xs"><span className="text-gray-600">{i.l}</span><input type="checkbox" checked={checklist[i.id]==='have'} onChange={()=>setChecklist({...checklist, [i.id]: checklist[i.id]==='have'?'not_have':'have'})} className="accent-green-600"/></div>
                            ))}
                        </div>
                     </div>
                     <div className="border rounded p-2 bg-blue-50">
                        <div className="text-xs font-bold mb-2">ส่วนที่ 2: การปฏิบัติ (ติ๊กหากพบ/ทำ)</div>
                        <div className="space-y-1">
                            {[{id:'item1',l:'1. มีใบอนุญาต (ต้องมี)'},{id:'item2',l:'2. ข้อมูลแหล่งที่มา (ต้องมี)'},{id:'item3',l:'3. ขายเด็กต่ำกว่า 20 (ห้าม)'},{id:'item4',l:'4. ให้สูบในร้าน (ห้าม)'}].map(i=>(
                                <div key={i.id} className="flex justify-between text-xs"><span className="text-gray-600">{i.l}</span><input type="checkbox" checked={checklistPart2[i.id]==='found'} onChange={()=>setChecklistPart2({...checklistPart2, [i.id]: checklistPart2[i.id]==='found'?'not_found':'found'})} className="accent-blue-600"/></div>
                            ))}
                        </div>
                     </div>
                  </div>

                  <div className="grid grid-cols-3 gap-2 mb-3">
                        {['pass', 'warn', 'fail'].map(s => (
                            <label key={s} className={`p-2 rounded border text-center text-xs font-bold cursor-pointer ${formStatus===s ? (s==='pass'?'bg-green-100 border-green-500 text-green-700':s==='warn'?'bg-yellow-100 border-yellow-500 text-yellow-700':'bg-red-100 border-red-500 text-red-700') : 'bg-gray-50'}`}>
                                <input type="radio" name="status" value={s} checked={formStatus===s} onChange={(e)=>setFormStatus(e.target.value)} className="hidden"/>{s==='pass'?'ผ่าน':s==='warn'?'ตักเตือน':'ไม่ผ่าน'}
                            </label>
                        ))}
                  </div>

                  <button onClick={saveInspection} disabled={!inspectShopId} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-orange-700">บันทึกผล</button>
                  
                  {/* Shop Inspection History Section */}
                  {inspectShopId && currentShopHistory.length > 0 && (
                     <div className="mt-6 border-t pt-4">
                       <h3 className="text-sm font-bold text-gray-700 mb-3">ประวัติการตรวจร้านนี้ ({currentShopHistory.length})</h3>
                       <div className="space-y-2">
                         {currentShopHistory.map(r => (
                           <div key={r.id} className="bg-gray-50 p-3 rounded-lg border flex justify-between items-center text-xs">
                              <div>
                                 <div className="font-bold">{r.date}</div>
                                 <div className={`mt-0.5 ${r.status==='pass'?'text-green-600':r.status==='warn'?'text-yellow-600':'text-red-600'}`}>
                                    ผล: {r.status==='pass'?'ผ่าน':r.status==='warn'?'ตักเตือน':'ไม่ผ่าน'} (โดย {r.inspector})
                                 </div>
                              </div>
                              <button onClick={() => openReport(r)} className="bg-white border p-1.5 rounded hover:bg-gray-100 text-blue-600 flex items-center gap-1">
                                 <Printer className="h-4 w-4"/> พิมพ์
                              </button>
                           </div>
                         ))}
                       </div>
                     </div>
                  )}

                </div>
             </div>
          )}
        </div>

        {/* Right Column: Map */}
        <div className="w-full lg:w-2/3 h-[400px] lg:h-auto min-h-[500px] bg-gray-200 rounded-xl overflow-hidden shadow-inner border border-gray-300 relative z-0 flex flex-col order-1 lg:order-2 no-print">
           <iframe width="100%" height="100%" frameBorder="0" src={mapCenterShop ? getMapEmbedUrl(mapCenterShop.coords[0], mapCenterShop.coords[1]) : `https://www.openstreetmap.org/export/embed.html?bbox=100.5,13.5,100.7,13.7&layer=mapnik`} className="flex-grow"></iframe>
        </div>

        {/* Mobile Nav */}
        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-2 flex lg:hidden justify-around z-[100] pb-safe no-print">
            {['dashboard','search','route','inspection'].map(t => <button key={t} onClick={()=>setActiveTab(t)} className={`flex flex-col items-center p-2 ${activeTab===t?'text-green-600':'text-gray-400'}`}>{t==='dashboard'?<LayoutDashboard/>:t==='search'?<Search/>:t==='route'?<Map/>:<ClipboardList/>}<span className="text-[10px]">{t}</span></button>)}
        </div>

      </main>

      {/* --- REPORT MODAL (For PDF Export) --- */}
      {showReportModal && reportData && (
        <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
           <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative flex flex-col">
              
              {/* Toolbar */}
              <div className="p-4 border-b flex justify-between items-center bg-gray-50 no-print rounded-t-lg sticky top-0">
                 <h2 className="font-bold text-gray-800 flex items-center gap-2"><FileText className="h-5 w-5"/> ตัวอย่างรายงานผลการตรวจ</h2>
                 <div className="flex gap-2">
                    <button onClick={handlePrint} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-700">
                      <Printer className="h-4 w-4"/> พิมพ์ / บันทึก PDF
                    </button>
                    <button onClick={() => setShowReportModal(false)} className="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300">
                      <X className="h-5 w-5"/>
                    </button>
                 </div>
              </div>

              {/* Printable Content (A4 Style) */}
              <div id="printable-report" className="p-8 bg-white text-black font-serif">
                 
                 {/* Header */}
                 <div className="text-center border-b-2 border-black pb-4 mb-6">
                    <h1 className="text-2xl font-bold mb-1">แบบบันทึกผลการตรวจสอบร้านกัญชา</h1>
                    <p className="text-lg">สำนักงานสาธารณสุขจังหวัดสมุทรปราการ</p>
                 </div>

                 {/* Shop Info */}
                 <div className="mb-6 grid grid-cols-2 gap-4 text-sm">
                    <div>
                       <p><span className="font-bold">ชื่อสถานประกอบการ:</span> {reportData.shopName}</p>
                       <p><span className="font-bold">เลขที่ใบอนุญาต:</span> {reportData.license || '-'}</p>
                       <p><span className="font-bold">ที่อยู่:</span> {reportData.address}, {reportData.subDistrict}, {reportData.district}, {reportData.province}</p>
                    </div>
                    <div className="text-right">
                       <p><span className="font-bold">วันที่ตรวจ:</span> {reportData.date}</p>
                       <p><span className="font-bold">รหัสอ้างอิง:</span> {reportData.id}</p>
                    </div>
                 </div>

                 {/* Inspector Info */}
                 <div className="mb-6 bg-gray-50 p-3 border border-gray-200 text-sm">
                    <p><span className="font-bold">ผู้ตรวจสอบ:</span> {reportData.inspector} <span className="mx-2">|</span> <span className="font-bold">ตำแหน่ง:</span> {reportData.position}</p>
                 </div>

                 {/* Results Table */}
                 <div className="mb-6">
                    <h3 className="font-bold text-lg mb-2 border-b">1. ลักษณะสถานประกอบการ</h3>
                    <table className="w-full text-sm mb-4 border-collapse border border-gray-300">
                       <thead>
                          <tr className="bg-gray-100">
                             <th className="border p-2 text-left">หัวข้อตรวจสอบ</th>
                             <th className="border p-2 text-center w-24">ผล</th>
                          </tr>
                       </thead>
                       <tbody>
                          {[{id:'item1',l:'1. ป้ายสถานประกอบการชัดเจน'},{id:'item2',l:'2. มีเคาท์เตอร์และที่พักคอย'},{id:'item3',l:'3. มีการแยกสัดส่วนชัดเจน'},{id:'item4',l:'4. พื้นที่/อุปกรณ์ ถูกสุขลักษณะ'},{id:'item5',l:'5. มีป้ายแสดงข้อความเตือน'}].map(i => (
                             <tr key={i.id}>
                                <td className="border p-2">{i.l}</td>
                                <td className="border p-2 text-center">
                                   {reportData.checklist[i.id] === 'have' ? <span className="text-green-600 font-bold">✓ มี</span> : <span className="text-red-600">✗ ไม่มี</span>}
                                </td>
                             </tr>
                          ))}
                       </tbody>
                    </table>

                    <h3 className="font-bold text-lg mb-2 border-b">2. การปฏิบัติการตามเงื่อนไข</h3>
                    <table className="w-full text-sm border-collapse border border-gray-300">
                       <thead>
                          <tr className="bg-gray-100">
                             <th className="border p-2 text-left">หัวข้อตรวจสอบ</th>
                             <th className="border p-2 text-center w-24">ผล</th>
                          </tr>
                       </thead>
                       <tbody>
                          {[{id:'item1',l:'1. แสดงใบอนุญาตด้านหน้าชัดเจน (ต้องพบ)'},{id:'item2',l:'2. จัดทำข้อมูลแหล่งที่มา (ต้องพบ)'},{id:'item3',l:'3. จำหน่ายให้อายุต่ำกว่า 20 ปี (ห้ามพบ)'},{id:'item4',l:'4. ให้สูบในสถานประกอบการ (ห้ามพบ)'}].map(i => {
                             const isPass = ['item1', 'item2'].includes(i.id) 
                                ? reportData.checklistPart2[i.id] === 'found'
                                : reportData.checklistPart2[i.id] === 'not_found';
                             const valText = reportData.checklistPart2[i.id] === 'found' ? 'พบ' : 'ไม่พบ';
                             return (
                               <tr key={i.id}>
                                  <td className="border p-2">{i.l}</td>
                                  <td className="border p-2 text-center">
                                     {isPass ? <span className="text-green-600 font-bold">✓ ผ่าน</span> : <span className="text-red-600 font-bold">✗ ไม่ผ่าน</span>}
                                     <span className="text-xs text-gray-500 block">({valText})</span>
                                  </td>
                               </tr>
                             )
                          })}
                       </tbody>
                    </table>
                 </div>

                 {/* Summary Box */}
                 <div className={`p-4 border-2 rounded-lg mb-6 text-center ${
                    reportData.status === 'pass' ? 'border-green-500 bg-green-50' : 
                    reportData.status === 'warn' ? 'border-yellow-500 bg-yellow-50' : 'border-red-500 bg-red-50'
                 }`}>
                    <h2 className="text-xl font-bold">ผลการประเมินสรุป: 
                       <span className={`ml-2 ${
                          reportData.status === 'pass' ? 'text-green-700' : 
                          reportData.status === 'warn' ? 'text-yellow-700' : 'text-red-700'
                       }`}>
                          {reportData.status === 'pass' ? 'ผ่านเกณฑ์' : reportData.status === 'warn' ? 'ตักเตือน' : 'ไม่ผ่านเกณฑ์'}
                       </span>
                    </h2>
                 </div>

                 {/* Note */}
                 {reportData.note && (
                    <div className="mb-8 border p-3 rounded bg-gray-50 text-sm">
                       <p className="font-bold mb-1">หมายเหตุ / ข้อแนะนำเพิ่มเติม:</p>
                       <p>{reportData.note}</p>
                    </div>
                 )}

                 {/* Signature Section */}
                 <div className="grid grid-cols-2 gap-8 mt-12 pt-8">
                    <div className="text-center">
                       <div className="border-b border-black mb-2 h-8"></div>
                       <p>( {reportData.shopName} )</p>
                       <p className="text-sm">ผู้รับการตรวจ / ผู้ประกอบการ</p>
                    </div>
                    <div className="text-center">
                       <div className="border-b border-black mb-2 h-8"></div>
                       <p>( {reportData.inspector} )</p>
                       <p className="text-sm">{reportData.position || 'เจ้าหน้าที่ผู้ตรวจ'}</p>
                    </div>
                 </div>

              </div>
           </div>
        </div>
      )}

    </div>
  );
}