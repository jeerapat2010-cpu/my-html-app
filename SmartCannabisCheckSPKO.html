<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Cannabis Check - Samut Prakan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap');
        
        body {
            font-family: 'Sarabun', sans-serif;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }

        .animate-fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media print {
            body * { visibility: hidden; }
            #printable-report, #printable-report * { visibility: visible; }
            #printable-report {
                position: fixed; left: 0; top: 0; width: 100%; height: 100%;
                margin: 0; padding: 0; background: white; z-index: 9999;
                font-family: 'Sarabun', serif; color: black;
            }
            .no-print { display: none !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;

        // --- ICON COMPONENTS (INLINE TO FIX ERRORS) ---
        const IconBase = ({ children, className, ...props }) => (
            <svg 
                xmlns="http://www.w3.org/2000/svg" 
                width="24" height="24" 
                viewBox="0 0 24 24" 
                fill="none" 
                stroke="currentColor" 
                strokeWidth="2" 
                strokeLinecap="round" 
                strokeLinejoin="round" 
                className={className} 
                {...props}
            >
                {children}
            </svg>
        );

        const MapPin = (props) => <IconBase {...props}><path d="M20 10c0 6-8 12-8 12s-8-6-8-12a8 8 0 0 1 16 0Z"/><circle cx="12" cy="10" r="3"/></IconBase>;
        const Phone = (props) => <IconBase {...props}><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"/></IconBase>;
        const Navigation = (props) => <IconBase {...props}><polygon points="3 11 22 2 13 21 11 13 3 11"/></IconBase>;
        const Store = (props) => <IconBase {...props}><path d="m2 7 4.41-4.41A2 2 0 0 1 7.83 2h8.34a2 2 0 0 1 1.42.59L22 7"/><path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"/><path d="M15 22v-4a2 2 0 0 0-2-2h-2a2 2 0 0 0-2 2v4"/><path d="M2 7h20"/><path d="M22 7v3a2 2 0 0 1-2 2v0a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 16 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 12 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 8 12a2.7 2.7 0 0 1-1.59-.63.7.7 0 0 0-.82 0A2.7 2.7 0 0 1 4 12v0a2 2 0 0 1-2-2V7"/></IconBase>;
        const MapIcon = (props) => <IconBase {...props}><polygon points="3 6 9 3 15 6 21 3 21 21 15 18 9 21 3 18"/><line x1="9" x2="9" y1="3" y2="21"/><line x1="15" x2="15" y1="6" y2="21"/></IconBase>;
        const Info = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></IconBase>;
        const ExternalLink = (props) => <IconBase {...props}><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" x2="21" y1="14" y2="3"/></IconBase>;
        const Upload = (props) => <IconBase {...props}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" x2="12" y1="3" y2="15"/></IconBase>;
        const FileText = (props) => <IconBase {...props}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><line x1="16" x2="8" y1="13" y2="13"/><line x1="16" x2="8" y1="17" y2="17"/><line x1="10" x2="8" y1="9" y2="9"/></IconBase>;
        const CheckCircle = (props) => <IconBase {...props}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></IconBase>;
        const Plus = (props) => <IconBase {...props}><path d="M5 12h14"/><path d="M12 5v14"/></IconBase>;
        const Trash2 = (props) => <IconBase {...props}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></IconBase>;
        const ClipboardList = (props) => <IconBase {...props}><rect width="8" height="4" x="8" y="2" rx="1" ry="1"/><path d="M16 4h2a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h2"/><path d="M12 11h4"/><path d="M12 16h4"/><path d="M8 11h.01"/><path d="M8 16h.01"/></IconBase>;
        const Save = (props) => <IconBase {...props}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></IconBase>;
        const Calendar = (props) => <IconBase {...props}><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></IconBase>;
        const AlertCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><line x1="12" x2="12" y1="8" y2="12"/><line x1="12" x2="12.01" y1="16" y2="16"/></IconBase>;
        const Check = (props) => <IconBase {...props}><polyline points="20 6 9 17 4 12"/></IconBase>;
        const XCircle = (props) => <IconBase {...props}><circle cx="12" cy="12" r="10"/><path d="m15 9-6 6"/><path d="m9 9 6 6"/></IconBase>;
        const LayoutDashboard = (props) => <IconBase {...props}><rect width="7" height="9" x="3" y="3" rx="1"/><rect width="7" height="5" x="14" y="3" rx="1"/><rect width="7" height="9" x="14" y="12" rx="1"/><rect width="7" height="5" x="3" y="16" rx="1"/></IconBase>;
        const Search = (props) => <IconBase {...props}><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></IconBase>;
        const Menu = (props) => <IconBase {...props}><line x1="4" x2="20" y1="12" y2="12"/><line x1="4" x2="20" y1="6" y2="6"/><line x1="4" x2="20" y1="18" y2="18"/></IconBase>;
        const User = (props) => <IconBase {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></IconBase>;
        const Briefcase = (props) => <IconBase {...props}><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></IconBase>;
        const Printer = (props) => <IconBase {...props}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect width="12" height="8" x="6" y="14"/></IconBase>;
        const ChevronRight = (props) => <IconBase {...props}><path d="m9 18 6-6-6-6"/></IconBase>;
        const X = (props) => <IconBase {...props}><path d="M18 6 6 18"/><path d="m6 6 18 12"/></IconBase>;

        // ข้อมูลตัวอย่างเริ่มต้น
        const INITIAL_DATA = [
            { id: 1, license: "1136700021", name: "ลูกาโน (Lugano)", address: "111/4 หมู่ 1 เทศบาลบางปู50", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "061 594 5550", coords: [13.56784, 100.60754] },
            { id: 2, license: "สป-3-182/2566", name: "บริษัท โกรว์โทเปีย จำกัด", address: "111/4 หมู่ 1", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10270", phone: "0 2254 4117-9", coords: [13.5676028, 100.6074972] },
            { id: 3, license: "สป-3-185/2566", name: "สเตเบิ้ล (STABLE)", address: "699/596 หมู่ 6 เทศบาลบางปู 23", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "08 3700 3703", coords: [13.563114, 100.588425] },
            { id: 4, license: "สป-03-10/2565", name: "วิซวีด (Wiz weed)", address: "99/306 หมู่ 4", subDistrict: "ท้ายบ้าน", district: "เมืองสมุทรปราการ", province: "สมุทรปราการ", zip: "10280", phone: "-", coords: [13.565, 100.600] },
            { id: 324, license: "สป-3-228/2567", name: "บริษัท ครีม เจเนติคส์ จำกัด", address: "246/42, 246/43 หมู่ 4", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "0 2719 6633, 08 1903 8918", coords: [13.557966663370504, 100.80374636767935] },
            { id: 325, license: "สป-3-231/2567", name: "แอคเธรา (ACTERA)", address: "122/58 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "02 077 5459", coords: [13.5452780, 100.7770280] },
            { id: 326, license: "สป-3-237/2567", name: "เลิฟ เลิฟ", address: "235/3 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "0 95 902 6983", coords: [13.544897076547626, 100.78932378547727] },
            { id: 327, license: "สป-3-277/2567", name: "บริษัท คานา ออสตราเลเซีย พีทีวาย จำกัด", address: "122/32 หมู่ 6", subDistrict: "บางเพรียง", district: "บางบ่อ", province: "สมุทรปราการ", zip: "10560", phone: "-", coords: [13.546, 100.778] },
        ];

        function ShopFinderApp() {
            const [activeTab, setActiveTab] = useState('dashboard');
            const [shops, setShops] = useState(INITIAL_DATA);
            const [isDataLoaded, setIsDataLoaded] = useState(false);
            const fileInputRef = useRef(null);

            // Search State
            const [selectedDistrict, setSelectedDistrict] = useState('');
            const [selectedShopId, setSelectedShopId] = useState('');

            // Route State
            const [routeDistrict, setRouteDistrict] = useState('');
            const [routeShopId, setRouteShopId] = useState('');
            const [routeList, setRouteList] = useState([]);

            // Inspection State
            const [inspectDistrict, setInspectDistrict] = useState('');
            const [inspectShopId, setInspectShopId] = useState('');
            const [inspectionRecords, setInspectionRecords] = useState([]);
            
            // Form State
            const [formDate, setFormDate] = useState(new Date().toISOString().substr(0, 10));
            const [inspectorName, setInspectorName] = useState('');
            const [inspectorPosition, setInspectorPosition] = useState('');
            const [formStatus, setFormStatus] = useState('pass');
            const [formNote, setFormNote] = useState('');
            
            // Report Modal
            const [showReportModal, setShowReportModal] = useState(false);
            const [reportData, setReportData] = useState(null);

            // Checklists
            const [checklist, setChecklist] = useState({
                item1: 'have', item2: 'have', item3: 'have', item4: 'have', item5: 'have'
            });

            const [checklistPart2, setChecklistPart2] = useState({
                item1: 'found', item2: 'found', item3: 'not_found', item4: 'not_found',
                item5: 'not_found', item6: 'not_found', item7: 'not_found',
            });
            
            // Computed Values
            const districts = useMemo(() => [...new Set(shops.map(shop => shop.district))].sort(), [shops]);

            const filteredShops = useMemo(() => {
                if (!selectedDistrict) return [];
                return shops.filter(shop => shop.district === selectedDistrict);
            }, [selectedDistrict, shops]);

            const routeFilteredShops = useMemo(() => {
                if (!routeDistrict) return [];
                return shops.filter(shop => shop.district === routeDistrict);
            }, [routeDistrict, shops]);

            const inspectFilteredShops = useMemo(() => {
                if (!inspectDistrict) return [];
                return shops.filter(shop => shop.district === inspectDistrict);
            }, [inspectDistrict, shops]);

            const selectedShop = useMemo(() => shops.find(shop => shop.id.toString() === selectedShopId), [selectedShopId, shops]);
            const routeSelectedShopToAdd = useMemo(() => shops.find(shop => shop.id.toString() === routeShopId), [routeShopId, shops]);
            const inspectSelectedShop = useMemo(() => shops.find(shop => shop.id.toString() === inspectShopId), [inspectShopId, shops]);

            const currentShopHistory = useMemo(() => {
                if(!inspectShopId) return [];
                return inspectionRecords.filter(r => r.shopId.toString() === inspectShopId.toString()).sort((a,b) => b.id - a.id);
            }, [inspectShopId, inspectionRecords]);

            // Handlers
            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const text = e.target.result;
                        const lines = text.split(/\r?\n/);
                        const newShops = [];
                        for (let i = 1; i < lines.length; i++) {
                            const line = lines[i].trim();
                            if (!line) continue;
                            const columns = line.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(s => s.trim().replace(/^"|"$/g, ''));
                            if (columns.length < 10) continue;
                            
                            let coords = [13.5991, 100.5968];
                            const rawCoords = columns[12] || "";
                            if (rawCoords) {
                                const parts = rawCoords.split(',');
                                if (parts.length >= 2) {
                                    const lat = parseFloat(parts[0]);
                                    const lng = parseFloat(parts[1]);
                                    if (!isNaN(lat) && !isNaN(lng)) coords = [lat, lng];
                                }
                            }
                            newShops.push({
                                id: columns[0] || i,
                                license: columns[1] || "-",
                                name: columns[2] || "ไม่ระบุชื่อ",
                                address: `${columns[3]} ${columns[4] && columns[4] !== '-' ? 'หมู่ '+columns[4] : ''} ${columns[5] && columns[5] !== '-' ? 'ซ.'+columns[5] : ''} ${columns[6] && columns[6] !== '-' ? 'ถ.'+columns[6] : ''}`,
                                subDistrict: columns[7],
                                district: columns[8],
                                province: columns[9],
                                zip: columns[10],
                                phone: columns[11] || "-",
                                coords: coords
                            });
                        }
                        if (newShops.length > 0) {
                            setShops(newShops);
                            setIsDataLoaded(true);
                            setInspectionRecords([]); 
                            alert(`✅ นำเข้าข้อมูลสำเร็จ!\n- พบข้อมูลทั้งหมด: ${newShops.length} รายการ`);
                        }
                    } catch (error) {
                        alert('❌ เกิดข้อผิดพลาดในการอ่านไฟล์ CSV');
                    }
                };
                reader.readAsText(file);
            };

            const addToRoute = () => {
                if (routeSelectedShopToAdd && !routeList.some(item => item.id === routeSelectedShopToAdd.id)) {
                    setRouteList([...routeList, routeSelectedShopToAdd]);
                    setRouteShopId('');
                }
            };

            const calculatePart2Result = (itemKey, value) => ['item1', 'item2'].includes(itemKey) ? value === 'found' : value === 'not_found';

            const saveInspection = () => {
                if (!inspectSelectedShop) return;
                if (!inspectorName) { alert("กรุณาระบุชื่อผู้ตรวจ"); return; }

                const score1 = Object.values(checklist).filter(v => v === 'have').length;
                let score2 = 0;
                Object.entries(checklistPart2).forEach(([key, value]) => { if (calculatePart2Result(key, value)) score2++; });
                
                const newRecord = {
                    id: Date.now(),
                    shopId: inspectSelectedShop.id,
                    shopName: inspectSelectedShop.name,
                    license: inspectSelectedShop.license,
                    address: inspectSelectedShop.address,
                    subDistrict: inspectSelectedShop.subDistrict,
                    district: inspectSelectedShop.district,
                    province: inspectSelectedShop.province,
                    date: formDate,
                    inspector: inspectorName,
                    position: inspectorPosition,
                    status: formStatus,
                    checklist: { ...checklist },
                    checklistPart2: { ...checklistPart2 },
                    scorePart1: score1,
                    scorePart2: score2,
                    note: formNote
                };
                setInspectionRecords([newRecord, ...inspectionRecords]);
                setFormNote('');
                
                setReportData(newRecord);
                setShowReportModal(true);
            };

            const openReport = (record) => {
                setReportData(record);
                setShowReportModal(true);
            };

            // Stats
            const stats = useMemo(() => {
                const totalShops = shops.length;
                const inspectedShopIds = new Set(inspectionRecords.map(r => r.shopId));
                const inspectedCount = inspectedShopIds.size;
                const passCount = inspectionRecords.filter(r => r.status === 'pass').length;
                const warnCount = inspectionRecords.filter(r => r.status === 'warn').length;
                const failCount = inspectionRecords.filter(r => r.status === 'fail').length;

                const districtStats = districts.map(district => {
                    const shopsInDistrict = shops.filter(s => s.district === district);
                    const recordsInDistrict = inspectionRecords.filter(r => r.district === district);
                    const inspectedInDistrict = new Set(recordsInDistrict.map(r => r.shopId)).size;
                    
                    return {
                        name: district,
                        total: shopsInDistrict.length,
                        inspected: inspectedInDistrict,
                        pass: recordsInDistrict.filter(r => r.status === 'pass').length,
                        warn: recordsInDistrict.filter(r => r.status === 'warn').length,
                        fail: recordsInDistrict.filter(r => r.status === 'fail').length,
                    };
                });

                return { totalShops, inspectedCount, passCount, warnCount, failCount, districtStats };
            }, [shops, inspectionRecords, districts]);

            // Map URL
            let mapCenterShop = null;
            if (activeTab === 'search') mapCenterShop = selectedShop;
            else if (activeTab === 'route') mapCenterShop = routeList.length > 0 ? routeList[routeList.length - 1] : null;
            else if (activeTab === 'inspection') mapCenterShop = inspectSelectedShop;

            const getMapEmbedUrl = (lat, lng) => {
                const diff = 0.005; 
                return `https://www.openstreetmap.org/export/embed.html?bbox=${lng-diff},${lat-diff},${lng+diff},${lat+diff}&layer=mapnik&marker=${lat},${lng}`;
            };

            const handlePrint = () => {
                window.print();
            };

            return (
                <div className="min-h-screen flex flex-col pb-20 lg:pb-0">
                
                    {/* Header */}
                    <header className="bg-green-600 text-white p-4 shadow-lg sticky top-0 z-50 no-print">
                        <div className="container mx-auto flex items-center justify-between">
                            <div className="flex items-center gap-2">
                                <Store className="h-9 w-9" />
                                <div>
                                    <div className="flex items-center gap-2">
                                        <h1 className="text-xl font-bold">Smart Cannabis Check</h1>
                                        <span className="bg-green-700 text-green-100 text-[10px] px-2 py-0.5 rounded-full font-medium shadow-sm border border-green-500">v1.0 (Beta)</span>
                                    </div>
                                    <p className="text-xs text-green-100">ระบบตรวจสอบร้านกัญชา สมุทรปราการ</p>
                                    <p className="text-[10px] text-green-200 mt-0.5 opacity-90">ผู้จัดทำ: Jeerapat</p>
                                </div>
                            </div>
                        </div>
                    </header>

                    <main className="flex-grow container mx-auto p-4 flex flex-col lg:flex-row gap-6 no-print">
                        
                        {/* Left Column */}
                        <div className="w-full lg:w-1/3 flex flex-col gap-4 order-2 lg:order-1">
                            
                            {/* Import Card */}
                            <div className={`p-3 rounded-xl border flex items-center justify-between ${isDataLoaded ? 'bg-green-50 border-green-200' : 'bg-blue-50 border-blue-100'}`}>
                                <div className="flex items-center gap-2">
                                    <FileText className={`h-4 w-4 ${isDataLoaded ? 'text-green-600' : 'text-blue-600'}`} />
                                    <div>
                                        <span className="text-xs font-bold block">{isDataLoaded ? 'ฐานข้อมูลพร้อม' : 'ข้อมูลตัวอย่าง'}</span>
                                        <span className="text-[10px] text-gray-500">{shops.length} ร้านค้า</span>
                                    </div>
                                </div>
                                <input type="file" accept=".csv" ref={fileInputRef} onChange={handleFileUpload} className="hidden" />
                                <button onClick={() => fileInputRef.current.click()} className="bg-white hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg text-xs border shadow-sm flex items-center gap-1">
                                    <Upload className="h-3 w-3" /> นำเข้า
                                </button>
                            </div>

                            {/* Tabs */}
                            <div className="hidden lg:flex bg-gray-200 p-1 rounded-xl">
                                {['dashboard', 'search', 'route', 'inspection'].map(tab => (
                                    <button key={tab} onClick={() => setActiveTab(tab)} className={`flex-1 py-2 text-xs font-bold rounded-lg gap-1 transition-all flex flex-col items-center ${activeTab === tab ? 'bg-white text-green-700 shadow-sm' : 'text-gray-500'}`}>
                                        {tab === 'dashboard' && <LayoutDashboard className="h-4 w-4" />}
                                        {tab === 'search' && <Search className="h-4 w-4" />}
                                        {tab === 'route' && <MapIcon className="h-4 w-4" />}
                                        {tab === 'inspection' && <ClipboardList className="h-4 w-4" />}
                                        {tab === 'dashboard' ? 'ภาพรวม' : tab === 'search' ? 'ค้นหา' : tab === 'route' ? 'วางแผน' : 'ตรวจ'}
                                    </button>
                                ))}
                            </div>

                            {/* DASHBOARD */}
                            {activeTab === 'dashboard' && (
                                <div className="animate-fade-in space-y-4">
                                    <div className="grid grid-cols-2 gap-3">
                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                                            <span className="text-3xl font-bold text-gray-800">{stats.totalShops}</span>
                                            <span className="text-xs text-gray-500 block">ร้านทั้งหมด</span>
                                        </div>
                                        <div className="bg-white p-4 rounded-xl shadow-sm border border-gray-100 text-center">
                                            <span className="text-3xl font-bold text-blue-600">{stats.inspectedCount}</span>
                                            <span className="text-xs text-gray-500 block">ตรวจแล้ว</span>
                                        </div>
                                    </div>

                                    <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100 overflow-hidden">
                                        <h3 className="text-sm font-bold text-gray-700 mb-3 border-b pb-2 flex items-center gap-2">
                                            <LayoutDashboard className="h-4 w-4"/> ฐานข้อมูลร้านค้าแยกรายอำเภอ
                                        </h3>
                                        <div className="space-y-3">
                                            {stats.districtStats.map((d) => {
                                                const percentage = stats.totalShops > 0 ? (d.total / stats.totalShops) * 100 : 0;
                                                return (
                                                    <div key={d.name} className="text-xs">
                                                        <div className="flex justify-between mb-1">
                                                            <span className="font-medium text-gray-700">{d.name}</span>
                                                            <span className="text-gray-500">{d.total} ร้าน</span>
                                                        </div>
                                                        <div className="w-full bg-gray-100 rounded-full h-2.5">
                                                            <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${percentage}%` }}></div>
                                                        </div>
                                                        <div className="flex justify-end gap-2 mt-1 text-[10px] text-gray-400">
                                                            <span>ตรวจแล้ว {d.inspected}</span>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                    </div>

                                    <div className="bg-white p-4 rounded-xl shadow-md border border-gray-100">
                                        <h3 className="text-sm font-bold text-gray-700 mb-2">ประวัติการตรวจล่าสุด</h3>
                                        <div className="space-y-2 max-h-[200px] overflow-y-auto custom-scrollbar">
                                            {inspectionRecords.length === 0 ? (
                                                <p className="text-xs text-gray-400 text-center py-4">ยังไม่มีข้อมูลการตรวจ</p>
                                            ) : (
                                                inspectionRecords.slice(0, 5).map(r => (
                                                    <div key={r.id} className="text-xs border-b border-gray-100 pb-2 mb-2 flex justify-between items-center group">
                                                        <div>
                                                            <div className="flex gap-2 font-bold text-gray-700">
                                                                <span>{r.shopName}</span>
                                                            </div>
                                                            <div className="text-gray-500 mt-1">
                                                                <span>{r.date} โดย {r.inspector}</span>
                                                            </div>
                                                        </div>
                                                        <button onClick={() => openReport(r)} className="text-blue-600 bg-blue-50 p-1.5 rounded hover:bg-blue-100 transition-colors">
                                                            <Printer className="h-4 w-4" />
                                                        </button>
                                                    </div>
                                                ))
                                            )}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {/* SEARCH */}
                            {activeTab === 'search' && (
                                <div className="animate-fade-in space-y-4">
                                    <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                                        <h2 className="text-md font-semibold mb-4 text-green-800">ค้นหาข้อมูลร้านค้า</h2>
                                        <div className="mb-3">
                                            <label className="text-xs font-semibold text-gray-500 uppercase">อำเภอ</label>
                                            <select value={selectedDistrict} onChange={(e) => { setSelectedDistrict(e.target.value); setSelectedShopId(''); }} className="w-full mt-1 p-3 border rounded-lg text-sm">
                                                <option value="">-- เลือกอำเภอ --</option>
                                                {districts.map(d => <option key={d} value={d}>{d}</option>)}
                                            </select>
                                        </div>
                                        <div>
                                            <label className="text-xs font-semibold text-gray-500 uppercase">ร้านค้า</label>
                                            <select value={selectedShopId} onChange={(e) => setSelectedShopId(e.target.value)} disabled={!selectedDistrict} className="w-full mt-1 p-3 border rounded-lg text-sm disabled:bg-gray-100">
                                                <option value="">-- เลือกร้านค้า ({filteredShops.length}) --</option>
                                                {filteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}
                                            </select>
                                        </div>
                                    </div>
                                    {selectedShop && (
                                        <div className="bg-white p-5 rounded-xl shadow-md border-l-4 border-green-500">
                                            <h3 className="text-lg font-bold text-gray-800">{selectedShop.name}</h3>
                                            <div className="text-sm text-gray-600 mt-3 space-y-2">
                                                <p>{selectedShop.address} {selectedShop.subDistrict} {selectedShop.district}</p>
                                                <div className="flex items-center gap-2"><Phone className="h-4 w-4 text-green-600" /> {selectedShop.phone}</div>
                                                <div className="flex items-center gap-2"><Info className="h-4 w-4 text-green-600" /> {selectedShop.license}</div>
                                            </div>
                                        </div>
                                    )}
                                </div>
                            )}

                            {/* ROUTE */}
                            {activeTab === 'route' && (
                                <div className="animate-fade-in space-y-4">
                                    <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                                        <h2 className="text-md font-semibold mb-4 text-blue-800">เพิ่มจุดแวะพัก</h2>
                                        <div className="flex flex-col gap-3">
                                            <select value={routeDistrict} onChange={(e) => { setRouteDistrict(e.target.value); setRouteShopId(''); }} className="w-full p-3 border rounded-lg text-sm"><option value="">เลือกอำเภอ</option>{districts.map(d => <option key={d} value={d}>{d}</option>)}</select>
                                            <select value={routeShopId} onChange={(e) => setRouteShopId(e.target.value)} disabled={!routeDistrict} className="w-full p-3 border rounded-lg text-sm disabled:bg-gray-100"><option value="">เลือกร้าน</option>{routeFilteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                                            <button onClick={addToRoute} disabled={!routeShopId} className="w-full bg-blue-600 text-white py-3 rounded-lg flex items-center justify-center gap-2 text-sm font-medium"><Plus className="h-4 w-4" /> เพิ่ม</button>
                                        </div>
                                    </div>
                                    <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                                        <div className="flex justify-between mb-3"><h2 className="text-md font-semibold">รายการ ({routeList.length})</h2>{routeList.length > 0 && <button onClick={() => setRouteList([])} className="text-xs text-red-500">ล้าง</button>}</div>
                                        <div className="space-y-2 max-h-[200px] overflow-y-auto">{routeList.map((shop, i) => (<div key={i} className="flex justify-between bg-blue-50 p-2 rounded text-sm"><span>{i+1}. {shop.name}</span><button onClick={() => setRouteList(routeList.filter(item => item.id !== shop.id))}><Trash2 className="h-3 w-3 text-red-500"/></button></div>))}</div>
                                        <button onClick={() => window.open(`https://www.google.com/maps/dir/${routeList.map(s => `${s.coords[0]},${s.coords[1]}`).join('/')}`, '_blank')} disabled={!routeList.length} className="mt-4 w-full bg-indigo-600 text-white py-3 rounded-lg text-sm font-bold flex justify-center gap-2"><Navigation className="h-4 w-4"/> นำทาง</button>
                                    </div>
                                </div>
                            )}

                            {/* INSPECTION */}
                            {activeTab === 'inspection' && (
                                <div className="animate-fade-in space-y-4">
                                    <div className="bg-white p-5 rounded-xl shadow-md border border-gray-100">
                                        <h2 className="text-md font-semibold mb-4 text-orange-800 flex items-center gap-2"><ClipboardList className="h-5 w-5" /> บันทึกผลการตรวจ</h2>
                                        
                                        <div className="grid grid-cols-2 gap-2 mb-4">
                                            <select value={inspectDistrict} onChange={(e) => { setInspectDistrict(e.target.value); setInspectShopId(''); }} className="p-2 border rounded text-sm"><option value="">เลือกอำเภอ</option>{districts.map(d => <option key={d} value={d}>{d}</option>)}</select>
                                            <select value={inspectShopId} onChange={(e) => setInspectShopId(e.target.value)} disabled={!inspectDistrict} className="p-2 border rounded text-sm"><option value="">เลือกร้าน</option>{inspectFilteredShops.map(s => <option key={s.id} value={s.id}>{s.name}</option>)}</select>
                                        </div>

                                        <div className="bg-orange-50 p-3 rounded-lg border border-orange-100 mb-4 space-y-3">
                                            <h3 className="text-xs font-bold text-orange-800 uppercase">ข้อมูลผู้ตรวจ</h3>
                                            <div className="grid grid-cols-2 gap-3">
                                                <div>
                                                    <label className="text-xs text-gray-500 block mb-1">ชื่อผู้ตรวจ</label>
                                                    <input type="text" value={inspectorName} onChange={(e) => setInspectorName(e.target.value)} placeholder="ระบุชื่อ" className="w-full p-2 border rounded text-sm bg-white" />
                                                </div>
                                                <div>
                                                    <label className="text-xs text-gray-500 block mb-1">ตำแหน่ง</label>
                                                    <input type="text" value={inspectorPosition} onChange={(e) => setInspectorPosition(e.target.value)} placeholder="ระบุตำแหน่ง" className="w-full p-2 border rounded text-sm bg-white" />
                                                </div>
                                            </div>
                                            <div>
                                                <label className="text-xs text-gray-500 block mb-1">วันที่ตรวจ</label>
                                                <input type="date" value={formDate} onChange={(e) => setFormDate(e.target.value)} className="w-full p-2 border rounded text-sm bg-white" />
                                            </div>
                                        </div>

                                        <div className="space-y-2 mb-4">
                                            <div className="border rounded p-2">
                                                <div className="text-xs font-bold mb-2">ส่วนที่ 1: ลักษณะร้าน</div>
                                                <div className="space-y-1">
                                                    {[{id:'item1',l:'1. ป้ายชัดเจน'},{id:'item2',l:'2. มีเคาท์เตอร์'},{id:'item3',l:'3. แยกสัดส่วน'},{id:'item4',l:'4. ถูกสุขลักษณะ'},{id:'item5',l:'5. ป้ายเตือน'}].map(i=>(
                                                        <div key={i.id} className="flex justify-between text-xs"><span className="text-gray-600">{i.l}</span><input type="checkbox" checked={checklist[i.id]==='have'} onChange={()=>setChecklist({...checklist, [i.id]: checklist[i.id]==='have'?'not_have':'have'})} className="accent-green-600"/></div>
                                                    ))}
                                                </div>
                                            </div>
                                            <div className="border rounded p-2 bg-blue-50">
                                                <div className="text-xs font-bold mb-2">ส่วนที่ 2: การปฏิบัติ (ติ๊กหากพบ/ทำ)</div>
                                                <div className="space-y-1">
                                                    {[{id:'item1',l:'1. มีใบอนุญาต (ต้องมี)'},{id:'item2',l:'2. ข้อมูลแหล่งที่มา (ต้องมี)'},{id:'item3',l:'3. ขายเด็กต่ำกว่า 20 (ห้าม)'},{id:'item4',l:'4. ให้สูบในร้าน (ห้าม)'}].map(i=>(
                                                        <div key={i.id} className="flex justify-between text-xs"><span className="text-gray-600">{i.l}</span><input type="checkbox" checked={checklistPart2[i.id]==='found'} onChange={()=>setChecklistPart2({...checklistPart2, [i.id]: checklistPart2[i.id]==='found'?'not_found':'found'})} className="accent-blue-600"/></div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>

                                        <div className="grid grid-cols-3 gap-2 mb-3">
                                            {['pass', 'warn', 'fail'].map(s => (
                                                <label key={s} className={`p-2 rounded border text-center text-xs font-bold cursor-pointer ${formStatus===s ? (s==='pass'?'bg-green-100 border-green-500 text-green-700':s==='warn'?'bg-yellow-100 border-yellow-500 text-yellow-700':'bg-red-100 border-red-500 text-red-700') : 'bg-gray-50'}`}>
                                                    <input type="radio" name="status" value={s} checked={formStatus===s} onChange={(e)=>setFormStatus(e.target.value)} className="hidden"/>{s==='pass'?'ผ่าน':s==='warn'?'ตักเตือน':'ไม่ผ่าน'}
                                                </label>
                                            ))}
                                        </div>

                                        <button onClick={saveInspection} disabled={!inspectShopId} className="w-full bg-orange-600 text-white py-3 rounded-lg font-bold shadow-md hover:bg-orange-700">บันทึกผล</button>
                                        
                                        {inspectShopId && currentShopHistory.length > 0 && (
                                            <div className="mt-6 border-t pt-4">
                                            <h3 className="text-sm font-bold text-gray-700 mb-3">ประวัติการตรวจร้านนี้ ({currentShopHistory.length})</h3>
                                            <div className="space-y-2">
                                                {currentShopHistory.map(r => (
                                                <div key={r.id} className="bg-gray-50 p-3 rounded-lg border flex justify-between items-center text-xs">
                                                    <div>
                                                        <div className="font-bold">{r.date}</div>
                                                        <div className={`mt-0.5 ${r.status==='pass'?'text-green-600':r.status==='warn'?'text-yellow-600':'text-red-600'}`}>
                                                            ผล: {r.status==='pass'?'ผ่าน':r.status==='warn'?'ตักเตือน':'ไม่ผ่าน'} (โดย {r.inspector})
                                                        </div>
                                                    </div>
                                                    <button onClick={() => openReport(r)} className="bg-white border p-1.5 rounded hover:bg-gray-100 text-blue-600 flex items-center gap-1">
                                                        <Printer className="h-4 w-4"/> พิมพ์
                                                    </button>
                                                </div>
                                                ))}
                                            </div>
                                            </div>
                                        )}
                                    </div>
                                </div>
                            )}
                        </div>

                        {/* Right Column: Map */}
                        <div className="w-full lg:w-2/3 h-[400px] lg:h-auto min-h-[500px] bg-gray-200 rounded-xl overflow-hidden shadow-inner border border-gray-300 relative z-0 flex flex-col order-1 lg:order-2 no-print">
                            <iframe width="100%" height="100%" frameBorder="0" src={mapCenterShop ? getMapEmbedUrl(mapCenterShop.coords[0], mapCenterShop.coords[1]) : `https://www.openstreetmap.org/export/embed.html?bbox=100.5,13.5,100.7,13.7&layer=mapnik`} className="flex-grow"></iframe>
                        </div>

                        {/* Mobile Nav */}
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-2 flex lg:hidden justify-around z-[100] pb-safe no-print">
                            {['dashboard','search','route','inspection'].map(t => <button key={t} onClick={()=>setActiveTab(t)} className={`flex flex-col items-center p-2 ${activeTab===t?'text-green-600':'text-gray-400'}`}>
                                {t==='dashboard'?<LayoutDashboard/>:t==='search'?<Search/>:t==='route'?<MapIcon/>:<ClipboardList/>}
                                <span className="text-[10px]">{t}</span>
                            </button>)}
                        </div>
                    </main>

                    {/* REPORT MODAL */}
                    {showReportModal && reportData && (
                        <div className="fixed inset-0 bg-black/50 z-[9999] flex items-center justify-center p-4">
                            <div className="bg-white rounded-lg shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto relative flex flex-col">
                                <div className="p-4 border-b flex justify-between items-center bg-gray-50 no-print rounded-t-lg sticky top-0">
                                    <h2 className="font-bold text-gray-800 flex items-center gap-2"><FileText className="h-5 w-5"/> ตัวอย่างรายงานผลการตรวจ</h2>
                                    <div className="flex gap-2">
                                        <button onClick={handlePrint} className="bg-blue-600 text-white px-4 py-2 rounded-lg text-sm font-bold flex items-center gap-2 hover:bg-blue-700">
                                            <Printer className="h-4 w-4"/> พิมพ์ / บันทึก PDF
                                        </button>
                                        <button onClick={() => setShowReportModal(false)} className="bg-gray-200 text-gray-700 px-3 py-2 rounded-lg hover:bg-gray-300">
                                            <X className="h-5 w-5"/>
                                        </button>
                                    </div>
                                </div>
                                <div id="printable-report" className="p-8 bg-white text-black font-serif">
                                    <div className="text-center border-b-2 border-black pb-4 mb-6">
                                        <h1 className="text-2xl font-bold mb-1">แบบบันทึกผลการตรวจสอบร้านกัญชา</h1>
                                        <p className="text-lg">สำนักงานสาธารณสุขจังหวัดสมุทรปราการ</p>
                                    </div>
                                    <div className="mb-6 grid grid-cols-2 gap-4 text-sm">
                                        <div>
                                            <p><span className="font-bold">ชื่อสถานประกอบการ:</span> {reportData.shopName}</p>
                                            <p><span className="font-bold">เลขที่ใบอนุญาต:</span> {reportData.license || '-'}</p>
                                            <p><span className="font-bold">ที่อยู่:</span> {reportData.address}, {reportData.subDistrict}, {reportData.district}, {reportData.province}</p>
                                        </div>
                                        <div className="text-right">
                                            <p><span className="font-bold">วันที่ตรวจ:</span> {reportData.date}</p>
                                            <p><span className="font-bold">รหัสอ้างอิง:</span> {reportData.id}</p>
                                        </div>
                                    </div>
                                    <div className="mb-6 bg-gray-50 p-3 border border-gray-200 text-sm">
                                        <p><span className="font-bold">ผู้ตรวจสอบ:</span> {reportData.inspector} <span className="mx-2">|</span> <span className="font-bold">ตำแหน่ง:</span> {reportData.position}</p>
                                    </div>
                                    <div className="mb-6">
                                        <h3 className="font-bold text-lg mb-2 border-b">1. ลักษณะสถานประกอบการ</h3>
                                        <table className="w-full text-sm mb-4 border-collapse border border-gray-300">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="border p-2 text-left">หัวข้อตรวจสอบ</th>
                                                    <th className="border p-2 text-center w-24">ผล</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[{id:'item1',l:'1. ป้ายสถานประกอบการชัดเจน'},{id:'item2',l:'2. มีเคาท์เตอร์และที่พักคอย'},{id:'item3',l:'3. มีการแยกสัดส่วนชัดเจน'},{id:'item4',l:'4. พื้นที่/อุปกรณ์ ถูกสุขลักษณะ'},{id:'item5',l:'5. มีป้ายแสดงข้อความเตือน'}].map(i => (
                                                    <tr key={i.id}>
                                                        <td className="border p-2">{i.l}</td>
                                                        <td className="border p-2 text-center">
                                                            {reportData.checklist[i.id] === 'have' ? <span className="text-green-600 font-bold">✓ มี</span> : <span className="text-red-600">✗ ไม่มี</span>}
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>

                                        <h3 className="font-bold text-lg mb-2 border-b">2. การปฏิบัติการตามเงื่อนไข</h3>
                                        <table className="w-full text-sm border-collapse border border-gray-300">
                                            <thead>
                                                <tr className="bg-gray-100">
                                                    <th className="border p-2 text-left">หัวข้อตรวจสอบ</th>
                                                    <th className="border p-2 text-center w-24">ผล</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {[{id:'item1',l:'1. แสดงใบอนุญาตด้านหน้าชัดเจน (ต้องพบ)'},{id:'item2',l:'2. จัดทำข้อมูลแหล่งที่มา (ต้องพบ)'},{id:'item3',l:'3. จำหน่ายให้อายุต่ำกว่า 20 ปี (ห้ามพบ)'},{id:'item4',l:'4. ให้สูบในสถานประกอบการ (ห้ามพบ)'}].map(i => {
                                                    const isPass = ['item1', 'item2'].includes(i.id) 
                                                        ? reportData.checklistPart2[i.id] === 'found'
                                                        : reportData.checklistPart2[i.id] === 'not_found';
                                                    const valText = reportData.checklistPart2[i.id] === 'found' ? 'พบ' : 'ไม่พบ';
                                                    return (
                                                    <tr key={i.id}>
                                                        <td className="border p-2">{i.l}</td>
                                                        <td className="border p-2 text-center">
                                                            {isPass ? <span className="text-green-600 font-bold">✓ ผ่าน</span> : <span className="text-red-600 font-bold">✗ ไม่ผ่าน</span>}
                                                            <span className="text-xs text-gray-500 block">({valText})</span>
                                                        </td>
                                                    </tr>
                                                    )
                                                })}
                                            </tbody>
                                        </table>
                                    </div>

                                    <div className={`p-4 border-2 rounded-lg mb-6 text-center ${
                                        reportData.status === 'pass' ? 'border-green-500 bg-green-50' : 
                                        reportData.status === 'warn' ? 'border-yellow-500 bg-yellow-50' : 'border-red-500 bg-red-50'
                                    }`}>
                                        <h2 className="text-xl font-bold">ผลการประเมินสรุป: 
                                            <span className={`ml-2 ${
                                                reportData.status === 'pass' ? 'text-green-700' : 
                                                reportData.status === 'warn' ? 'text-yellow-700' : 'text-red-700'
                                            }`}>
                                                {reportData.status === 'pass' ? 'ผ่านเกณฑ์' : reportData.status === 'warn' ? 'ตักเตือน' : 'ไม่ผ่านเกณฑ์'}
                                            </span>
                                        </h2>
                                    </div>

                                    {reportData.note && (
                                        <div className="mb-8 border p-3 rounded bg-gray-50 text-sm">
                                            <p className="font-bold mb-1">หมายเหตุ / ข้อแนะนำเพิ่มเติม:</p>
                                            <p>{reportData.note}</p>
                                        </div>
                                    )}

                                    <div className="grid grid-cols-2 gap-8 mt-12 pt-8">
                                        <div className="text-center">
                                            <div className="border-b border-black mb-2 h-8"></div>
                                            <p>( {reportData.shopName} )</p>
                                            <p className="text-sm">ผู้รับการตรวจ / ผู้ประกอบการ</p>
                                        </div>
                                        <div className="text-center">
                                            <div className="border-b border-black mb-2 h-8"></div>
                                            <p>( {reportData.inspector} )</p>
                                            <p className="text-sm">{reportData.position || 'เจ้าหน้าที่ผู้ตรวจ'}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ShopFinderApp />);
    </script>
</body>
</html>